<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BULLBOARD — Practice Tracker</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0a0a;
    --surface: #111111;
    --surface2: #1a1a1a;
    --border: #2a2a2a;
    --accent: #e8ff3a;
    --accent2: #ff4d4d;
    --accent3: #3affb8;
    --accent4: #a78bfa;
    --text: #f0f0f0;
    --muted: #666;
    --dim: #333;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    background: var(--bg);
    z-index: 200;
    gap: 12px;
    flex-wrap: wrap;
  }

  .logo {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 26px;
    letter-spacing: 4px;
    color: var(--accent);
    flex-shrink: 0;
  }
  .logo span { color: var(--muted); font-size: 13px; letter-spacing: 2px; margin-left: 10px; font-family: 'DM Mono', monospace; }

  /* Hamburger */
  .hamburger {
    display: none;
    flex-direction: column;
    gap: 5px;
    cursor: pointer;
    padding: 6px;
    background: none;
    border: 1px solid var(--border);
    margin-left: auto;
  }
  .hamburger span { display: block; width: 22px; height: 2px; background: var(--muted); transition: all 0.2s; }
  .hamburger.open span:nth-child(1) { transform: translateY(7px) rotate(45deg); background: var(--accent); }
  .hamburger.open span:nth-child(2) { opacity: 0; }
  .hamburger.open span:nth-child(3) { transform: translateY(-7px) rotate(-45deg); background: var(--accent); }

  nav {
    display: flex;
    gap: 4px;
    flex-wrap: wrap;
  }
  nav button {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 7px 14px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: all 0.15s;
    text-transform: uppercase;
    white-space: nowrap;
  }
  nav button.active, nav button:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(232,255,58,0.05);
  }

  /* Auth in header */
  #auth-container { flex-shrink: 0; }

  .page { display: none; padding: 32px; max-width: 1280px; margin: 0 auto; }
  .page.active { display: block; }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 24px;
  }

  .panel-title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 18px;
    letter-spacing: 3px;
    color: var(--muted);
    margin-bottom: 20px;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .panel-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }


  /* ── SCOREBOARD ── */
  .score-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 96px;
    line-height: 1;
    color: var(--accent);
    text-align: center;
    padding: 20px 0;
    text-shadow: 0 0 60px rgba(232,255,58,0.2);
    transition: color 0.2s;
  }

  .score-meta {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1px;
    background: var(--border);
    margin-bottom: 20px;
  }
  .score-meta > div { background: var(--surface); padding: 14px; text-align: center; }
  .score-meta label {
    display: block;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    letter-spacing: 1px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .score-meta .val { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--text); }

  /* ── INPUT + NUMPAD ── */
  .input-row {
    display: flex;
    gap: 8px;
    margin-bottom: 8px;
    align-items: stretch;
  }
  .input-display {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 16px 20px;
    font-family: 'DM Mono', monospace;
    font-size: 32px;
    text-align: right;
    color: var(--text);
    min-height: 64px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    transition: border-color 0.2s;
  }
  .input-display.voice-active { border-color: var(--accent2); }
  .input-display .cursor {
    width: 2px; height: 36px;
    background: var(--accent);
    margin-left: 4px;
    animation: blink 1s infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

  /* ── VOICE TRANSCRIPT DISPLAY ── */
  .voice-transcript {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--muted);
    min-height: 18px;
    margin-bottom: 6px;
    letter-spacing: 0.5px;
    text-align: right;
    transition: color 0.2s;
    padding: 0 2px;
  }
  .voice-transcript.heard { color: var(--accent2); }
  .voice-transcript.parsed { color: var(--accent3); }

  .numpad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px; }
  .numpad button {
    background: var(--surface2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px;
    padding: 18px;
    cursor: pointer;
    transition: all 0.1s;
    letter-spacing: 1px;
  }
  .numpad button:hover { background: var(--dim); border-color: var(--muted); }
  .numpad button:active { transform: scale(0.96); }
  .numpad button.zero { grid-column: span 2; }
  .numpad button.del { color: var(--accent2); border-color: #2a1a1a; }

  .btn-submit {
    width: 100%;
    background: var(--accent);
    color: #000;
    border: none;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 22px;
    letter-spacing: 3px;
    padding: 18px;
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: 8px;
  }
  .btn-submit:hover { background: #d4e82a; transform: translateY(-1px); }

  .btn-bust {
    width: 100%;
    background: none;
    color: var(--accent2);
    border: 1px solid var(--accent2);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 2px;
    padding: 10px;
    cursor: pointer;
    transition: all 0.15s;
    margin-bottom: 16px;
  }
  .btn-bust:hover { background: rgba(255,77,77,0.1); }

  /* ── THROW HISTORY ── */
  .throw-history { display: flex; flex-direction: column; gap: 6px; max-height: 220px; overflow-y: auto; }
  .throw-history::-webkit-scrollbar { width: 4px; }
  .throw-history::-webkit-scrollbar-thumb { background: var(--dim); }

  .throw-row {
    display: flex; align-items: center;
    padding: 10px 14px;
    background: var(--surface2);
    border-left: 2px solid var(--dim);
    font-family: 'DM Mono', monospace;
    font-size: 13px; gap: 12px;
    animation: slideIn 0.2s ease;
  }
  @keyframes slideIn { from { opacity:0; transform: translateX(-10px); } to { opacity:1; transform: none; } }
  .throw-row.bust { border-left-color: var(--accent2); }
  .throw-row.checkout { border-left-color: var(--accent3); }
  .throw-num { color: var(--muted); width: 24px; }
  .throw-score { color: var(--text); font-size: 18px; font-weight: 500; flex: 1; }
  .throw-remaining { color: var(--muted); }
  .throw-badge { font-size: 10px; padding: 2px 7px; letter-spacing: 1px; font-family: 'DM Mono', monospace; }
  .throw-badge.bust { background: rgba(255,77,77,0.15); color: var(--accent2); border: 1px solid rgba(255,77,77,0.3); }
  .throw-badge.checkout { background: rgba(58,255,184,0.15); color: var(--accent3); border: 1px solid rgba(58,255,184,0.3); }
  .throw-badge.ton { background: rgba(232,255,58,0.15); color: var(--accent); border: 1px solid rgba(232,255,58,0.3); }
  .throw-badge.voice { background: rgba(255,77,77,0.1); color: var(--accent2); border: 1px solid rgba(255,77,77,0.2); font-size:9px; }
  .throw-edit-btn {
    margin-left: auto; background: none; border: 1px solid transparent;
    color: var(--dim); font-family: 'DM Mono', monospace; font-size: 10px;
    padding: 2px 7px; cursor: pointer; letter-spacing: 0.5px; opacity: 0;
    transition: opacity 0.15s, border-color 0.15s, color 0.15s;
  }
  .throw-row:hover .throw-edit-btn { opacity: 1; }
  .throw-edit-btn:hover { border-color: var(--accent); color: var(--accent); }
  /* Edit confirm modal */
  .edit-confirm-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    display: flex; align-items: center; justify-content: center;
    z-index: 200;
  }
  .edit-confirm-box {
    background: var(--surface); border: 1px solid var(--border);
    padding: 24px 28px; min-width: 300px; max-width: 380px; width: 90%;
  }
  .edit-confirm-title {
    font-family: 'Bebas Neue', sans-serif; font-size: 20px;
    letter-spacing: 2px; color: var(--text); margin-bottom: 6px;
  }
  .edit-confirm-sub {
    font-family: 'DM Mono', monospace; font-size: 11px;
    color: var(--muted); margin-bottom: 18px; line-height: 1.5;
  }
  .edit-confirm-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: 'Bebas Neue', sans-serif; font-size: 36px;
    text-align: center; padding: 12px; letter-spacing: 2px; outline: none;
    margin-bottom: 14px; box-sizing: border-box;
  }
  .edit-confirm-input:focus { border-color: var(--accent); }
  .edit-confirm-row { display: flex; gap: 8px; }
  .edit-confirm-btn {
    flex: 1; padding: 12px; font-family: 'Bebas Neue', sans-serif;
    font-size: 16px; letter-spacing: 2px; border: none; cursor: pointer;
  }
  .edit-confirm-btn.cancel { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }
  .edit-confirm-btn.cancel:hover { color: var(--text); }
  .edit-confirm-btn.confirm { background: var(--accent); color: #000; }
  .edit-confirm-btn.confirm:hover { opacity: 0.85; }

  /* ── SESSION SETUP ── */
  .session-setup { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
  .setup-select {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 10px 16px;
    font-family: 'DM Mono', monospace; font-size: 13px;
    cursor: pointer; flex: 1; min-width: 120px;
  }
  .setup-select:focus { outline: 1px solid var(--accent); }

  .btn-new-leg {
    background: none; border: 1px solid var(--accent3); color: var(--accent3);
    padding: 10px 20px; font-family: 'DM Mono', monospace; font-size: 12px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.15s; text-transform: uppercase;
  }
  .btn-new-leg:hover { background: rgba(58,255,184,0.08); }

  /* ── DRILL PAGE LAYOUT ── */
  .drill-page-grid {
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  .drill-controls-row {
    display: grid;
    grid-template-columns: 220px 220px 1fr 1fr 1fr;
    gap: 16px;
    align-items: start;
  }
  .drill-controls-row .drill-section { }
  .drill-bottom-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
  }

  /* ── DRILL TRACKER ── */
  .dsec {
    font-family: 'DM Mono', monospace;
    font-size: 10px; color: var(--muted);
    letter-spacing: 2px; text-transform: uppercase;
    margin-bottom: 7px; margin-top: 14px;
  }
  .dsec:first-child { margin-top: 0; }

  .toggle-group { display: grid; gap: 4px; }
  .toggle-group.g3 { grid-template-columns: repeat(3,1fr); }
  .toggle-group.g2 { grid-template-columns: repeat(2,1fr); }

  .toggle-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 9px 6px;
    font-family: 'DM Mono', monospace; font-size: 11px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.12s;
    text-align: center; text-transform: uppercase;
  }
  .toggle-btn:hover { border-color: var(--muted); color: var(--text); }
  .toggle-btn.sel-single { border-color: var(--text); color: var(--text); background: rgba(240,240,240,0.06); }
  .toggle-btn.sel-double { border-color: var(--accent3); color: var(--accent3); background: rgba(58,255,184,0.06); }
  .toggle-btn.sel-treble { border-color: var(--accent4); color: var(--accent4); background: rgba(167,139,250,0.06); }
  .toggle-btn.sel-darts { border-color: var(--accent); color: var(--accent); background: rgba(232,255,58,0.06); }

  .target-grid { display: grid; grid-template-columns: repeat(7,1fr); gap: 4px; margin-bottom: 4px; }
  .target-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 8px 4px;
    font-family: 'DM Mono', monospace; font-size: 11px;
    cursor: pointer; transition: all 0.1s; text-align: center;
  }
  .target-btn.selected { border-color: var(--accent); color: var(--accent); background: rgba(232,255,58,0.08); }
  .target-btn:hover { border-color: var(--muted); color: var(--text); }

  .attempt-label {
    font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--muted); letter-spacing: 1px;
    text-align: center; margin: 8px 0 6px;
  }
  .attempt-progress { display: flex; gap: 6px; justify-content: center; margin-bottom: 10px; }
  .attempt-dot {
    width: 11px; height: 11px; border-radius: 50%;
    border: 1px solid var(--dim); background: var(--surface2);
    transition: all 0.15s;
  }
  .attempt-dot.done-hit { background: var(--accent3); border-color: var(--accent3); box-shadow: 0 0 6px rgba(58,255,184,0.5); }
  .attempt-dot.done-miss { background: var(--accent2); border-color: var(--accent2); box-shadow: 0 0 5px rgba(255,77,77,0.4); }
  .attempt-dot.current { border-color: var(--accent); animation: dpulse 1s infinite; }
  @keyframes dpulse { 0%,100%{box-shadow:0 0 0 0 rgba(232,255,58,0.4)} 50%{box-shadow:0 0 0 4px rgba(232,255,58,0)} }

  .miss-grid { display: grid; grid-template-columns: repeat(4,1fr); gap: 4px; margin-bottom: 12px; }
  .miss-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 8px;
    font-family: 'DM Mono', monospace; font-size: 10px;
    cursor: pointer; text-transform: uppercase;
    text-align: center; transition: all 0.1s; letter-spacing: 1px;
  }
  .miss-btn.selected { border-color: var(--accent2); color: var(--accent2); background: rgba(255,77,77,0.08); }
  .miss-btn:hover { border-color: var(--muted); }

  .drill-action-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
  .drill-hit {
    background: rgba(58,255,184,0.08); border: 1px solid var(--accent3); color: var(--accent3);
    padding: 16px; font-family: 'Bebas Neue', sans-serif; font-size: 20px;
    letter-spacing: 2px; cursor: pointer; transition: all 0.12s;
  }
  .drill-hit:hover { background: rgba(58,255,184,0.15); }
  .drill-miss {
    background: rgba(255,77,77,0.08); border: 1px solid var(--accent2); color: var(--accent2);
    padding: 16px; font-family: 'Bebas Neue', sans-serif; font-size: 20px;
    letter-spacing: 2px; cursor: pointer; transition: all 0.12s;
  }
  .drill-miss:hover { background: rgba(255,77,77,0.15); }

  .drill-stats-panel {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 14px; font-family: 'DM Mono', monospace;
    font-size: 12px; line-height: 1.9; color: var(--muted); min-height: 56px;
  }

  /* ── DRILL HISTORY (right side of drill page) ── */
  .drill-history-grid {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .drill-summary-table {
    width: 100%;
    border-collapse: collapse;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
  }
  .drill-summary-table th {
    text-align: left; padding: 8px 12px;
    font-size: 10px; letter-spacing: 2px;
    color: var(--muted); border-bottom: 1px solid var(--border);
    text-transform: uppercase;
  }
  .drill-summary-table td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }
  .drill-summary-table tr:hover td { background: var(--surface2); }
  .rate-great { color: var(--accent3); }
  .rate-ok { color: var(--accent); }
  .rate-bad { color: var(--accent2); }

  /* ── STATS PAGE ── */
  .stats-grid {
    display: grid; grid-template-columns: repeat(4,1fr);
    gap: 1px; background: var(--border); margin-bottom: 32px;
  }
  .stat-card { background: var(--surface); padding: 24px; }
  .stat-card label {
    display: block; font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px;
  }
  .stat-card .big-num { font-family: 'Bebas Neue', sans-serif; font-size: 52px; line-height: 1; color: var(--accent); }
  .stat-card .sub { font-size: 13px; color: var(--muted); margin-top: 4px; }

  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 24px; }

  .history-table { width: 100%; border-collapse: collapse; font-family: 'DM Mono', monospace; font-size: 12px; }
  .history-table th {
    text-align: left; padding: 10px 14px; font-size: 10px;
    letter-spacing: 2px; color: var(--muted);
    border-bottom: 1px solid var(--border); text-transform: uppercase;
  }
  .history-table td { padding: 11px 14px; border-bottom: 1px solid var(--border); color: var(--text); }
  .history-table tr:hover td { background: var(--surface2); }
  .history-table .good { color: var(--accent3); }
  .history-table .bad { color: var(--accent2); }
  .history-table .med { color: var(--accent); }

  .trend-chart { height: 160px; position: relative; overflow: hidden; }
  canvas { width: 100%; height: 100%; }

  .co-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 3px; margin-bottom: 16px; }
  .co-cell {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 8px 4px; text-align: center;
    font-family: 'DM Mono', monospace; font-size: 11px;
  }
  .co-cell .co-num { color: var(--muted); font-size: 9px; letter-spacing: 1px; }
  .co-cell .co-rate { font-family: 'Bebas Neue', sans-serif; font-size: 22px; }
  .co-cell .co-count { font-size: 9px; color: var(--muted); }
  .co-cell.great { border-color: rgba(58,255,184,0.4); background: rgba(58,255,184,0.05); }
  .co-cell.great .co-rate { color: var(--accent3); }
  .co-cell.ok .co-rate { color: var(--accent); }
  .co-cell.bad { border-color: rgba(255,77,77,0.25); background: rgba(255,77,77,0.04); }
  .co-cell.bad .co-rate { color: var(--accent2); }
  .co-cell.empty .co-rate { color: var(--dim); }

  .insight-box {
    background: var(--surface2);
    border-left: 2px solid var(--accent);
    padding: 12px 16px;
    font-family: 'DM Mono', monospace;
    font-size: 12px; color: var(--text); line-height: 1.8;
    margin-bottom: 8px;
  }
  .insight-box.warn { border-left-color: var(--accent2); }
  .insight-box.good { border-left-color: var(--accent3); }

  /* ── MISC ── */
  .row { display: flex; gap: 16px; align-items: center; margin-bottom: 16px; }
  .feel-btns { display: flex; gap: 6px; }
  .feel-btn {
    background: var(--surface2); border: 1px solid var(--border);
    font-size: 18px; padding: 8px 12px; cursor: pointer; transition: all 0.1s;
  }
  .feel-btn.active { border-color: var(--accent); background: rgba(232,255,58,0.1); }

  .tag-input {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 10px 14px;
    font-family: 'DM Mono', monospace; font-size: 12px;
    width: 100%; margin-bottom: 12px;
  }
  .tag-input::placeholder { color: var(--muted); }
  .tag-input:focus { outline: 1px solid var(--accent); }

  .toast {
    position: fixed; bottom: 32px; right: 32px;
    background: var(--surface); border: 1px solid var(--accent);
    color: var(--accent); padding: 14px 20px;
    font-family: 'DM Mono', monospace; font-size: 13px; letter-spacing: 1px;
    z-index: 999;
    animation: toastIn 0.2s ease, toastOut 0.3s ease 2.5s forwards;
    pointer-events: none;
  }
  .toast.error { border-color: var(--accent2); color: var(--accent2); }
  @keyframes toastIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: none; } }
  @keyframes toastOut { to { opacity:0; transform: translateY(10px); } }

  .session-end-btn {
    width: 100%;
    background: linear-gradient(135deg, rgba(232,255,58,0.12), rgba(232,255,58,0.06));
    border: 1.5px solid var(--accent);
    color: var(--accent);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 16px;
    letter-spacing: 3px;
    padding: 14px 10px;
    cursor: pointer;
    text-transform: uppercase;
    transition: all 0.15s;
    margin-top: 20px;
    box-shadow: 0 0 16px rgba(232,255,58,0.08), inset 0 0 20px rgba(232,255,58,0.03);
  }
  .session-end-btn:hover {
    background: linear-gradient(135deg, rgba(232,255,58,0.22), rgba(232,255,58,0.12));
    box-shadow: 0 0 24px rgba(232,255,58,0.2), inset 0 0 20px rgba(232,255,58,0.06);
  }
  .leg-counter { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); margin-bottom: 6px; letter-spacing: 1px; }
  /* ── DUAL SCORE (player vs bot) ── */
  .score-vs-layout {
    display: grid;
    grid-template-columns: 1fr 1px 1fr;
    gap: 0;
    margin-bottom: 4px;
    background: var(--border);
    border: 1px solid var(--border);
  }
  .score-vs-divider {
    background: var(--border);
    width: 1px;
    align-self: stretch;
  }
  .score-vs-side {
    background: var(--surface);
    padding: 16px 20px 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  .score-vs-side.you {
    border-top: 3px solid var(--accent);
    border-left: 3px solid var(--accent);
    border-bottom: 3px solid var(--accent);
  }
  .score-vs-side.bot {
    border-top: 3px solid var(--accent4);
    border-right: 3px solid var(--accent4);
    border-bottom: 3px solid var(--accent4);
  }
  .score-vs-label {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
    letter-spacing: 3px;
    text-transform: uppercase;
    margin-bottom: 4px;
  }
  .score-vs-side.you .score-vs-label { color: var(--accent); }
  .score-vs-side.bot .score-vs-label { color: var(--accent4); }
  .score-vs-num {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 88px;
    line-height: 1;
    transition: color 0.3s, text-shadow 0.3s;
  }
  .score-vs-side.you .score-vs-num {
    color: var(--accent);
    text-shadow: 0 0 50px rgba(232,255,58,0.25);
  }
  .score-vs-side.bot .score-vs-num {
    color: var(--accent4);
    text-shadow: 0 0 50px rgba(167,139,250,0.25);
  }
  .score-vs-sub {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 1px;
    margin-top: 6px;
    min-height: 14px;
    text-align: center;
  }

  /* ── CHECKOUT ROUTE PANEL ── */
  .checkout-route {
    background: linear-gradient(135deg, rgba(58,255,184,0.04), transparent);
    border: 1px solid rgba(58,255,184,0.25);
    border-left: 3px solid var(--accent3);
    padding: 10px 14px 12px;
    margin-bottom: 10px;
    font-family: 'DM Mono', monospace;
    display: none;
  }
  .checkout-route.visible { display: block; }
  .checkout-route-header {
    font-size: 9px;
    letter-spacing: 2px;
    color: var(--accent3);
    text-transform: uppercase;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  .checkout-routes-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }
  .checkout-route-row {
    display: flex;
    align-items: center;
    gap: 5px;
  }
  .checkout-route-rank {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 11px;
    color: var(--dim);
    width: 12px;
    flex-shrink: 0;
  }
  .checkout-dart {
    padding: 3px 8px;
    border: 1px solid var(--border);
    font-size: 11px;
    letter-spacing: 0.5px;
    white-space: nowrap;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 13px;
  }
  .checkout-dart.double { border-color: rgba(58,255,184,0.6); color: var(--accent3); background: rgba(58,255,184,0.08); }
  .checkout-dart.treble { border-color: rgba(167,139,250,0.6); color: var(--accent4); background: rgba(167,139,250,0.08); }
  .checkout-dart.bull   { border-color: rgba(255,200,0,0.6);  color: #ffc800; background: rgba(255,200,0,0.08); }
  .checkout-dart.single { border-color: rgba(200,200,200,0.2); color: var(--muted); }
  .checkout-arrow { color: var(--dim); font-size: 9px; flex-shrink: 0; }



  .weak-spots { display: flex; flex-direction: column; gap: 8px; }
  .weak-spot-row { display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--surface2); font-family: 'DM Mono', monospace; font-size: 12px; }
  .weak-spot-num { font-family: 'Bebas Neue', sans-serif; font-size: 24px; color: var(--accent2); width: 42px; }
  .weak-spot-bar-wrap { flex: 1; background: var(--dim); height: 4px; }
  .weak-spot-bar { height: 4px; background: var(--accent2); transition: width 0.5s; }
  .weak-spot-pct { color: var(--muted); width: 40px; text-align: right; }
  .weak-spot-tip { font-size: 10px; color: var(--muted); margin-top: 3px; }

  .board-container { display: flex; flex-direction: column; align-items: flex-start; overflow: visible; }

  /* voice help tooltip */
  .voice-help {
    background: var(--surface2);
    border: 1px solid var(--border);
    padding: 10px 14px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: var(--muted);
    line-height: 1.8;
    letter-spacing: 0.5px;
    margin-bottom: 8px;
    display: none;
  }
  .voice-help.visible { display: block; }
  .voice-help span { color: var(--accent2); }

  @keyframes voicePulse { 0%,100%{box-shadow:0 0 0 0 rgba(255,77,77,0.4)} 50%{box-shadow:0 0 0 10px rgba(255,77,77,0)} }

  /* ── SCORE HERO (score + big mic) ── */
  .score-hero {
    display: flex;
    align-items: center;
    gap: 0;
    margin-bottom: 4px;
    background: var(--surface);
    border: 1px solid var(--border);
  }
  .score-hero .score-display {
    flex: 1;
    border: none;
    margin: 0;
    padding: 16px 24px;
  }
  .voice-btn-hero {
    width: 100px;
    min-height: 120px;
    background: rgba(232,255,58,0.06);
    border: none;
    border-left: 2px solid rgba(232,255,58,0.3);
    color: var(--accent);
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    transition: all 0.15s;
    flex-shrink: 0;
    position: relative;
  }
  .voice-btn-hero::before {
    content: '';
    position: absolute;
    inset: 0;
    background: radial-gradient(ellipse at center, rgba(232,255,58,0.08) 0%, transparent 70%);
    pointer-events: none;
  }
  .voice-btn-hero:hover {
    background: rgba(232,255,58,0.12);
    border-left-color: var(--accent);
    color: var(--accent);
  }
  .voice-btn-hero.listening {
    border-left-color: var(--accent2);
    color: var(--accent2);
    background: rgba(255,77,77,0.12);
    animation: voicePulse 1s infinite;
  }
  .voice-btn-hero.listening::before {
    background: radial-gradient(ellipse at center, rgba(255,77,77,0.12) 0%, transparent 70%);
  }
  .voice-btn-hero .mic-icon { font-size: 36px; line-height: 1; filter: drop-shadow(0 0 8px rgba(232,255,58,0.5)); }
  .voice-btn-hero.listening .mic-icon { filter: drop-shadow(0 0 8px rgba(255,77,77,0.6)); }
  .voice-btn-hero .mic-label {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 2px;
    opacity: 0.8;
    text-transform: uppercase;
  }
  .voice-btn-hero.listening .mic-label { opacity: 1; color: var(--accent2); }

  /* ── DRILL VOICE STATUS ── */
  .drill-voice-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    border: 1px solid var(--border);
    margin-bottom: 12px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    color: var(--muted);
  }
  .drill-voice-btn {
    background: rgba(232,255,58,0.06);
    border: 1.5px solid rgba(232,255,58,0.35);
    color: var(--accent);
    padding: 8px 14px;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 14px;
    letter-spacing: 2px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.15s;
    white-space: nowrap;
    width: 100%;
    justify-content: center;
    box-shadow: 0 0 10px rgba(232,255,58,0.06);
  }
  .drill-voice-btn:hover {
    background: rgba(232,255,58,0.12);
    border-color: var(--accent);
    box-shadow: 0 0 16px rgba(232,255,58,0.14);
  }
  .drill-voice-btn.listening {
    border-color: var(--accent2);
    color: var(--accent2);
    background: rgba(255,77,77,0.12);
    box-shadow: 0 0 16px rgba(255,77,77,0.15);
    animation: voicePulse 1s infinite;
  }
  .drill-transcript {
    flex: 1;
    font-size: 11px;
    color: var(--muted);
    font-style: italic;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
  }
  .drill-transcript.heard { color: var(--accent2); font-style: normal; }
  .drill-transcript.parsed { color: var(--accent3); font-style: normal; }

  /* ── SOCIAL TAB ── */
  .social-layout {
    display: grid;
    grid-template-columns: 260px 1fr 260px;
    gap: 24px;
    align-items: start;
  }
  .social-sidebar { display: flex; flex-direction: column; gap: 16px; }
  .social-feed { display: flex; flex-direction: column; gap: 12px; }

  /* Profile card */
  .profile-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 20px;
  }
  .profile-avatar {
    width: 72px; height: 72px; border-radius: 50%;
    background: var(--accent);
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 28px; color: #000;
    margin-bottom: 12px;
    position: relative; cursor: pointer;
    overflow: hidden; flex-shrink: 0;
  }
  .profile-avatar img {
    width: 100%; height: 100%; object-fit: cover; border-radius: 50%;
    position: absolute; inset: 0;
  }
  .profile-avatar .avatar-edit-hint {
    position: absolute; inset: 0; border-radius: 50%;
    background: rgba(0,0,0,0.5); color: #fff;
    display: flex; align-items: center; justify-content: center;
    font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px;
    opacity: 0; transition: opacity 0.15s; text-transform: uppercase;
  }
  .profile-avatar:hover .avatar-edit-hint { opacity: 1; }
  #avatar-file-input { display: none; }
  /* Onboarding modal */
  .onboard-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.8);
    display: flex; align-items: center; justify-content: center;
    z-index: 300;
  }
  .onboard-box {
    background: var(--surface); border: 1px solid var(--border);
    padding: 32px; max-width: 400px; width: 90%; text-align: center;
  }
  .onboard-title {
    font-family: 'Bebas Neue', sans-serif; font-size: 28px;
    letter-spacing: 3px; color: var(--accent); margin-bottom: 8px;
  }
  .onboard-sub {
    font-family: 'DM Mono', monospace; font-size: 11px;
    color: var(--muted); margin-bottom: 24px; line-height: 1.7;
  }
  .onboard-input {
    width: 100%; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: 'Bebas Neue', sans-serif; font-size: 28px;
    text-align: center; padding: 12px; letter-spacing: 2px; outline: none;
    margin-bottom: 14px; box-sizing: border-box;
  }
  .onboard-input:focus { border-color: var(--accent); }
  .onboard-btn {
    width: 100%; padding: 14px; background: var(--accent); color: #000;
    font-family: 'Bebas Neue', sans-serif; font-size: 18px;
    letter-spacing: 2px; border: none; cursor: pointer;
  }
  .onboard-btn:hover { opacity: 0.85; }
  .profile-handle {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 20px; letter-spacing: 2px; color: var(--text);
  }
  .profile-sub {
    font-family: 'DM Mono', monospace;
    font-size: 10px; color: var(--muted); letter-spacing: 1px; margin-bottom: 14px;
  }
  .profile-stats {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 1px; background: var(--border);
    margin-top: 12px;
  }
  .profile-stat {
    background: var(--surface2);
    padding: 10px 12px;
    font-family: 'DM Mono', monospace;
  }
  .profile-stat label { font-size: 9px; color: var(--muted); letter-spacing: 1px; display: block; text-transform: uppercase; }
  .profile-stat span { font-family: 'Bebas Neue', sans-serif; font-size: 22px; color: var(--accent); }

  /* Who to follow */
  .follow-list { display: flex; flex-direction: column; gap: 2px; }
  .follow-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px;
    background: var(--surface2);
    transition: background 0.1s;
  }
  .follow-row:hover { background: var(--dim); }
  .follow-avatar {
    width: 34px; height: 34px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue', sans-serif; font-size: 14px; color: #000;
    flex-shrink: 0;
  }
  .follow-info { flex: 1; min-width: 0; }
  .follow-name { font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text); }
  .follow-avg { font-size: 10px; color: var(--muted); }
  /* ── COMMENTS ── */
  .post-comments {
    border-top: 1px solid var(--border);
    padding: 10px 14px 4px;
    display: none;
  }
  .post-comments.open { display: block; }
  .comment-item {
    display: flex;
    gap: 8px;
    margin-bottom: 10px;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
  }
  .comment-avatar {
    width: 22px; height: 22px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue', sans-serif; font-size: 10px;
    flex-shrink: 0; margin-top: 1px;
    background: var(--surface2); color: var(--muted);
  }
  .comment-body { flex: 1; }
  .comment-handle { color: var(--accent); font-size: 10px; margin-bottom: 2px; }
  .comment-text { color: var(--text); line-height: 1.5; }
  .comment-time { color: var(--dim); font-size: 9px; margin-top: 2px; }
  .comment-input-row {
    display: flex; gap: 6px; margin-top: 6px; padding-top: 8px;
    border-top: 1px solid var(--border);
  }
  .comment-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); font-family: 'DM Mono', monospace; font-size: 11px;
    padding: 6px 10px; outline: none;
  }
  .comment-input:focus { border-color: var(--accent); }
  .comment-submit {
    background: var(--accent); color: #000; border: none;
    font-family: 'Bebas Neue', sans-serif; font-size: 13px;
    letter-spacing: 1px; padding: 6px 12px; cursor: pointer;
    white-space: nowrap;
  }
  .comment-submit:hover { opacity: 0.85; }

  /* inline follow on post header */
  .post-follow-btn {
    font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px;
    padding: 3px 8px; border: 1px solid var(--border); color: var(--muted);
    background: none; cursor: pointer; transition: all 0.12s; white-space: nowrap;
    text-transform: uppercase;
  }
  .post-follow-btn:hover { border-color: var(--accent); color: var(--accent); }
  .post-follow-btn.following { border-color: var(--accent3); color: var(--accent3); }

  .follow-btn {
    background: none; border: 1px solid var(--accent3); color: var(--accent3);
    padding: 4px 10px; font-family: 'DM Mono', monospace; font-size: 10px;
    cursor: pointer; transition: all 0.1s; letter-spacing: 1px; white-space: nowrap;
  }
  .follow-btn:hover { background: rgba(58,255,184,0.1); }
  .follow-btn.following { border-color: var(--dim); color: var(--muted); }

  /* Feed post cards */
  .post-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 18px 20px;
    transition: border-color 0.15s;
    animation: slideIn 0.25s ease;
  }
  .post-card:hover { border-color: #3a3a3a; }
  .post-header {
    display: flex; align-items: center; gap: 10px; margin-bottom: 12px;
  }
  .post-avatar {
    width: 38px; height: 38px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Bebas Neue', sans-serif; font-size: 16px; color: #000;
    flex-shrink: 0;
  }
  .post-meta { flex: 1; }
  .post-handle { font-family: 'DM Mono', monospace; font-size: 13px; color: var(--text); font-weight: 500; }
  .post-time { font-family: 'DM Mono', monospace; font-size: 10px; color: var(--muted); }
  .post-type-badge {
    font-family: 'DM Mono', monospace; font-size: 9px; letter-spacing: 1px;
    padding: 3px 8px; border: 1px solid; text-transform: uppercase;
  }
  .post-type-badge.session { border-color: rgba(232,255,58,0.4); color: var(--accent); background: rgba(232,255,58,0.05); }
  .post-type-badge.checkout { border-color: rgba(58,255,184,0.4); color: var(--accent3); background: rgba(58,255,184,0.05); }
  .post-type-badge.drill { border-color: rgba(167,139,250,0.4); color: var(--accent4); background: rgba(167,139,250,0.05); }
  .post-type-badge.milestone { border-color: rgba(255,77,77,0.4); color: var(--accent2); background: rgba(255,77,77,0.05); }

  .post-body { font-family: 'DM Sans', sans-serif; font-size: 14px; color: var(--text); line-height: 1.6; margin-bottom: 12px; }
  .post-body .highlight { color: var(--accent); font-weight: 600; }
  .post-body .highlight2 { color: var(--accent3); font-weight: 600; }

  .post-stats-row {
    display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px;
  }
  .post-stat-chip {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 5px 10px; font-family: 'DM Mono', monospace; font-size: 11px;
  }
  .post-stat-chip label { color: var(--muted); font-size: 9px; letter-spacing: 1px; display: block; text-transform: uppercase; }
  .post-stat-chip span { color: var(--text); }

  .post-actions {
    display: flex; gap: 6px; border-top: 1px solid var(--border); padding-top: 12px;
  }
  .post-action-btn {
    background: none; border: 1px solid var(--border);
    color: var(--muted); padding: 6px 14px;
    font-family: 'DM Mono', monospace; font-size: 10px; letter-spacing: 1px;
    cursor: pointer; transition: all 0.1s; text-transform: uppercase;
    display: flex; align-items: center; gap: 5px;
  }
  .post-action-btn:hover { border-color: var(--accent); color: var(--accent); }
  .post-action-btn.liked { border-color: var(--accent2); color: var(--accent2); background: rgba(255,77,77,0.07); }

  /* Trending panel */
  .trending-row {
    display: flex; align-items: center; gap: 10px;
    padding: 9px 12px; background: var(--surface2);
    font-family: 'DM Mono', monospace; font-size: 11px;
    border-bottom: 1px solid var(--border);
  }
  .trending-rank { color: var(--muted); width: 18px; font-size: 10px; }
  .trending-tag { color: var(--accent); flex: 1; }
  .trending-count { color: var(--muted); font-size: 10px; }

  /* Post composer */
  .post-composer {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 16px;
    margin-bottom: 4px;
  }
  .composer-row { display: flex; gap: 10px; align-items: flex-start; }
  .composer-input {
    flex: 1; background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 10px 14px;
    font-family: 'DM Sans', sans-serif; font-size: 13px;
    resize: none; min-height: 44px;
  }
  .composer-input::placeholder { color: var(--muted); }
  .composer-input:focus { outline: 1px solid var(--accent); }
  .composer-actions { display: flex; gap: 6px; margin-top: 10px; justify-content: flex-end; }
  .btn-post {
    background: var(--accent); color: #000;
    border: none; padding: 8px 20px;
    font-family: 'Bebas Neue', sans-serif; font-size: 16px; letter-spacing: 2px;
    cursor: pointer; transition: all 0.1s;
  }
  .btn-post:hover { background: #d4e82a; }
  .btn-share-session {
    background: none; border: 1px solid var(--accent3); color: var(--accent3);
    padding: 8px 14px; font-family: 'DM Mono', monospace; font-size: 10px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.1s;
  }
  .btn-share-session:hover { background: rgba(58,255,184,0.08); }

  /* Feed filter tabs */
  .feed-filters {
    display: flex; gap: 4px; margin-bottom: 16px;
  }
  .feed-filter {
    background: none; border: 1px solid var(--border); color: var(--muted);
    padding: 6px 14px; font-family: 'DM Mono', monospace; font-size: 11px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.1s; text-transform: uppercase;
  }
  .feed-filter.active, .feed-filter:hover {
    border-color: var(--accent); color: var(--accent); background: rgba(232,255,58,0.05);
  }

  .hidden { display: none !important; }

  /* ── CRICKET ── */
  /* ── CRICKET SCOREBOARD — Vertical layout ── */
  .cricket-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 16px;
  }
  .cricket-board {
    border: 1px solid var(--border);
    background: var(--surface);
    font-family: 'DM Mono', monospace;
    overflow: hidden;
  }
  .cricket-header {
    display: grid;
    grid-template-columns: 1fr 60px 1fr;
    background: var(--surface2);
    border-bottom: 2px solid var(--border);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 15px;
    letter-spacing: 3px;
  }
  .ch-player {
    text-align: center;
    padding: 12px 8px;
    line-height: 1;
  }
  .ch-player.you { color: var(--accent); }
  .ch-player.bot { color: var(--accent4); }
  .ch-player .ch-score {
    font-size: 28px;
    display: block;
    margin-top: 4px;
  }
  .ch-player.you .ch-score { color: var(--accent); }
  .ch-player.bot .ch-score { color: var(--accent4); }
  .ch-middle-header {
    display: flex; align-items: center; justify-content: center;
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    color: var(--muted); font-size: 9px; letter-spacing: 2px;
    text-align: center; padding: 4px;
  }
  .cricket-row {
    display: grid;
    grid-template-columns: 1fr 60px 1fr;
    border-bottom: 1px solid var(--border);
    min-height: 52px;
    transition: background 0.1s;
  }
  .cricket-row:last-child { border-bottom: none; }
  .cricket-row.fully-closed { background: rgba(0,0,0,0.25); }
  .cricket-marks {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 6px 8px;
  }
  .cricket-marks svg { display: block; }
  .cricket-num {
    display: flex;
    align-items: center;
    justify-content: center;
    font-family: 'Bebas Neue', sans-serif;
    font-size: 24px;
    letter-spacing: 1px;
    color: var(--text);
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    position: relative;
    user-select: none;
  }
  .cricket-num.closed-both {
    color: var(--dim);
  }
  .cricket-num.closed-both::before {
    content: '';
    position: absolute;
    left: 4px; right: 4px;
    top: 50%;
    height: 1.5px;
    background: var(--dim);
  }
  .cricket-num.owned-you { color: var(--accent); text-shadow: 0 0 10px rgba(232,255,58,0.3); }
  .cricket-num.owned-bot { color: var(--accent4); text-shadow: 0 0 10px rgba(167,139,250,0.3); }
  /* Cricket dart input - multiplier buttons */
  .cricket-input-area { margin-bottom: 12px; }
  .cricket-mult-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 6px; margin-bottom: 8px; }
  .cricket-mult-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--muted); padding: 10px; font-family: 'Bebas Neue', sans-serif;
    font-size: 18px; letter-spacing: 2px; cursor: pointer; transition: all 0.1s; text-align: center;
  }
  .cricket-mult-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(232,255,58,0.08); }
  .cricket-num-btns { display: grid; grid-template-columns: repeat(4,1fr); gap: 6px; }
  .cricket-num-btn {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text); padding: 12px 6px; font-family: 'Bebas Neue', sans-serif;
    font-size: 20px; cursor: pointer; transition: all 0.1s; text-align: center;
  }
  .cricket-num-btn:hover { border-color: var(--muted); }
  .cricket-num-btn.closed { opacity: 0.3; pointer-events: none; }
  .cricket-num-btn.owned { border-color: var(--accent); color: var(--accent); background: rgba(232,255,58,0.05); }
  .cricket-turn-info {
    font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted);
    text-align: center; padding: 8px; letter-spacing: 1px;
    background: var(--surface2); border: 1px solid var(--border); margin-bottom: 8px;
  }
  .cricket-turn-info .dart-pips { color: var(--accent); font-size: 14px; letter-spacing: 3px; }
  .cricket-miss-btn {
    width: 100%; background: none; border: 1px solid var(--dim); color: var(--dim);
    font-family: 'DM Mono', monospace; font-size: 11px; padding: 9px;
    cursor: pointer; letter-spacing: 1px; text-transform: uppercase; transition: all 0.15s;
    margin-top: 8px;
  }
  .cricket-miss-btn:hover { border-color: var(--muted); color: var(--muted); }
  /* Google sign-in button */
  #googleSignInButton {
    display: inline-flex; align-items: center; gap: 7px;
    background: #fff; color: #3c4043;
    border: 1px solid #dadce0;
    padding: 7px 14px;
    font-family: 'DM Mono', monospace; font-size: 11px; letter-spacing: 0.5px;
    cursor: pointer; white-space: nowrap;
    transition: box-shadow 0.15s, background 0.15s;
  }
  #googleSignInButton:hover { box-shadow: 0 1px 4px rgba(0,0,0,0.25); background: #f8f8f8; }
  #googleSignInButton svg { flex-shrink: 0; }
  /* Miss mode mult button */
  .cricket-mult-btn.miss-mode { color: var(--accent2); border-color: transparent; }
  .cricket-mult-btn.miss-mode.active {
    border-color: var(--accent2); color: var(--accent2);
    background: rgba(255,77,77,0.08);
  }
  /* Miss dot indicators in board rows */
  .cricket-miss-dots {
    display: flex; flex-wrap: wrap; gap: 2px;
    align-items: center; justify-content: center;
    min-height: 14px; padding: 0 4px;
  }
  .cricket-miss-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent2); opacity: 0.55;
    flex-shrink: 0;
  }

  /* ── BOT OPPONENT ── */
  .bot-turn-overlay {
    background: var(--surface2); border: 1px solid var(--accent4);
    padding: 14px 18px; font-family: 'DM Mono', monospace; font-size: 12px;
    color: var(--accent4); margin-bottom: 12px; letter-spacing: 0.5px; line-height: 1.8;
    display: none;
  }
  .bot-turn-overlay.visible { display: block; }

  /* ── MOBILE ── */
  @media (max-width: 1100px) {
    .social-layout { grid-template-columns: 1fr 1fr; }
    .social-layout > *:last-child { display: none; }
  }

  @media (max-width: 820px) {
    .hamburger { display: flex; }
    nav {
      display: none;
      width: 100%;
      order: 99;
      flex-direction: column;
      gap: 0;
      border-top: 1px solid var(--border);
      padding-top: 8px;
      margin-top: 4px;
    }
    nav.open { display: flex; }
    nav button {
      padding: 12px 16px;
      font-size: 13px;
      border-left: none; border-right: none; border-top: none;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }
    nav button:last-child { border-bottom: none; }
    #auth-container {
      display: none !important;
    }
    #auth-container.mobile-open {
      display: flex !important;
      flex-direction: column;
      width: 100%;
      order: 100;
      gap: 6px;
      padding: 10px 0 4px;
      border-top: 1px solid var(--border);
    }
    #auth-container.mobile-open input { width: 100%; }
    #auth-container.mobile-open #googleSignInButton { width: 100%; justify-content: center; }
    #userStatus { display: none !important; }
    .logo span { display: none; }
    .page { padding: 14px; }
    .social-layout { grid-template-columns: 1fr; }
    .social-layout > *:nth-child(3) { display: none; }
    .social-sidebar:first-child > .panel:last-child { display: none; }
  }

  @media (max-width: 640px) {
    header { padding: 10px 14px; }
    .logo { font-size: 22px; }
    .page { padding: 10px; }
    .score-display { font-size: 72px; }
    .score-meta { grid-template-columns: repeat(3,1fr); }
    .score-meta .val { font-size: 22px; }
    .numpad button { font-size: 22px; padding: 14px; }
    .stats-grid { grid-template-columns: repeat(2,1fr); }
    .two-col { grid-template-columns: 1fr; }
    .drill-page-grid { grid-template-columns: 1fr; }
    .co-grid { grid-template-columns: repeat(3,1fr); }
    .session-setup { flex-direction: column; }
    .session-setup .setup-select { min-width: 100%; }
    .btn-new-leg { width: 100%; }
    .modal { padding: 20px 16px; }
    .modal-btn-row { grid-template-columns: 1fr; }
    .two-col.stats-two-col { grid-template-columns: 1fr; }
  }

  /* ── SESSION END MODAL ── */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.75);
    z-index: 500; display: flex; align-items: center; justify-content: center;
    animation: fadeIn 0.15s ease;
  }
  .modal-overlay.hidden { display: none; }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  .modal {
    background: var(--surface); border: 1px solid var(--border);
    padding: 32px; width: 520px; max-width: 96vw;
    max-height: 90vh; overflow-y: auto;
    animation: slideUp 0.15s ease;
  }
  @keyframes slideUp { from{transform:translateY(12px);opacity:0} to{transform:none;opacity:1} }

  .modal-title {
    font-family: 'Bebas Neue', sans-serif; font-size: 22px;
    letter-spacing: 3px; color: var(--accent); margin-bottom: 20px;
  }
  .modal-stat-row {
    display: grid; grid-template-columns: repeat(3,1fr);
    gap: 1px; background: var(--border); margin-bottom: 20px;
  }
  .modal-stat-row > div { background: var(--surface2); padding: 14px; text-align: center; }
  .modal-stat-row label {
    display: block; font-family: 'DM Mono', monospace; font-size: 9px;
    color: var(--muted); letter-spacing: 1px; text-transform: uppercase; margin-bottom: 4px;
  }
  .modal-stat-row .val { font-family: 'Bebas Neue', sans-serif; font-size: 28px; color: var(--accent); }

  .modal-section-label {
    font-family: 'DM Mono', monospace; font-size: 10px;
    color: var(--muted); letter-spacing: 2px; text-transform: uppercase;
    margin-bottom: 8px; margin-top: 18px;
  }
  .modal-share-row {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 14px; background: var(--surface2);
    border: 1px solid var(--border); margin-bottom: 8px;
  }
  .modal-share-toggle {
    width: 38px; height: 22px; background: var(--dim);
    border: 1px solid var(--border); border-radius: 11px;
    cursor: pointer; position: relative; flex-shrink: 0;
    transition: background 0.2s;
  }
  .modal-share-toggle.on { background: var(--accent3); border-color: var(--accent3); }
  .modal-share-toggle::after {
    content: ''; position: absolute; top: 2px; left: 2px;
    width: 16px; height: 16px; background: #fff; border-radius: 50%;
    transition: left 0.2s;
  }
  .modal-share-toggle.on::after { left: 18px; }
  .modal-share-label { font-family: 'DM Mono', monospace; font-size: 11px; flex: 1; }
  .modal-share-label span { color: var(--muted); font-size: 10px; display: block; margin-top: 2px; }

  .modal-btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 20px; }
  .modal-btn-cancel {
    background: none; border: 1px solid var(--dim); color: var(--muted);
    padding: 14px; font-family: 'DM Mono', monospace; font-size: 12px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.15s; text-transform: uppercase;
  }
  .modal-btn-cancel:hover { border-color: var(--muted); color: var(--text); }
  .modal-btn-save {
    background: var(--accent); color: #000; border: none;
    padding: 14px; font-family: 'Bebas Neue', sans-serif; font-size: 18px;
    letter-spacing: 3px; cursor: pointer; transition: all 0.15s;
  }
  .modal-btn-save:hover { background: #d4e82a; }

  /* ── AUTO-POST SETTINGS ── */
  .auto-post-panel {
    background: var(--surface); border: 1px solid var(--border); padding: 20px; margin-bottom: 16px;
  }
  .auto-post-row {
    display: flex; align-items: center; gap: 12px;
    padding: 11px 0; border-bottom: 1px solid var(--border);
  }
  .auto-post-row:last-child { border-bottom: none; }
  .auto-post-icon { font-size: 18px; width: 26px; text-align: center; }
  .auto-post-info { flex: 1; font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text); }
  .auto-post-info span { font-size: 10px; color: var(--muted); display: block; margin-top: 2px; }

  /* ── HISTORY PAGE ── */
  .history-session-card {
    background: var(--surface); border: 1px solid var(--border); padding: 20px; margin-bottom: 12px;
  }
  .history-session-header {
    display: flex; align-items: center; gap: 16px; margin-bottom: 14px;
  }
  .history-session-date {
    font-family: 'Bebas Neue', sans-serif; font-size: 20px; letter-spacing: 2px; color: var(--accent);
  }
  .history-session-meta { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); flex: 1; }
  .history-session-feel { font-size: 20px; }
  .history-stat-chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .history-chip {
    background: var(--surface2); border: 1px solid var(--border);
    padding: 5px 10px; font-family: 'DM Mono', monospace; font-size: 11px;
  }
  .history-chip label { color: var(--muted); font-size: 9px; letter-spacing: 1px; display: block; text-transform: uppercase; }
  .history-chip span { color: var(--text); }
  .history-notes {
    margin-top: 12px; padding: 8px 12px; background: var(--surface2);
    border-left: 2px solid var(--dim);
    font-family: 'DM Mono', monospace; font-size: 11px; color: var(--muted); line-height: 1.6;
  }

  /* ── SOCIAL SIGN-IN GATE ── */
  .social-gate {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    min-height: 300px; text-align: center; padding: 40px;
    font-family: 'DM Mono', monospace; color: var(--muted);
  }
  .social-gate .gate-icon { font-size: 48px; margin-bottom: 16px; }
  .social-gate .gate-title {
    font-family: 'Bebas Neue', sans-serif; font-size: 22px;
    letter-spacing: 3px; color: var(--text); margin-bottom: 8px;
  }
  .social-gate .gate-sub { font-size: 12px; line-height: 1.8; max-width: 360px; margin-bottom: 20px; }

  /* ── DRILL SHARE BUTTON ── */
  .drill-save-row {
    display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-top: 16px;
  }
  .btn-drill-save {
    background: none; border: 1px solid var(--accent3); color: var(--accent3);
    padding: 9px 18px; font-family: 'DM Mono', monospace; font-size: 11px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.15s; text-transform: uppercase;
  }
  .btn-drill-save:hover { background: rgba(58,255,184,0.08); }
  .btn-drill-share {
    background: none; border: 1px solid var(--accent4); color: var(--accent4);
    padding: 9px 18px; font-family: 'DM Mono', monospace; font-size: 11px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.15s; text-transform: uppercase;
  }
  .btn-drill-share:hover { background: rgba(167,139,250,0.08); }

</style>
</head>
<body>

<header>
  <div class="logo">Bullboard <span>// PRACTICE</span></div>

  <nav id="main-nav">
    <button class="active" onclick="showPage('home',this);closeMenu()">Home</button>
    <button onclick="showPage('practice',this);closeMenu()">Practice</button>
    <button onclick="showPage('drill',this);closeMenu()">Drills</button>
    <button onclick="showPage('stats',this);closeMenu()">Stats</button>
    <button onclick="showPage('analysis',this);closeMenu()">Analysis</button>
    <button onclick="showPage('history',this);closeMenu()">History</button>
  </nav>

  <div id="auth-container" style="display:flex;gap:8px;align-items:center;flex-shrink:0;">
    <button id="googleSignInButton" title="Sign in with Google">
      <!-- Google 'G' logo SVG -->
      <svg width="16" height="16" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.36-8.16 2.36-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
        <path fill="none" d="M0 0h48v48H0z"/>
      </svg>
      Sign in with Google
    </button>
    <input type="email" id="emailInput" placeholder="Email" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-family:DM Mono,monospace;font-size:12px;width:140px;" />
    <input type="password" id="passwordInput" placeholder="Password" style="background:var(--surface2);border:1px solid var(--border);color:var(--text);padding:8px 12px;font-family:DM Mono,monospace;font-size:12px;width:120px;" />
    <button id="signUpButton" style="background:var(--accent);color:#000;border:none;padding:8px 14px;font-family:Bebas Neue,sans-serif;font-size:12px;cursor:pointer;white-space:nowrap;">SIGN UP</button>
    <button id="signInButton" style="background:none;border:1px solid var(--accent);color:var(--accent);padding:8px 14px;font-family:Bebas Neue,sans-serif;font-size:12px;cursor:pointer;white-space:nowrap;">SIGN IN</button>
    <button id="signOutButton" style="display:none;background:none;border:1px solid var(--dim);color:var(--dim);padding:8px 14px;font-family:DM Mono,monospace;font-size:11px;cursor:pointer;white-space:nowrap;">SIGN OUT</button>
  </div>

  <button class="hamburger" id="hamburger" onclick="toggleMenu()" aria-label="Menu">
    <span></span><span></span><span></span>
  </button>

  <p id="userStatus" style="font-family:DM Mono,monospace;font-size:11px;color:var(--muted);position:absolute;right:20px;bottom:-20px;pointer-events:none;">Not signed in.</p>
</header>
<!-- ═══════════════════ PRACTICE PAGE ═══════════════════ -->
<div id="page-practice" class="page">
  <div class="session-setup">
    <select class="setup-select" id="game-mode" onchange="onGameModeChange()">
      <option value="501">501</option>
      <option value="301">301</option>
      <option value="cricket">Cricket</option>
    </select>
    <select class="setup-select" id="out-mode">
      <option value="double">Double Out</option>
      <option value="single">Single Out</option>
      <option value="master">Master Out</option>
    </select>
    <select class="setup-select" id="bot-level">
      <option value="none">No Bot</option>
      <option value="1">Bot — Level 1 (Beginner)</option>
      <option value="2">Bot — Level 2</option>
      <option value="3">Bot — Level 3</option>
      <option value="4">Bot — Level 4</option>
      <option value="5">Bot — Level 5 (Club)</option>
      <option value="6">Bot — Level 6</option>
      <option value="7">Bot — Level 7</option>
      <option value="8">Bot — Level 8</option>
      <option value="9">Bot — Level 9</option>
      <option value="10">Bot — Level 10 (Pro)</option>
    </select>
    <button class="btn-new-leg" onclick="newLeg()">+ New Leg</button>
  </div>

  <div class="leg-counter" id="leg-counter">LEG 1 · 501</div>

  <!-- Score + big mic hero row -->
  <!-- Solo mode: single score display -->
  <div class="score-hero" id="score-hero-solo">
    <div class="score-display" id="score-display">501</div>
    <button class="voice-btn-hero" id="voice-btn" onclick="toggleVoice()" title="Voice score input (or press Spacebar)">
      <span class="mic-icon">🎙</span>
      <span class="mic-label">CALL IT</span>
    </button>
  </div>

  <!-- Bot mode: side-by-side scores (hidden when no bot) -->
  <div class="score-vs-layout" id="score-hero-bot" style="display:none">
    <div class="score-vs-side you">
      <div class="score-vs-label">You</div>
      <div class="score-vs-num" id="score-display-you">501</div>
      <div class="score-vs-sub" id="score-vs-sub-you"></div>
    </div>
    <div class="score-vs-divider"></div>
    <div class="score-vs-side bot">
      <div class="score-vs-label" id="score-vs-bot-name">Bot</div>
      <div class="score-vs-num" id="score-display-bot">501</div>
      <div class="score-vs-sub" id="score-vs-sub-bot"></div>
    </div>
  </div>

  <!-- Checkout route hint (shown when player ≤ 170) -->
  <div class="checkout-route" id="checkout-route-panel">
    <div class="checkout-route-header">🎯 Checkout Route</div>
    <div class="checkout-routes-list" id="checkout-routes-list"></div>
  </div>

  <!-- Voice in bot mode (below dual score) -->
  <div id="bot-voice-row" style="display:none;margin-bottom:4px;">
    <button class="voice-btn-hero" id="voice-btn-bot" onclick="toggleVoice()"
      style="width:100%;min-height:52px;flex-direction:row;gap:10px;"
      title="Voice score input">
      <span class="mic-icon" style="font-size:22px">🎙</span>
      <span class="mic-label">CALL IT / TAP TO SPEAK</span>
    </button>
  </div>

  <!-- Voice transcript -->
  <div class="voice-transcript" id="voice-transcript"></div>

  <!-- Voice help text (shown after first tap) -->
  <div class="voice-help" id="voice-help">
    <strong>Total:</strong> <span>"one forty"</span> · <span>"eighty one"</span> · <span>"140"</span><br>
    <strong>1 dart:</strong> <span>"treble twenty"</span> · <span>"double 16"</span> · <span>"double top"</span><br>
    <strong>3 darts:</strong> <span>"treble 20 single 5 double 16"</span> · order flexible<br>
    <strong>Also:</strong> <span>"bull"</span> · <span>"bullseye"</span> · <span>"bust"</span> · <span>Spacebar</span> to activate
  </div>

  <div class="score-meta">
    <div><label>Round</label><span class="val" id="round-num">1</span></div>
    <div><label>Avg / 3</label><span class="val" id="avg-display">—</span></div>
    <div><label>Darts</label><span class="val" id="dart-count">0</span></div>
  </div>

  <!-- Cricket UI (hidden for 01 games) -->
  <div id="cricket-ui" style="display:none">
    <div id="bot-turn-overlay" class="bot-turn-overlay"></div>

    <!-- Turn + darts counter bar -->
    <div class="cricket-turn-info" id="cricket-turn-info">
      <span id="cricket-whose-turn">YOUR TURN</span> &nbsp;·&nbsp;
      Darts: <span class="dart-pips" id="cricket-dart-pips">● ● ●</span>
    </div>

    <!-- Scoreboard + input side-by-side -->
    <div class="cricket-layout">
      <!-- LEFT: Scoreboard -->
      <div class="cricket-board" id="cricket-board">
        <!-- rendered by renderCricketBoard() -->
      </div>

      <!-- RIGHT: Input -->
      <div class="cricket-input-area">
        <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;">Multiplier</div>
        <div class="cricket-mult-row">
          <button class="cricket-mult-btn active" id="cm-single" onclick="setCricketMult(1,this)">Single</button>
          <button class="cricket-mult-btn" id="cm-double" onclick="setCricketMult(2,this)">Double</button>
          <button class="cricket-mult-btn" id="cm-treble" onclick="setCricketMult(3,this)">Treble</button>
          <button class="cricket-mult-btn miss-mode" id="cm-miss" onclick="setCricketMult(0,this)">Miss</button>
        </div>
        <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin:10px 0 6px;">Target</div>
        <div class="cricket-num-btns" id="cricket-num-btns">
          <!-- rendered dynamically -->
        </div>
        <button class="cricket-miss-btn" style="margin-top:8px" onclick="cricketMiss()">Off-board (no target)</button>

        <!-- Cricket Voice Input -->
        <div style="margin-top:12px;">
          <div style="font-family:'DM Mono',monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:6px;">Voice</div>
          <button class="voice-btn-hero" id="cricket-voice-btn" onclick="toggleCricketVoice()"
            style="width:100%;min-height:54px;flex-direction:row;gap:10px;border:1px solid rgba(232,255,58,0.3);"
            title="Say: Single 20 / Double 18 / Treble 20 / Bull / Miss">
            <span class="mic-icon" style="font-size:22px">🎙</span>
            <span class="mic-label">Say: Single 20 · Double 18 · Treble 20</span>
          </button>
          <div id="cricket-voice-transcript" style="font-family:'DM Mono',monospace;font-size:10px;color:var(--muted);min-height:18px;margin-top:4px;text-align:center;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Standard 01 UI (hidden for Cricket) -->
  <div id="standard-ui">

  <!-- Input row -->
  <div class="input-row">
    <div class="input-display" id="input-display"><span class="cursor"></span></div>
  </div>

  <div class="numpad">
    <button onclick="numPress(1)">1</button><button onclick="numPress(2)">2</button><button onclick="numPress(3)">3</button>
    <button onclick="numPress(4)">4</button><button onclick="numPress(5)">5</button><button onclick="numPress(6)">6</button>
    <button onclick="numPress(7)">7</button><button onclick="numPress(8)">8</button><button onclick="numPress(9)">9</button>
    <button class="zero" onclick="numPress(0)">0</button>
    <button class="del" onclick="numDel()">⌫</button>
  </div>

  <div class="throw-history" id="throw-history"></div>

  <div class="row" style="margin-top:16px">
    <span style="font-family:DM Mono,monospace;font-size:11px;color:var(--muted);letter-spacing:1px;">FEEL</span>
    <div class="feel-btns">
      <button class="feel-btn" onclick="setFeel(1,this)">😩</button>
      <button class="feel-btn" onclick="setFeel(2,this)">😕</button>
      <button class="feel-btn active" onclick="setFeel(3,this)">😐</button>
      <button class="feel-btn" onclick="setFeel(4,this)">🙂</button>
      <button class="feel-btn" onclick="setFeel(5,this)">🔥</button>
    </div>
  </div>

  </div> <!-- /standard-ui -->

  <input class="tag-input" id="session-notes" placeholder="Session notes... (e.g. 'elbow dropping on high numbers')" />
  <button class="session-end-btn" onclick="openEndSessionModal()">End Session &amp; Save</button>
</div>

<!-- ═══════════════════ SESSION END MODAL ═══════════════════ -->
<div id="session-end-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">End Session</div>
    <div class="modal-stat-row" id="modal-stats-row">
      <div><label>Legs</label><span class="val" id="modal-legs">0</span></div>
      <div><label>Avg</label><span class="val" id="modal-avg">—</span></div>
      <div><label>CO%</label><span class="val" id="modal-co">—</span></div>
    </div>

    <div class="modal-section-label">Feel</div>
    <div style="display:flex;gap:6px;margin-bottom:16px;" id="modal-feel-btns">
      <button class="feel-btn" onclick="setModalFeel(1,this)">😩</button>
      <button class="feel-btn" onclick="setModalFeel(2,this)">😕</button>
      <button class="feel-btn active" onclick="setModalFeel(3,this)">😐</button>
      <button class="feel-btn" onclick="setModalFeel(4,this)">🙂</button>
      <button class="feel-btn" onclick="setModalFeel(5,this)">🔥</button>
    </div>

    <div class="modal-section-label">Notes</div>
    <textarea id="modal-session-notes" class="tag-input" style="min-height:72px;resize:vertical;" placeholder="How did it feel? e.g. 'elbow dropping on high numbers'"></textarea>

    <div class="modal-section-label">Share to Social</div>
    <div class="modal-share-row">
      <div class="modal-share-toggle" id="modal-share-toggle" onclick="toggleModalShare()"></div>
      <div class="modal-share-label">Post session summary to feed
        <span>Visible to people who follow you</span>
      </div>
    </div>
    <textarea id="modal-share-text" class="tag-input" style="min-height:56px;resize:vertical;display:none;" placeholder="Add a caption (optional)..."></textarea>

    <div class="modal-btn-row">
      <button class="modal-btn-cancel" onclick="closeEndSessionModal()">Cancel</button>
      <button class="modal-btn-save" onclick="confirmEndSession()">Save Session</button>
    </div>
  </div>
</div>

<!-- ═══════════════════ DRILL PAGE ═══════════════════ -->
<div id="page-drill" class="page">
  <div class="drill-page-grid">

    <!-- TOP: CONTROLS ROW (full width) -->
    <div class="panel">
      <div class="panel-title">Drill Tracker</div>
      <div class="drill-controls-row">

        <div class="drill-section">
          <div class="dsec" style="margin-top:0">Bed Type</div>
          <div class="toggle-group g3" id="bed-toggle">
            <button class="toggle-btn sel-single" onclick="selectBedType('single',this)">Single</button>
            <button class="toggle-btn" onclick="selectBedType('double',this)">Double</button>
            <button class="toggle-btn" onclick="selectBedType('treble',this)">Treble</button>
          </div>
          <div class="dsec">Darts Per Attempt</div>
          <div class="toggle-group g2" id="darts-toggle">
            <button class="toggle-btn" onclick="selectDartCount(1,this)">1 Dart</button>
            <button class="toggle-btn sel-darts" onclick="selectDartCount(3,this)">3 Darts</button>
          </div>
        </div>

        <div class="drill-section">
          <div class="dsec" style="margin-top:0">Miss Direction</div>
          <div class="miss-grid">
            <button class="miss-btn" onclick="selectMiss('left',this)">← Left</button>
            <button class="miss-btn" onclick="selectMiss('high',this)">↑ High</button>
            <button class="miss-btn" onclick="selectMiss('low',this)">↓ Low</button>
            <button class="miss-btn" onclick="selectMiss('right',this)">→ Right</button>
          </div>
          <div class="dsec">Voice</div>
          <div class="drill-voice-bar">
            <button class="drill-voice-btn" id="drill-voice-btn" onclick="toggleDrillVoice()">🎙 <span id="drill-voice-btn-label">Tap to speak</span></button>
            <div class="drill-transcript" id="drill-transcript">Say "Hit" or "Miss left"</div>
          </div>
        </div>

        <div class="drill-section" style="grid-column:span 3">
          <div class="dsec" style="margin-top:0">Target</div>
          <div class="target-grid" id="target-grid" style="grid-template-columns:repeat(14,1fr)"></div>
          <div class="attempt-label" id="attempt-label" style="text-align:left;margin-top:8px">Select a target to begin</div>
          <div class="attempt-progress" id="attempt-progress"></div>
          <div class="drill-action-btns" style="margin-top:12px">
            <button class="drill-hit" onclick="logDrill('hit')">HIT ✓</button>
            <button class="drill-miss" onclick="logDrill('miss')">MISS ✗</button>
          </div>
          <div class="drill-stats-panel" id="drill-stats-display" style="margin-top:10px">Select a target and start throwing.</div>
        </div>

      </div>
    </div>

    <!-- BOTTOM: THIS SESSION + ALL-TIME -->
    <div class="drill-bottom-row">
      <div class="panel">
        <div class="panel-title">This Session</div>
        <div id="drill-session-log" style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);">No throws logged yet.</div>
        <div class="drill-save-row">
          <button class="btn-drill-save" onclick="saveDrillSession()">☁ Save Drill Session</button>
          <button class="btn-drill-share" onclick="openDrillShareModal()">↗ Share to Feed</button>
          <span id="drill-save-status" style="font-family:DM Mono,monospace;font-size:11px;color:var(--muted);"></span>
        </div>
      </div>
      <div class="panel">
        <div class="panel-title">All-Time by Bed Type</div>
        <div style="display:flex;gap:8px;margin-bottom:16px;" id="drill-bed-filter">
          <button class="toggle-btn sel-single" style="flex:1" onclick="selectDrillView('single',this)">Single</button>
          <button class="toggle-btn" style="flex:1" onclick="selectDrillView('double',this)">Double</button>
          <button class="toggle-btn" style="flex:1" onclick="selectDrillView('treble',this)">Treble</button>
        </div>
        <table class="drill-summary-table" id="drill-alltime-table">
          <thead><tr><th>Target</th><th>Attempts</th><th>Hits</th><th>Rate</th><th>Top Miss</th></tr></thead>
          <tbody id="drill-alltime-tbody"></tbody>
        </table>
        <div id="drill-no-data" style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:16px;text-align:center;">No data yet for this bed type.</div>
      </div>
    </div>

  </div>
</div>

<!-- ═══════════════════ HISTORY PAGE ═══════════════════ -->
<div id="page-history" class="page">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
    <div style="font-family:Bebas Neue,sans-serif;font-size:22px;letter-spacing:3px;color:var(--muted);">SESSION HISTORY</div>
    <div style="display:flex;gap:8px;">
      <select id="history-filter" onchange="renderHistoryPage()" class="setup-select" style="min-width:120px;">
        <option value="all">All Sessions</option>
        <option value="501">501 Only</option>
        <option value="301">301 Only</option>
      </select>
    </div>
  </div>
  <div id="history-list">
    <div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);text-align:center;padding:40px;">No sessions yet — complete a practice session to see your history.</div>
  </div>
</div>

<!-- ═══════════════════ STATS PAGE ═══════════════════ -->
<div id="page-stats" class="page">
  <div class="stats-grid">
    <div class="stat-card"><label>Career Average</label><div class="big-num" id="stat-avg">—</div><div class="sub">per 3 darts</div></div>
    <div class="stat-card"><label>Checkout %</label><div class="big-num" id="stat-checkout">—</div><div class="sub">of attempts</div></div>
    <div class="stat-card"><label>Total Legs</label><div class="big-num" id="stat-legs">0</div><div class="sub">played</div></div>
    <div class="stat-card"><label>Sessions</label><div class="big-num" id="stat-sessions">0</div><div class="sub">logged</div></div>
  </div>

  <div class="two-col" style="margin-bottom:24px;">
    <div class="panel">
      <div class="panel-title">Score Trend</div>
      <div class="trend-chart"><canvas id="trend-canvas"></canvas></div>
      <div style="font-family:DM Mono,monospace;font-size:10px;color:var(--muted);text-align:center;margin-top:8px;letter-spacing:1px;">3-DART AVERAGE PER SESSION</div>
    </div>
    <div class="panel">
      <div class="panel-title">Session Log</div>
      <table class="history-table">
        <thead><tr><th>Date</th><th>Legs</th><th>Avg</th><th>CO%</th><th>Feel</th></tr></thead>
        <tbody id="session-tbody"></tbody>
      </table>
      <div id="no-sessions" style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:20px;text-align:center;display:none;">No sessions yet.</div>
    </div>
  </div>

  <div class="panel" style="margin-bottom:24px;">
    <div class="panel-title">Checkout Performance by Double</div>
    <div class="co-grid" id="co-doubles-grid"></div>
    <div id="co-insights"></div>
  </div>

  <div class="panel">
    <div class="panel-title">Checkout % Trend</div>
    <div id="co-trend-bars"></div>
  </div>

  <div class="panel" style="margin-top:24px;">
    <div class="panel-title">Cricket Summary</div>
    <div id="cricket-stats-panel"><div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:16px;text-align:center;">No cricket legs yet.</div></div>
  </div>
</div>

<!-- ═══════════════════ ANALYSIS PAGE ═══════════════════ -->
<div id="page-analysis" class="page">
  <div class="panel" style="margin-bottom:24px;">
    <div style="display:grid;grid-template-columns:auto 1fr;gap:28px;align-items:start;">
      <div>
        <div class="panel-title">Target Heat Map</div>
        <div style="margin-bottom:10px;">
          <div class="toggle-group g3" style="width:240px;" id="heatmap-bed-toggle">
            <button class="toggle-btn sel-single" onclick="selectHeatmapBed('single',this)">Single</button>
            <button class="toggle-btn" onclick="selectHeatmapBed('double',this)">Double</button>
            <button class="toggle-btn" onclick="selectHeatmapBed('treble',this)">Treble</button>
          </div>
        </div>
        <canvas id="heatmap-canvas" style="display:block;"></canvas>
        <div style="font-family:DM Mono,monospace;font-size:9px;color:var(--muted);margin-top:8px;letter-spacing:1px;text-align:center;">DRILL HIT RATE — BRIGHTER = BETTER</div>
      </div>
      <div>
        <div class="panel-title">Weak Spots</div>
        <div class="weak-spots" id="weak-spots-container">
          <div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);text-align:center;padding:20px;">Log 5+ throws per target to see weak spots.</div>
        </div>
      </div>
    </div>
  </div>

  <div class="two-col" style="margin-bottom:24px;">
    <div class="panel">
      <div class="panel-title">Miss Direction Analysis</div>
      <div id="miss-analysis" style="font-family:DM Mono,monospace;font-size:13px;color:var(--muted);line-height:2;">No miss data yet.</div>
    </div>
    <div class="panel">
      <div class="panel-title">Checkout Pressure</div>
      <div id="checkout-pressure" style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);line-height:2;">No checkout data yet.</div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Double Drill Breakdown</div>
    <div id="double-breakdown" style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:12px;">Log double drills to see breakdown.</div>
  </div>

  <div class="panel" style="margin-top:24px;">
    <div class="panel-title">Cricket Number Frequency</div>
    <div id="cricket-num-freq" style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:16px;text-align:center;">No cricket legs yet.</div>
  </div>
</div>

<!-- ═══════════════════ SOCIAL PAGE ═══════════════════ -->
<div id="page-home" class="page active">

  <!-- SIGN-IN GATE (shown when logged out) -->
  <div id="social-gate" class="social-gate hidden">
    <div class="gate-icon">🎯</div>
    <div class="gate-title">Join Bullboard Social</div>
    <div class="gate-sub">Sign in to share your sessions, follow other players, and see what the community is throwing.</div>
    <div style="font-family:DM Mono,monospace;font-size:11px;color:var(--muted);">Sign in using the header → then come back here.</div>
  </div>

  <!-- MAIN SOCIAL CONTENT (shown when logged in) -->
  <div id="social-content" class="social-layout hidden">

    <!-- LEFT SIDEBAR: Profile + Auto-post settings + Who to follow -->
    <div class="social-sidebar">
      <!-- Your profile card -->
      <div class="profile-card">
        <input type="file" id="avatar-file-input" accept="image/*" onchange="handleAvatarUpload(this)" />
        <div class="profile-avatar" id="social-avatar" onclick="document.getElementById('avatar-file-input').click()" title="Click to change photo">
          <span id="social-avatar-initials">?</span>
          <img id="social-avatar-img" src="" alt="" style="display:none" />
          <div class="avatar-edit-hint">Change</div>
        </div>
        <div class="profile-handle" id="social-handle">YOUR HANDLE</div>
        <div class="profile-sub" id="social-sub">Set up your profile</div>
        <div style="display:flex;gap:6px;margin-top:10px;">
          <input id="social-name-input" class="tag-input" style="margin:0;flex:1;font-size:11px;" placeholder="Display name / handle" />
          <button onclick="setSocialProfile()" style="background:var(--accent);color:#000;border:none;padding:6px 12px;font-family:DM Mono,monospace;font-size:11px;cursor:pointer;letter-spacing:1px;">SET</button>
        </div>
        <div class="profile-stats">
          <div class="profile-stat"><label>Avg</label><span id="social-p-avg">—</span></div>
          <div class="profile-stat"><label>Sessions</label><span id="social-p-sessions">0</span></div>
          <div class="profile-stat"><label>Following</label><span id="social-p-following">0</span></div>
          <div class="profile-stat"><label>Followers</label><span id="social-p-followers">—</span></div>
        </div>
      </div>

      <!-- Auto-post settings -->
      <div class="panel">
        <div class="panel-title">Auto-Post</div>
        <div id="auto-post-settings">
          <div class="auto-post-row">
            <span class="auto-post-icon">🎯</span>
            <div class="auto-post-info">180s
              <span>Auto-post when you score 180</span>
            </div>
            <div class="modal-share-toggle" id="ap-180" onclick="toggleAutoPost('180',this)"></div>
          </div>
          <div class="auto-post-row">
            <span class="auto-post-icon">🔥</span>
            <div class="auto-post-info">100+ Visits
              <span>Auto-post scores of 100 or more</span>
            </div>
            <div class="modal-share-toggle" id="ap-ton" onclick="toggleAutoPost('ton',this)"></div>
          </div>
          <div class="auto-post-row">
            <span class="auto-post-icon">✅</span>
            <div class="auto-post-info">High Checkouts
              <span>Auto-post checkouts above 100</span>
            </div>
            <div class="modal-share-toggle" id="ap-checkout" onclick="toggleAutoPost('checkout',this)"></div>
          </div>
          <div class="auto-post-row">
            <span class="auto-post-icon">📊</span>
            <div class="auto-post-info">Session Summary
              <span>Auto-post when ending a session</span>
            </div>
            <div class="modal-share-toggle" id="ap-session" onclick="toggleAutoPost('session',this)"></div>
          </div>
          <div class="auto-post-row">
            <span class="auto-post-icon">🎳</span>
            <div class="auto-post-info">Drill Sessions
              <span>Auto-post when saving drills</span>
            </div>
            <div class="modal-share-toggle" id="ap-drill" onclick="toggleAutoPost('drill',this)"></div>
          </div>
        </div>
      </div>

      <!-- Who to follow -->
      <div class="panel">
        <div class="panel-title">Who to Follow</div>
        <div class="follow-list" id="follow-list"></div>
      </div>
    </div>

    <!-- CENTER: Feed -->
    <div>
      <!-- Composer -->
      <div class="post-composer">
        <div class="composer-row">
          <div class="post-avatar" id="composer-avatar" style="background:var(--accent);color:#000;">?</div>
          <textarea class="composer-input" id="post-text" placeholder="Share a score, brag about a checkout, log a session..." rows="2"></textarea>
        </div>
        <div class="composer-actions">
          <button class="btn-share-session" onclick="shareLastSession()">📊 Share Last Session</button>
          <button class="btn-post" onclick="submitPost()">POST</button>
        </div>
      </div>

      <!-- Feed filters -->
      <div class="feed-filters">
        <button class="feed-filter active" onclick="setFeedFilter('all',this)">All</button>
        <button class="feed-filter" onclick="setFeedFilter('sessions',this)">Sessions</button>
        <button class="feed-filter" onclick="setFeedFilter('checkouts',this)">Checkouts</button>
        <button class="feed-filter" onclick="setFeedFilter('drills',this)">Drills</button>
        <button class="feed-filter" onclick="setFeedFilter('milestones',this)">Milestones</button>
      </div>

      <!-- Feed -->
      <div class="social-feed" id="social-feed">
        <div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);text-align:center;padding:40px;">No posts yet — be the first to share!</div>
      </div>
    </div>

    <!-- RIGHT SIDEBAR: Leaderboard -->
    <div class="social-sidebar">
      <div class="panel">
        <div class="panel-title">Leaderboard</div>
        <div id="leaderboard-list" style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:8px;">No data yet.</div>
      </div>
    </div>

  </div>
</div>

<!-- DRILL SHARE MODAL -->
<div id="drill-share-modal" class="modal-overlay hidden">
  <div class="modal">
    <div class="modal-title">Share Drill Session</div>
    <div id="drill-share-summary" style="margin-bottom:16px;"></div>
    <div class="modal-section-label">Caption (optional)</div>
    <textarea id="drill-share-text" class="tag-input" style="min-height:60px;resize:vertical;" placeholder="Add a note about your session..."></textarea>
    <div class="modal-btn-row">
      <button class="modal-btn-cancel" onclick="closeDrillShareModal()">Cancel</button>
      <button class="modal-btn-save" onclick="confirmDrillShare()" style="background:var(--accent4);color:#fff;">Share to Feed</button>
    </div>
  </div>
</div>

<script>
// Global auth state (set by Firebase module)
window._currentUser = null;

// ═══════════════════════════════════════════════════
//  STATE
// ═══════════════════════════════════════════════════
const DB_KEY = 'dartboard_v2';

function defaultState() {
  return {
    sessions: [],
    drillData: { single:{}, double:{}, treble:{} },
    cricketLegs: [],
  };
}

function loadState() {
  try {
    const s = JSON.parse(localStorage.getItem(DB_KEY));
    if (!s) return defaultState();
    if (!s.drillData || !s.drillData.single) {
      s.drillData = { single: s.drillData || {}, double:{}, treble:{} };
    }
    return s;
  } catch(e) { return defaultState(); }
}

function saveState() { localStorage.setItem(DB_KEY, JSON.stringify(state)); }
let state = loadState();
// Expose to Firebase module script
window.state = state;
window.saveState = saveState;

// ═══════════════════════════════════════════════════
//  LEG STATE
// ═══════════════════════════════════════════════════
let currentLeg = { score:501, startScore:501, throws:[], round:1, totalDarts:0, checkoutAttempts:0, checkouts:0, mode:'501', outMode:'double', feel:3 };
let inputVal = '';
let sessionLegs = [];

// ═══════════════════════════════════════════════════
//  DRILL STATE
// ═══════════════════════════════════════════════════
let drillBedType = 'single';
let drillDartCount = 3;
let selectedTarget = null;
let selectedMiss = null;
let currentAttemptResults = [];
let heatmapBedType = 'single';
let drillViewBed = 'single';
let drillSessionLog = []; // { target, bed, dartCount, result:'hit'|'miss', miss:dir|null }

const targets = ['20','19','18','17','16','15','14','13','12','11','10','9','8','7','6','5','4','3','2','1','Bull'];
document.getElementById('target-grid').innerHTML = targets.map(t =>
  `<button class="target-btn" onclick="selectTarget('${t}',this)">${t}</button>`
).join('');

// ═══════════════════════════════════════════════════
//  VOICE INPUT
// ═══════════════════════════════════════════════════
let recognition = null;
let voiceActive = false;
let voiceHelpVisible = false;

// Number word map
// ─── Voice score parser ────────────────────────────────────────────
// Converts spoken darts scores to numbers robustly.
// Handles: plain numbers ("140"), number words ("one forty"),
//          multipliers ("double 20", "treble 18"), bull, bust.

const _W = { // word → digit value
  oh:0, zero:0, nought:0, naught:0,
  one:1, two:2, three:3, four:4, five:5,
  six:6, seven:7, eight:8, nine:9,
  ten:10, eleven:11, twelve:12, thirteen:13, fourteen:14,
  fifteen:15, sixteen:16, seventeen:17, eighteen:18, nineteen:19,
  twenty:20, thirty:30, forty:40, fifty:50,
  sixty:60, seventy:70, eighty:80, ninety:90,
  hundred:100,
};

// Converts a string of mixed words/digits into a number, or null.
// e.g. "eighty one" → 81, "one forty" → 140, "180" → 180
// ─── Number word tables ──────────────────────────────────────────────
const _ONES = {
  zero:0, oh:0, nought:0, naught:0,
  one:1, two:2, three:3, four:4, five:5,
  six:6, seven:7, eight:8, nine:9,
  ten:10, eleven:11, twelve:12, thirteen:13, fourteen:14,
  fifteen:15, sixteen:16, seventeen:17, eighteen:18, nineteen:19
};
const _TENS = { twenty:20, thirty:30, forty:40, fifty:50, sixty:60, seventy:70, eighty:80, ninety:90 };
// All recognised number words (for whitelist validation)
const _ALL_NUM_WORDS = new Set([...Object.keys(_ONES), ...Object.keys(_TENS), 'hundred', 'and', 'a']);

// Converts a word string like "eighty one", "one forty", "one hundred and forty" into a number.
// Returns null if anything unrecognised is encountered.
function wordsToNum(s) {
  s = s.trim().toLowerCase().replace(/[–-]/g, ' ').replace(/\s+/g, ' ');

  // Pure digit string (with optional spaces like "1 8 0")
  const noSpace = s.replace(/\s+/g, '');
  if (/^\d+$/.test(noSpace)) {
    const n = parseInt(noSpace);
    return (n >= 0 && n <= 180) ? n : null;
  }

  // ── Darts shorthand: "one X" where X is a tens word → 100 + tens ──
  // e.g. "one forty" → 140, "one eighty" → 180, "one sixty" → 160
  const oneShorthand = s.match(/^one\s+(twenty|thirty|forty|fifty|sixty|seventy|eighty|ninety)(\s+(one|two|three|four|five|six|seven|eight|nine))?$/);
  if (oneShorthand) {
    const tens = _TENS[oneShorthand[1]];
    const ones = oneShorthand[3] ? (_ONES[oneShorthand[3]] || 0) : 0;
    const r = 100 + tens + ones;
    return (r <= 180) ? r : null;
  }

  // Reject anything containing a non-word-number token (e.g. "e1", "abc", "double")
  const tokens = s.split(/\s+/).filter(Boolean);
  for (const tok of tokens) {
    if (/^\d+$/.test(tok)) continue; // pure digit ok
    if (!_ALL_NUM_WORDS.has(tok)) return null; // unrecognised word → bail
  }

  // Parse: accumulate hundreds and tens+ones groups
  let h = 0; // hundreds
  let t2 = 0; // tens
  let o = 0;  // ones

  for (const tok of tokens) {
    if (tok === 'and' || tok === 'a') continue;
    if (/^\d+$/.test(tok)) {
      const d = parseInt(tok);
      if (d === 100) { h = (h || 1) * 100; }
      else if (d >= 10) { t2 = d; }
      else { o = d; }
      continue;
    }
    if (tok === 'hundred') { h = (h || t2 || o || 1) * 100; t2 = 0; o = 0; }
    else if (_TENS[tok] !== undefined) { t2 = _TENS[tok]; }
    else if (_ONES[tok] !== undefined) { o = _ONES[tok]; }
  }

  const result = h + t2 + o;
  return (result >= 0 && result <= 180) ? result : null;
}

// ─── Main voice score parser ─────────────────────────────────────────
// Accepts: "140", "one forty", "double 20", "treble eighteen", "bull", "bust"
// Rejects: "e1", "abc", anything with unrecognised non-number tokens
// Parse a single dart token like "treble twenty", "double 16", "single 5",
// "bull", "25". Returns the score value or null.
function parseSingleDart(tok) {
  tok = tok.trim().toLowerCase().replace(/\btriple\b/g, 'treble');

  // Bull variants
  if (/\b(bullseye|bulls?\s*eye|double\s*bull|inner\s*bull)\b/.test(tok)) return 50;
  if (/\b(outer\s*bull|single\s*bull|twenty[\s-]five)\b/.test(tok)) return 25;
  if (/\bbull\b/.test(tok) && !/\b(single)\b/.test(tok)) return 50;

  // "miss" or "no score" → 0
  if (/\b(miss|missed|no\s*score)\b/.test(tok)) return 0;

  // Multiplier + number: "treble twenty", "double 16", "single five", "double top"
  const mRe = /\b(single|double|treble)\s+(\w+)/;
  const m = tok.match(mRe);
  if (m) {
    const mult = m[1] === 'single' ? 1 : m[1] === 'double' ? 2 : 3;
    const word = m[2] === 'top' ? '20' : m[2];
    let num = null;
    if (/^\d+$/.test(word)) num = parseInt(word);
    else if (_ONES[word] !== undefined) num = _ONES[word];
    else if (_TENS[word] !== undefined) num = _TENS[word];
    if (num !== null && num >= 1 && num <= 25) {
      // Bull with double/treble
      if (num === 25) return mult === 2 ? 50 : 25;
      if (num <= 20) return num * mult;
    }
  }

  // Bare number word or digit (treated as single dart, no multiplier)
  const num = wordsToNum(tok);
  if (num !== null && num >= 0 && num <= 20) return num;

  return null;
}

// Try to parse as a three-dart sequence like:
// "treble twenty single five double sixteen"
// "twenty treble five single sixteen double"
// Returns total score or null if it doesn't look like 3-dart input.
function parseThreeDart(t) {
  // Must contain at least one multiplier word to be treated as 3-dart input
  if (!/\b(single|double|treble|triple)\b/.test(t)) return null;

  t = t.replace(/\btriple\b/g, 'treble');

  // Split on common separators / conjunctions
  // Segment the string into dart chunks by splitting on "and", comma, then
  // trying to identify contiguous (multiplier + number) or (number + multiplier) groups.
  // Strategy: tokenise and greedily consume dart tokens.
  const tokens = t.split(/\s+/);
  const darts = [];
  let i = 0;

  while (i < tokens.length && darts.length < 3) {
    const tok = tokens[i];

    // Skip filler
    if (/^(and|a|the|then|with|plus)$/.test(tok)) { i++; continue; }

    // Bull shorthand
    if (/^(bull|bullseye|bulls?eye)$/.test(tok)) { darts.push(50); i++; continue; }
    if (/^(miss|missed)$/.test(tok)) { darts.push(0); i++; continue; }

    // "double bull" / "treble bull"
    if (/^(double|treble)$/.test(tok) && tokens[i+1] && /^(bull|bullseye)/.test(tokens[i+1])) {
      darts.push(tok === 'double' ? 50 : 25);
      i += 2; continue;
    }

    // multiplier + number
    if (/^(single|double|treble)$/.test(tok) && tokens[i+1]) {
      const mult = tok === 'single' ? 1 : tok === 'double' ? 2 : 3;
      const word = tokens[i+1] === 'top' ? '20' : tokens[i+1];
      let num = /^\d+$/.test(word) ? parseInt(word) : (_ONES[word] !== undefined ? _ONES[word] : (_TENS[word] !== undefined ? _TENS[word] : null));
      if (num !== null && num >= 1 && num <= 20) {
        darts.push(num * mult); i += 2; continue;
      }
    }

    // number + multiplier (reversed order, e.g. "twenty treble")
    if (i + 1 < tokens.length && /^(single|double|treble)$/.test(tokens[i+1])) {
      const word = tok === 'top' ? '20' : tok;
      let num = /^\d+$/.test(word) ? parseInt(word) : (_ONES[word] !== undefined ? _ONES[word] : (_TENS[word] !== undefined ? _TENS[word] : null));
      if (num !== null && num >= 1 && num <= 20) {
        const mult = tokens[i+1] === 'single' ? 1 : tokens[i+1] === 'double' ? 2 : 3;
        darts.push(num * mult); i += 2; continue;
      }
    }

    // Bare number (single dart, no multiplier)
    const word = tok === 'top' ? '20' : tok;
    let num = /^\d+$/.test(word) ? parseInt(word) : (_ONES[word] !== undefined ? _ONES[word] : null);
    if (num !== null && num >= 0 && num <= 20) { darts.push(num); i++; continue; }

    // Unknown token — skip
    i++;
  }

  if (darts.length === 0) return null;
  const total = darts.reduce((s, v) => s + v, 0);
  return (total >= 0 && total <= 180) ? total : null;
}

function parseSpokenScore(raw) {
  if (!raw) return null;
  let t = raw.toLowerCase().trim();

  // ── Bust ──
  if (/\bbust\b/.test(t)) return { action: 'bust' };

  // ── Normalise ──
  t = t.replace(/\btriple\b/g, 'treble');

  // ── Bull alone ──
  if (/^(bull|bullseye|bulls?eye)$/.test(t)) return { action: 'score', score: 50 };

  // ── Three-dart input (contains single/double/treble) ──
  // Try this FIRST when multiplier words are present — it handles both
  // single-dart ("treble twenty") and full 3-dart ("treble twenty single five double sixteen")
  if (/\b(single|double|treble)\b/.test(t)) {
    const threeDartTotal = parseThreeDart(t);
    if (threeDartTotal !== null) return { action: 'score', score: threeDartTotal };
  }

  // ── Total score as words or digits ──
  const clean = t
    .replace(/\b(score|is|of|plus|point|points|uh|um|er|ah|right|ok|okay|so|i|got|scored|hit)\b/g, ' ')
    .replace(/\s+/g, ' ').trim();

  const n = wordsToNum(clean);
  if (n !== null) return { action: 'score', score: n };

  return null;
}

function parseVoiceScore(raw) { return parseSpokenScore(raw); }

function initVoice() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return false;

  recognition = new SpeechRecognition();
  recognition.lang = 'en-GB';
  recognition.interimResults = true;
  recognition.maxAlternatives = 3;
  recognition.continuous = false;

  recognition.onstart = () => {
    voiceActive = true;
    const btn = document.getElementById('voice-btn');
    if (btn) btn.classList.add('listening');
    document.getElementById('input-display').classList.add('voice-active');
    setTranscript('Listening…', '');
  };

  recognition.onresult = (e) => {
    const results = e.results[e.results.length - 1];
    const interim = results[0].transcript;
    setTranscript(interim, 'heard');

    if (results.isFinal) {
      // Try all alternatives
      let parsed = null;
      for (let i = 0; i < results.length; i++) {
        const raw = results[i].transcript;
        parsed = parseVoiceScore(raw);
        if (parsed) break;
      }

      if (parsed) {
        setTranscript('"' + results[0].transcript + '" → ' + (parsed.action === 'bust' ? 'BUST' : parsed.score), 'parsed');
        if (parsed.action === 'bust') {
          bustScore(true);
        } else {
          // Show score in input display briefly, then submit directly
          inputVal = String(parsed.score);
          updateInputDisplay();
          processThrow(parsed.score, false, true);
        }
      } else {
        setTranscript(`Didn't catch that — try again`, 'heard');
        toast(`Didn't understand: "${results[0].transcript}"`, true);
      }
    }
  };

  recognition.onerror = (e) => {
    voiceActive = false;
    const btn = document.getElementById('voice-btn');
    if (btn) btn.classList.remove('listening');
    document.getElementById('input-display').classList.remove('voice-active');
    if (e.error !== 'no-speech' && e.error !== 'aborted') {
      setTranscript('Mic error — check browser permissions', 'heard');
    } else {
      setTranscript('', '');
    }
  };

  recognition.onend = () => {
    voiceActive = false;
    const btn = document.getElementById('voice-btn');
    if (btn) btn.classList.remove('listening');
    document.getElementById('input-display').classList.remove('voice-active');
  };

  return true;
}

function setTranscript(text, cls) {
  const el = document.getElementById('voice-transcript');
  el.textContent = text;
  el.className = 'voice-transcript' + (cls ? ' '+cls : '');
}

function toggleVoice() {
  if (!recognition) {
    const ok = initVoice();
    if (!ok) { toast('Voice not supported in this browser', true); return; }
  }

  if (voiceActive) {
    recognition.stop();
    return;
  }

  // Toggle help text on first click
  if (!voiceHelpVisible) {
    voiceHelpVisible = true;
    document.getElementById('voice-help').classList.add('visible');
  }

  try {
    recognition.start();
  } catch(e) {
    recognition = null;
    initVoice();
    try { recognition.start(); } catch(e2) { toast('Voice error — try again', true); }
  }
}

// ═══════════════════════════════════════════════════
//  NAV
// ═══════════════════════════════════════════════════
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  btn.classList.add('active');
  if (name === 'stats') renderStats();
  if (name === 'history') renderHistoryPage();
  if (name === 'analysis') renderAnalysis();
  if (name === 'drill') renderDrillPage();
  if (name === 'home') renderSocialPage();
  // Update logo subtitle
  const subtitles = {
    practice: 'PRACTICE',
    drill: 'DRILLS',
    stats: 'STATS',
    analysis: 'ANALYSIS',
    history: 'HISTORY',
    home: 'HOME',
  };
  const sub = document.querySelector('.logo span');
  if (sub) sub.textContent = '// ' + (subtitles[name] || name.toUpperCase());
}

// ═══════════════════════════════════════════════════
//  SCORING
// ═══════════════════════════════════════════════════
function numPress(n) { if (inputVal.length >= 3) return; inputVal += n; updateInputDisplay(); }
function numDel() { inputVal = inputVal.slice(0,-1); updateInputDisplay(); }
function updateInputDisplay() {
  document.getElementById('input-display').innerHTML = `${inputVal || ''}<span class="cursor"></span>`;
}

function submitScore(fromVoice) {
  const val = parseInt(inputVal);
  if (isNaN(val) || val < 0 || val > 180) { toast('Invalid score (0–180)', true); return; }
  processThrow(val, false, fromVoice);
}
function bustScore(fromVoice) { processThrow(parseInt(inputVal)||0, true, fromVoice); }

function processThrow(score, bust, fromVoice) {
  const remaining = currentLeg.score - score;

  if (bust || remaining < 0 || (remaining === 1 && currentLeg.outMode === 'double')) {
    currentLeg.throws.push({ score, remaining: currentLeg.score, bust: true });
    addThrowRow(score, currentLeg.score, true, false, fromVoice);
    toast('BUST — score unchanged');
    updateScoreDisplays(currentLeg.score);
    scheduleBotTurn01();
  } else if (remaining === 0) {
    currentLeg.checkoutAttempts++;
    currentLeg.checkouts++;
    currentLeg.score = 0;
    currentLeg.totalDarts += 3;
    currentLeg.throws.push({ score, remaining:0, bust:false, checkout:true });
    addThrowRow(score, 0, false, true, fromVoice);
    updateScoreDisplays(0);
    toast('🎯 CHECKOUT! Leg complete — YOU WIN!');
    if (typeof maybeAutoPostCheckout === 'function') maybeAutoPostCheckout(score);
    hideBotStatus();
    setTimeout(() => completeLeg(), 800);
  } else {
    currentLeg.score = remaining;
    currentLeg.totalDarts += 3;
    currentLeg.round++;
    currentLeg.throws.push({ score, remaining, bust:false });
    addThrowRow(score, remaining, false, false, fromVoice);
    updateScoreDisplays(remaining);
    updateMeta();
    if (typeof maybeAutoPostTon === 'function') maybeAutoPostTon(score);
    scheduleBotTurn01();
  }
  inputVal = ''; updateInputDisplay();
  if (!fromVoice) setTranscript('', '');
}

function scheduleBotTurn01() {
  const botLvl = parseInt(document.getElementById('bot-level').value) || 0;
  if (!botLvl) return;
  // Disable input while bot "thinks"
  const numpad = document.querySelector('.numpad');
  const submitArea = document.querySelector('.input-row');
  if (numpad) numpad.style.opacity = '0.35';
  if (submitArea) submitArea.style.pointerEvents = 'none';
  setTimeout(function() { runBot01Turn(botLvl, numpad, submitArea); }, 900);
}

function runBot01Turn(botLvl, numpad, submitArea) {
  const p = BOT_PROFILES[botLvl];
  if (!p) return restoreInput(numpad, submitArea);

  // Init bot score if needed
  if (!currentLeg._botScore) currentLeg._botScore = currentLeg.startScore;

  const result = runBotTurn(botLvl, currentLeg._botScore);
  if (!result) return restoreInput(numpad, submitArea);

  currentLeg._botScore = result.remaining;

  let msg = '';
  if (result.bust) {
    msg = 'BUST — still on ' + currentLeg._botScore;
  } else if (result.checkout) {
    msg = 'CHECKOUT! 🎯 — Bot wins!';
    showBotStatus(msg);
    restoreInput(numpad, submitArea);
    // Briefly flash 0 on bot score
    const botNumEl = document.getElementById('score-display-bot');
    if (botNumEl) { botNumEl.textContent = '0'; botNumEl.style.color = 'var(--accent3)'; }
    setTimeout(function() {
      toast(p.name + ' checked out! New leg starting…');
      hideBotStatus();
      currentLeg._botScore = null;
      newLeg();
    }, 1800);
    return;
  } else {
    msg = 'threw ' + result.score + ' · ' + result.remaining + ' left';
  }

  showBotStatus(msg);
  restoreInput(numpad, submitArea);
}

function showBotStatus(msg) {
  // Update the bot score number and last-throw sub-label in the dual display
  const botScore = currentLeg && currentLeg._botScore != null ? currentLeg._botScore : (currentLeg ? currentLeg.startScore : 501);
  const botNumEl = document.getElementById('score-display-bot');
  if (botNumEl) botNumEl.textContent = botScore;
  const botSub = document.getElementById('score-vs-sub-bot');
  if (botSub) {
    // Show last throw info (strip name prefix for brevity)
    const info = msg.replace(/^[^·\-]+(·|—)\s*/, '').split('·')[0].trim();
    botSub.textContent = info.length > 30 ? info.slice(0, 30) + '…' : info;
    botSub.style.color = msg.includes('CHECKOUT') ? 'var(--accent3)' : msg.includes('BUST') ? 'var(--accent2)' : 'var(--dim)';
  }
  const botSubLabel = document.getElementById('score-vs-sub-bot');
  if (botNumEl && botScore <= 170 && botScore > 1) {
    botNumEl.style.color = 'rgba(167,139,250,0.6)';  // dim slightly when in range
  } else if (botNumEl) {
    botNumEl.style.color = '';
  }
}
function hideBotStatus() {
  // Reset bot sub-label on new leg
  const sub = document.getElementById('score-vs-sub-bot');
  if (sub) { sub.textContent = ''; sub.style.color = ''; }
  const botNumEl = document.getElementById('score-display-bot');
  if (botNumEl) botNumEl.style.color = '';
}
function restoreInput(numpad, submitArea) {
  if (numpad) numpad.style.opacity = '';
  if (submitArea) submitArea.style.pointerEvents = '';
}

function addThrowRow(score, remaining, bust, checkout, fromVoice) {
  const hist = document.getElementById('throw-history');
  const throwIdx = currentLeg.throws.length - 1; // 0-based index (throw already pushed before addThrowRow)
  const displayIdx = throwIdx + 1;
  const isTon = score >= 100;
  let badge = '';
  if (bust) badge = '<span class="throw-badge bust">BUST</span>';
  else if (checkout) badge = '<span class="throw-badge checkout">CHECKOUT</span>';
  else if (isTon) badge = '<span class="throw-badge ton">TON</span>';
  if (fromVoice) badge += '<span class="throw-badge voice">🎙</span>';

  // Edit button — hidden unless hovering; not shown on checkout rows
  const editBtn = checkout ? '' : `<button class="throw-edit-btn" onclick="openEditThrow(${throwIdx}, this)" title="Edit this score">EDIT</button>`;

  const row = document.createElement('div');
  row.className = `throw-row ${bust?'bust':''} ${checkout?'checkout':''}`.trim();
  row.dataset.throwIdx = throwIdx;
  row.innerHTML = `<span class="throw-num">${displayIdx}</span><span class="throw-score">${score}</span><span class="throw-remaining">${bust?'—':remaining+' left'}</span>${badge}${editBtn}`;
  hist.insertBefore(row, hist.firstChild);
}

function updateMeta() {
  const scored = currentLeg.startScore - currentLeg.score;
  const avg = currentLeg.totalDarts > 0 ? ((scored/currentLeg.totalDarts)*3).toFixed(1) : '—';
  document.getElementById('round-num').textContent = currentLeg.round;
  document.getElementById('avg-display').textContent = avg;
  document.getElementById('dart-count').textContent = currentLeg.totalDarts;
  document.getElementById('leg-counter').textContent = `LEG ${sessionLegs.length+1} · ${currentLeg.mode}`;
}

function completeLeg() {
  const scored = currentLeg.startScore - currentLeg.score;
  const avg = currentLeg.totalDarts > 0 ? (scored/currentLeg.totalDarts)*3 : 0;
  sessionLegs.push({ score:currentLeg.startScore, darts:currentLeg.totalDarts, avg:avg.toFixed(1), checkouts:currentLeg.checkouts, checkoutAttempts:currentLeg.checkoutAttempts, throws:[...currentLeg.throws], timestamp:Date.now() });
  hideBotStatus();
  newLeg();
}

function newLeg() {
  const mode = document.getElementById('game-mode').value;
  if (mode === 'cricket') { newCricketLeg(); return; }
  // 01 games — read start score directly from dropdown
  const startScore = mode === '501' ? 501 : 301;
  const botLvl01 = parseInt(document.getElementById('bot-level').value) || 0;
  currentLeg = { score:startScore, startScore, throws:[], round:1, totalDarts:0, checkoutAttempts:0, checkouts:0, mode, outMode:document.getElementById('out-mode').value, feel:currentLeg.feel||3, _botScore: botLvl01 ? startScore : null };
  if (botLvl01) {
    const p = BOT_PROFILES[botLvl01];
    showBotStatus((p ? p.name : 'Bot') + ' is ready — ' + startScore + ' to start. Your throw first!');
  } else {
    hideBotStatus();
  }
  document.getElementById('throw-history').innerHTML = '';
  inputVal = ''; updateInputDisplay(); updateMeta();
  document.getElementById('leg-counter').textContent = 'LEG ' + (sessionLegs.length+1) + ' · ' + mode;
  updateScoreDisplays(startScore);
  toast('New leg — ' + mode);
}

function setFeel(n, btn) {
  currentLeg.feel = n;
  document.querySelectorAll('.feel-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

// ── Session End Modal ──
let modalSessionFeel = 3;
let modalShareEnabled = false;

function openEndSessionModal() {
  if (sessionLegs.length === 0) { toast('No legs completed yet!', true); return; }
  const totalAvg = sessionLegs.reduce((s,l)=>s+parseFloat(l.avg),0) / sessionLegs.length;
  const totalCO = sessionLegs.reduce((s,l)=>s+l.checkouts,0);
  const totalCOAtt = sessionLegs.reduce((s,l)=>s+l.checkoutAttempts,0);
  const coPct = totalCOAtt>0 ? ((totalCO/totalCOAtt)*100).toFixed(0) : '—';

  document.getElementById('modal-legs').textContent = sessionLegs.length;
  document.getElementById('modal-avg').textContent = totalAvg.toFixed(1);
  document.getElementById('modal-co').textContent = coPct === '—' ? '—' : coPct + '%';

  // Sync feel from current leg
  modalSessionFeel = currentLeg.feel || 3;
  document.querySelectorAll('#modal-feel-btns .feel-btn').forEach((b,i) => {
    b.classList.toggle('active', i+1 === modalSessionFeel);
  });

  // Pre-fill notes
  document.getElementById('modal-session-notes').value = document.getElementById('session-notes').value;

  // Share toggle
  modalShareEnabled = false;
  document.getElementById('modal-share-toggle').classList.remove('on');
  document.getElementById('modal-share-text').style.display = 'none';

  document.getElementById('session-end-modal').classList.remove('hidden');
}

function closeEndSessionModal() {
  document.getElementById('session-end-modal').classList.add('hidden');
}

function setModalFeel(n, btn) {
  modalSessionFeel = n;
  document.querySelectorAll('#modal-feel-btns .feel-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

function toggleModalShare() {
  modalShareEnabled = !modalShareEnabled;
  const toggle = document.getElementById('modal-share-toggle');
  const textArea = document.getElementById('modal-share-text');
  if (modalShareEnabled) {
    toggle.classList.add('on');
    textArea.style.display = 'block';
    // Auto-populate caption
    const totalAvg = sessionLegs.reduce((s,l)=>s+parseFloat(l.avg),0) / sessionLegs.length;
    const totalCO = sessionLegs.reduce((s,l)=>s+l.checkouts,0);
    const totalCOAtt = sessionLegs.reduce((s,l)=>s+l.checkoutAttempts,0);
    const coPct = totalCOAtt>0 ? ((totalCO/totalCOAtt)*100).toFixed(0) + '%' : '—';
    const feel = ['','😩','😕','😐','🙂','🔥'][modalSessionFeel] || '';
    textArea.value = 'Session done — avg ' + totalAvg.toFixed(1) + ', ' + sessionLegs.length + ' leg' + (sessionLegs.length!==1?'s':'') + ', ' + coPct + ' checkout ' + feel;
  } else {
    toggle.classList.remove('on');
    textArea.style.display = 'none';
  }
}

function confirmEndSession() {
  const totalAvg = sessionLegs.reduce((s,l)=>s+parseFloat(l.avg),0) / sessionLegs.length;
  const totalCO = sessionLegs.reduce((s,l)=>s+l.checkouts,0);
  const totalCOAtt = sessionLegs.reduce((s,l)=>s+l.checkoutAttempts,0);
  const notes = document.getElementById('modal-session-notes').value;
  const sessionData = {
    date: new Date().toLocaleDateString('en-GB',{day:'numeric',month:'short'}),
    timestamp: Date.now(),
    legs: sessionLegs.length,
    avg: totalAvg.toFixed(1),
    checkoutPct: totalCOAtt>0 ? ((totalCO/totalCOAtt)*100).toFixed(0) : 0,
    checkouts: totalCO,
    checkoutAttempts: totalCOAtt,
    feel: modalSessionFeel,
    notes: notes,
    legDetails: sessionLegs.map(l => ({ score:l.score, darts:l.darts, avg:l.avg, checkouts:l.checkouts, checkoutAttempts:l.checkoutAttempts })),
  };
  state.sessions.push(sessionData);
  saveState();
  if (typeof window.saveSessionToFirebase === 'function') {
    window.saveSessionToFirebase(sessionData);
  }
  // Share to social if toggled
  if (modalShareEnabled && window._currentUser) {
    const caption = document.getElementById('modal-share-text').value.trim();
    const coPct = totalCOAtt>0 ? ((totalCO/totalCOAtt)*100).toFixed(0) + '%' : '—';
    publishPost('session', caption, [
      {l:'Avg', v:totalAvg.toFixed(1)},
      {l:'Legs', v:String(sessionLegs.length)},
      {l:'CO%',  v:coPct},
      {l:'Feel', v:(['','😩','😕','😐','🙂','🔥'][modalSessionFeel]||'')},
    ]);
    toast('✓ Session saved & shared!');
  } else {
    // Check auto-post
    if (window._currentUser && socialState.autoPost.session) {
      const coPct = totalCOAtt>0 ? ((totalCO/totalCOAtt)*100).toFixed(0) + '%' : '—';
      const feel = ['','😩','😕','😐','🙂','🔥'][modalSessionFeel] || '';
      publishPost('session', 'Session done — avg ' + totalAvg.toFixed(1) + ', ' + sessionLegs.length + ' legs, ' + coPct + ' checkout ' + feel, [
        {l:'Avg',v:totalAvg.toFixed(1)},{l:'Legs',v:String(sessionLegs.length)},{l:'CO%',v:coPct}
      ]);
    }
    toast('✓ Session saved!');
  }
  sessionLegs = [];
  document.getElementById('session-notes').value = '';
  closeEndSessionModal();
  newLeg();
}

function endSession() {
  openEndSessionModal();
}

function saveDrillSession() {
  if (drillSessionLog.length === 0) { toast('No drill throws logged yet!', true); return; }
  if (typeof window.saveDrillSessionToFirebase === 'function') {
    window.saveDrillSessionToFirebase(drillSessionLog, state.drillData);
  } else {
    toast('Sign in to save drill sessions to the cloud', true);
  }
  // Auto-post if enabled
  if (window._currentUser && socialState.autoPost.drill) {
    const groups = {};
    drillSessionLog.forEach(function(e) {
      const key = e.bed + ':' + e.target;
      if (!groups[key]) groups[key] = { bed:e.bed, target:e.target, hits:0, total:0 };
      groups[key].total++;
      if (e.result==='hit') groups[key].hits++;
    });
    const pfx = function(bed) { return bed==='double'?'D':bed==='treble'?'T':''; };
    const stats = Object.values(groups).map(function(g) {
      return { l: pfx(g.bed) + g.target, v: Math.round(g.hits/g.total*100) + '%' };
    });
    const total = drillSessionLog.length;
    const hits = drillSessionLog.filter(function(e){return e.result==='hit';}).length;
    publishPost('drill', 'Drill session — ' + hits + '/' + total + ' (' + Math.round(hits/total*100) + '%) across ' + Object.keys(groups).length + ' targets.', stats, '#a78bfa');
    toast('Drill session auto-posted!');
  }
}

// ═══════════════════════════════════════════════════
//  DRILL TRACKER
// ═══════════════════════════════════════════════════
function selectBedType(type, btn) {
  drillBedType = type;
  document.querySelectorAll('#bed-toggle .toggle-btn').forEach(b => b.className = 'toggle-btn');
  btn.className = `toggle-btn sel-${type}`;
  resetAttemptRound();
  updateDrillStats();
}

function selectDartCount(n, btn) {
  drillDartCount = n;
  document.querySelectorAll('#darts-toggle .toggle-btn').forEach(b => b.className = 'toggle-btn');
  btn.className = 'toggle-btn sel-darts';
  resetAttemptRound();
  updateAttemptDots();
}

function selectTarget(t, btn) {
  selectedTarget = t;
  document.querySelectorAll('.target-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  resetAttemptRound();
  updateDrillStats();
}

function selectMiss(dir, btn) {
  selectedMiss = selectedMiss === dir ? null : dir;
  document.querySelectorAll('.miss-btn').forEach(b => b.classList.remove('selected'));
  if (selectedMiss) btn.classList.add('selected');
}

function resetAttemptRound() {
  currentAttemptResults = [];
  updateAttemptDots();
}

function updateAttemptDots() {
  const prog = document.getElementById('attempt-progress');
  const label = document.getElementById('attempt-label');

  if (!selectedTarget) {
    label.textContent = 'Select a target to begin';
    prog.innerHTML = '';
    return;
  }

  const prefix = drillBedType==='double'?'D':drillBedType==='treble'?'T':'';
  const done = currentAttemptResults.length;
  const total = drillDartCount;
  const dartWord = total===1?'1-dart':'3-dart';
  label.textContent = `${prefix}${selectedTarget} · ${dartWord} · ${done}/${total}`;

  prog.innerHTML = Array.from({length:total}, (_,i) => {
    let cls = 'attempt-dot';
    if (i < done) cls += currentAttemptResults[i]==='hit' ? ' done-hit' : ' done-miss';
    else if (i === done) cls += ' current';
    return `<div class="${cls}"></div>`;
  }).join('');
}

function logDrill(result) {
  if (!selectedTarget) { toast('Select a target first', true); return; }

  if (!state.drillData[drillBedType][selectedTarget]) {
    state.drillData[drillBedType][selectedTarget] = { hits:0, attempts:0, misses:{left:0,right:0,high:0,low:0} };
  }

  const d = state.drillData[drillBedType][selectedTarget];
  d.attempts++;
  if (result==='hit') d.hits++;
  else if (selectedMiss) d.misses[selectedMiss]++;

  // Log to session
  drillSessionLog.push({ target:selectedTarget, bed:drillBedType, result, miss: result==='miss'?selectedMiss:null });

  currentAttemptResults.push(result);
  selectedMiss = null;
  document.querySelectorAll('.miss-btn').forEach(b => b.classList.remove('selected'));

  updateAttemptDots();
  saveState();
  updateDrillStats();
  renderDrillSessionLog();

  const prefix = drillBedType==='double'?'D':drillBedType==='treble'?'T':'';
  toast(result==='hit' ? `✓ Hit ${prefix}${selectedTarget}` : `✗ Miss ${prefix}${selectedTarget}`);

  if (currentAttemptResults.length >= drillDartCount) {
    setTimeout(() => advanceTarget(), 350);
  }
}

function advanceTarget() {
  const idx = targets.indexOf(selectedTarget);
  if (idx === -1 || idx >= targets.length-1) { resetAttemptRound(); return; }
  const nextTarget = targets[idx+1];
  document.querySelectorAll('.target-btn').forEach(b => {
    if (b.textContent === nextTarget) b.click();
  });
}

function updateDrillStats() {
  const el = document.getElementById('drill-stats-display');
  if (!selectedTarget) { el.innerHTML = 'Select a target and start throwing.'; return; }

  const prefix = drillBedType==='double'?'D':drillBedType==='treble'?'T':'';
  const d = state.drillData[drillBedType][selectedTarget];

  if (!d || d.attempts===0) {
    el.innerHTML = `<span style="color:var(--text)">${prefix}${selectedTarget}</span> — No data yet`;
    return;
  }

  const pct = ((d.hits/d.attempts)*100).toFixed(0);
  const col = parseInt(pct)>=60?'var(--accent3)':parseInt(pct)>=35?'var(--accent)':'var(--accent2)';
  const missE = Object.entries(d.misses).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`${k}:${v}`).join(' · ');

  el.innerHTML = `
    <span style="color:var(--accent);font-size:15px;font-family:Bebas Neue,sans-serif;letter-spacing:2px">${prefix}${selectedTarget}</span>
    &nbsp;—&nbsp;Hit: <span style="color:${col};font-size:15px">${pct}%</span>
    <span style="color:var(--muted)">(${d.hits}/${d.attempts})</span>
    ${missE ? `<br>Misses: <span style="color:var(--accent2)">${missE}</span>` : ''}
  `;
}

// ── DRILL PAGE RENDERS ──
function renderDrillPage() {
  renderDrillSessionLog();
  renderDrillAlltimeTable();
}

function renderDrillSessionLog() {
  const el = document.getElementById('drill-session-log');
  if (drillSessionLog.length === 0) {
    el.innerHTML = '<span style="color:var(--muted)">No throws logged yet.</span>';
    return;
  }

  // Group by target+bed and tally
  const groups = {};
  drillSessionLog.forEach(e => {
    const key = `${e.bed}:${e.target}`;
    if (!groups[key]) groups[key] = { bed:e.bed, target:e.target, hits:0, total:0 };
    groups[key].total++;
    if (e.result==='hit') groups[key].hits++;
  });

  el.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:6px;">
    ${Object.values(groups).map(g=>{
      const prefix=g.bed==='double'?'D':g.bed==='treble'?'T':'';
      const pct=Math.round(g.hits/g.total*100);
      const col=pct>=60?'var(--accent3)':pct>=35?'var(--accent)':'var(--accent2)';
      return `<div style="background:var(--surface2);border:1px solid var(--border);padding:8px 12px;font-family:DM Mono,monospace;">
        <div style="font-family:Bebas Neue,sans-serif;font-size:18px;color:${col}">${prefix}${g.target}</div>
        <div style="font-size:11px;color:${col}">${pct}%</div>
        <div style="font-size:10px;color:var(--muted)">${g.hits}/${g.total}</div>
      </div>`;
    }).join('')}
  </div>`;
}

function selectDrillView(bed, btn) {
  drillViewBed = bed;
  document.querySelectorAll('#drill-bed-filter .toggle-btn').forEach(b => b.className = 'toggle-btn');
  btn.className = `toggle-btn sel-${bed}`;
  renderDrillAlltimeTable();
}

function renderDrillAlltimeTable() {
  const tbody = document.getElementById('drill-alltime-tbody');
  const noData = document.getElementById('drill-no-data');
  const data = state.drillData[drillViewBed];

  const rows = Object.entries(data)
    .filter(([,d]) => d.attempts > 0)
    .sort((a,b) => {
      // Sort by target number (natural order)
      const ai = targets.indexOf(a[0]);
      const bi = targets.indexOf(b[0]);
      return ai - bi;
    });

  if (rows.length === 0) {
    tbody.innerHTML = '';
    noData.style.display = 'block';
    return;
  }

  noData.style.display = 'none';
  const prefix = drillViewBed==='double'?'D':drillViewBed==='treble'?'T':'';

  tbody.innerHTML = rows.map(([t, d]) => {
    const pct = Math.round(d.hits/d.attempts*100);
    const cls = pct>=60?'rate-great':pct>=35?'rate-ok':'rate-bad';
    const topMiss = Object.entries(d.misses).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1])[0];
    const missStr = topMiss ? `${topMiss[0]} (${topMiss[1]})` : '—';
    return `<tr>
      <td style="font-family:Bebas Neue,sans-serif;font-size:18px;letter-spacing:1px">${prefix}${t}</td>
      <td>${d.attempts}</td>
      <td>${d.hits}</td>
      <td class="${cls}">${pct}%</td>
      <td style="color:var(--muted)">${missStr}</td>
    </tr>`;
  }).join('');
}

// ═══════════════════════════════════════════════════
//  STATS PAGE
// ═══════════════════════════════════════════════════
function renderStats() {
  const sessions = state.sessions;

  if (sessions.length===0) {
    document.getElementById('no-sessions').style.display='block';
    document.getElementById('session-tbody').innerHTML='';
    document.getElementById('stat-avg').textContent='—';
    document.getElementById('stat-checkout').textContent='—';
    document.getElementById('stat-legs').textContent='0';
    document.getElementById('stat-sessions').textContent='0';
    renderTrendChart([]);
    renderCheckoutDoubles();
    renderCheckoutTrend();
    return;
  }

  document.getElementById('no-sessions').style.display='none';
  const totalLegs = sessions.reduce((s,ses)=>s+ses.legs,0);
  const avgAvg = (sessions.reduce((s,ses)=>s+parseFloat(ses.avg),0)/sessions.length).toFixed(1);
  const avgCO = (sessions.reduce((s,ses)=>s+parseFloat(ses.checkoutPct),0)/sessions.length).toFixed(0);

  document.getElementById('stat-avg').textContent=avgAvg;
  document.getElementById('stat-checkout').textContent=avgCO+'%';
  document.getElementById('stat-legs').textContent=totalLegs;
  document.getElementById('stat-sessions').textContent=sessions.length;

  document.getElementById('session-tbody').innerHTML=[...sessions].reverse().map(s=>{
    const co=parseInt(s.checkoutPct);
    return `<tr>
      <td>${s.date}</td><td>${s.legs}</td>
      <td class="${parseFloat(s.avg)>=55?'good':''}">${s.avg}</td>
      <td class="${co>=50?'good':co>=30?'med':'bad'}">${s.checkoutPct}%</td>
      <td>${['','😩','😕','😐','🙂','🔥'][s.feel]}</td>
    </tr>`;
  }).join('');

  renderTrendChart(sessions.map(s=>parseFloat(s.avg)));
  renderCheckoutDoubles();
  renderCheckoutTrend();
  renderCricketStats();
}

function renderCricketStats() {
  var legs = state.cricketLegs || [];
  var container = document.getElementById('cricket-stats-panel');
  if (!container) return;
  if (legs.length === 0) {
    container.innerHTML = '<div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:16px;text-align:center;">No cricket legs yet.</div>';
    return;
  }
  var wins = legs.filter(function(l) { return l.youWon; }).length;
  var pct = Math.round(wins / legs.length * 100);
  var avgScore = Math.round(legs.reduce(function(s,l){return s+l.yourScore;},0) / legs.length);
  var botGames = legs.filter(function(l){return l.botLevel > 0;});
  var winVsBot = botGames.filter(function(l){return l.youWon;}).length;

  // Aggregate hit marks + misses per number
  var accuracy = {};
  CRICKET_NUMS.forEach(function(n) { accuracy[String(n)] = { hits: 0, misses: 0 }; });
  legs.forEach(function(leg) {
    CRICKET_NUMS.forEach(function(n) {
      var key = String(n);
      accuracy[key].hits += (leg.marks && leg.marks[key]) || 0;
      accuracy[key].misses += (leg.misses && leg.misses[key]) || 0;
    });
  });
  var totalMisses = Object.values(accuracy).reduce(function(s,v){return s+v.misses;}, 0);

  var html = '<div class="stats-grid" style="grid-template-columns:repeat(4,1fr);margin-bottom:' + (totalMisses>0?'16':'0') + 'px;">'
    + '<div class="stat-card"><label>Cricket Legs</label><div class="big-num">' + legs.length + '</div><div class="sub">played</div></div>'
    + '<div class="stat-card"><label>Win Rate</label><div class="big-num" style="color:' + (pct>=50?'var(--accent3)':'var(--accent2)') + '">' + pct + '%</div><div class="sub">of legs</div></div>'
    + '<div class="stat-card"><label>Avg Points</label><div class="big-num">' + avgScore + '</div><div class="sub">per leg</div></div>'
    + '<div class="stat-card"><label>vs Bot Wins</label><div class="big-num">' + winVsBot + '</div><div class="sub">of ' + botGames.length + '</div></div>'
    + '</div>';

  if (totalMisses > 0) {
    html += '<div style="font-family:DM Mono,monospace;font-size:9px;letter-spacing:2px;color:var(--muted);text-transform:uppercase;margin-bottom:8px;">Accuracy by number</div>'
      + '<div style="display:grid;grid-template-columns:repeat(7,1fr);gap:4px;">';
    CRICKET_NUMS.forEach(function(n) {
      var key = String(n);
      var a = accuracy[key];
      var total = a.hits + a.misses;
      var label = n === 'B' ? 'Bull' : n;
      if (total === 0) {
        html += '<div style="background:var(--surface2);border:1px solid var(--border);padding:8px 4px;text-align:center;">'
          + '<div style="font-family:Bebas Neue,sans-serif;font-size:18px;color:var(--muted);">' + label + '</div>'
          + '<div style="font-size:10px;color:var(--dim);margin-top:2px;">—</div></div>';
      } else {
        var hitPct = Math.round(a.hits / total * 100);
        var col = hitPct >= 70 ? 'var(--accent3)' : hitPct >= 40 ? 'var(--accent)' : 'var(--accent2)';
        html += '<div style="background:var(--surface2);border:1px solid var(--border);padding:8px 4px;text-align:center;">'
          + '<div style="font-family:Bebas Neue,sans-serif;font-size:18px;color:var(--text);">' + label + '</div>'
          + '<div style="font-size:13px;font-weight:600;color:' + col + ';font-family:Bebas Neue,sans-serif;">' + hitPct + '%</div>'
          + '<div style="font-size:9px;color:var(--muted);font-family:DM Mono,monospace;">' + a.hits + 'h·' + a.misses + 'm</div>'
          + '<div style="height:3px;background:var(--border);margin-top:4px;border-radius:1px;">'
          + '<div style="height:3px;width:' + hitPct + '%;background:' + col + ';transition:width 0.3s;"></div></div>'
          + '</div>';
      }
    });
    html += '</div>';
  }
  container.innerHTML = html;
}


function renderCheckoutDoubles() {
  const doubleNums=['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','Bull'];
  const grid=document.getElementById('co-doubles-grid');
  const insightsEl=document.getElementById('co-insights');

  const cells=doubleNums.map(t=>{
    const d=state.drillData.double[t];
    if (!d||d.attempts===0) return {t,rate:null,hits:0,att:0,misses:{}};
    return {t,rate:d.hits/d.attempts,hits:d.hits,att:d.attempts,misses:d.misses};
  });

  grid.innerHTML=cells.map(c=>{
    if(c.rate===null) return `<div class="co-cell empty"><div class="co-num">D${c.t}</div><div class="co-rate">—</div><div class="co-count">no data</div></div>`;
    const pct=Math.round(c.rate*100);
    const cls=pct>=60?'great':pct>=35?'ok':'bad';
    return `<div class="co-cell ${cls}"><div class="co-num">D${c.t}</div><div class="co-rate">${pct}%</div><div class="co-count">${c.hits}/${c.att}</div></div>`;
  }).join('');

  const withData=cells.filter(c=>c.rate!==null&&c.att>=5);
  if(withData.length===0){
    insightsEl.innerHTML=`<div class="insight-box">Log double drills (5+ attempts per double) to unlock checkout routing insights.</div>`;
    return;
  }

  const sorted=[...withData].sort((a,b)=>b.rate-a.rate);
  const best3=sorted.slice(0,3), worst3=sorted.slice(-3).reverse();
  let html='';
  html+=`<div class="insight-box good">🎯 <strong>Strongest:</strong> ${best3.map(c=>`D${c.t} (${Math.round(c.rate*100)}%)`).join(', ')} — route through these.</div>`;
  html+=`<div class="insight-box warn">⚠ <strong>Weakest:</strong> ${worst3.map(c=>`D${c.t} (${Math.round(c.rate*100)}%)`).join(', ')} — drill more or route around.</div>`;

  const d16=cells.find(c=>c.t==='16'), d8=cells.find(c=>c.t==='8');
  if(d16?.rate!==null&&d8?.rate!==null){
    const pref=d16.rate>=d8.rate?'D16':'D8';
    html+=`<div class="insight-box">💡 <strong>Even chain:</strong> Prefer ${pref} for even finishes (D16:${Math.round((d16.rate)*100)}% / D8:${Math.round((d8.rate)*100)}%).</div>`;
  }
  insightsEl.innerHTML=html;
}

function renderCheckoutTrend() {
  const el=document.getElementById('co-trend-bars');
  const sessions=state.sessions;
  if(sessions.length===0){el.innerHTML=`<div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);padding:12px;">No sessions yet.</div>`;return;}

  const total=sessions.reduce((s,ses)=>s+ses.checkouts,0);
  const totalAtt=sessions.reduce((s,ses)=>s+ses.checkoutAttempts,0);
  el.innerHTML=`
    <div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);margin-bottom:14px;">
      Career: <span style="color:var(--accent3)">${total} checkouts</span> / ${totalAtt} attempts
      &nbsp;·&nbsp; <span style="color:var(--accent)">${totalAtt>0?((total/totalAtt)*100).toFixed(1):0}%</span>
    </div>
    <div style="font-family:DM Mono,monospace;font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;">LAST 10 SESSIONS</div>
    <div style="display:flex;flex-direction:column;gap:5px;">
      ${[...sessions].slice(-10).map(s=>{
        const co=parseInt(s.checkoutPct);
        const col=co>=50?'var(--accent3)':co>=30?'var(--accent)':'var(--accent2)';
        return `<div style="display:flex;align-items:center;gap:10px;font-family:DM Mono,monospace;font-size:11px;">
          <span style="color:var(--muted);width:60px">${s.date}</span>
          <div style="flex:1;background:var(--dim);height:5px;"><div style="height:5px;background:${col};width:${Math.min(co,100)}%;transition:width 0.4s"></div></div>
          <span style="color:${col};width:36px;text-align:right">${s.checkoutPct}%</span>
          <span style="color:var(--muted)">${['','😩','😕','😐','🙂','🔥'][s.feel]}</span>
        </div>`;
      }).join('')}
    </div>`;
}

function renderTrendChart(data) {
  const canvas=document.getElementById('trend-canvas');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  canvas.width=canvas.offsetWidth*2; canvas.height=canvas.offsetHeight*2;
  ctx.scale(2,2);
  const W=canvas.offsetWidth/2, H=canvas.offsetHeight/2;
  ctx.clearRect(0,0,W,H);

  if(data.length<2){
    ctx.fillStyle='#444'; ctx.font="12px 'DM Mono'"; ctx.textAlign='center';
    ctx.fillText('Need 2+ sessions',W/2,H/2); return;
  }

  const min=Math.min(...data)*0.9, max=Math.max(...data)*1.1;
  const pad={left:32,right:10,top:10,bottom:20};
  const cW=W-pad.left-pad.right, cH=H-pad.top-pad.bottom;
  const px=i=>pad.left+(i/(data.length-1))*cW;
  const py=v=>pad.top+cH-((v-min)/(max-min))*cH;

  ctx.strokeStyle='#222'; ctx.lineWidth=0.5;
  [0.25,0.5,0.75,1].forEach(t=>{
    const y=pad.top+cH*t;
    ctx.beginPath(); ctx.moveTo(pad.left,y); ctx.lineTo(pad.left+cW,y); ctx.stroke();
    ctx.fillStyle='#555'; ctx.font="9px 'DM Mono'"; ctx.textAlign='right';
    ctx.fillText((max-(max-min)*t).toFixed(0),pad.left-4,y+3);
  });

  const grad=ctx.createLinearGradient(0,pad.top,0,H);
  grad.addColorStop(0,'rgba(232,255,58,0.25)'); grad.addColorStop(1,'rgba(232,255,58,0)');
  ctx.beginPath(); ctx.moveTo(px(0),cH+pad.top);
  data.forEach((v,i)=>ctx.lineTo(px(i),py(v)));
  ctx.lineTo(px(data.length-1),cH+pad.top); ctx.closePath();
  ctx.fillStyle=grad; ctx.fill();

  ctx.beginPath(); ctx.strokeStyle='#e8ff3a'; ctx.lineWidth=1.5; ctx.lineJoin='round';
  data.forEach((v,i)=>{ i===0?ctx.moveTo(px(i),py(v)):ctx.lineTo(px(i),py(v)); });
  ctx.stroke();

  data.forEach((v,i)=>{
    ctx.beginPath(); ctx.arc(px(i),py(v),3,0,Math.PI*2);
    ctx.fillStyle='#e8ff3a'; ctx.fill();
  });
}

// ═══════════════════════════════════════════════════
//  ANALYSIS PAGE
// ═══════════════════════════════════════════════════
function renderAnalysis() {
  renderHeatmap();
  renderWeakSpots();
  renderMissAnalysis();
  renderCheckoutPressure();
  renderDoubleBreakdown();
  renderCricketNumFreq();
}

function renderCricketNumFreq() {
  var el = document.getElementById('cricket-num-freq');
  var legs = state.cricketLegs || [];
  if (!el || legs.length === 0) { if(el) el.innerHTML = '<div style="padding:16px;text-align:center;color:var(--muted)">No cricket legs yet.</div>'; return; }

  // Tally marks hit per number
  var totals = {};
  CRICKET_NUMS.forEach(function(n) { totals[String(n)] = 0; });
  legs.forEach(function(l) {
    if (!l.marks) return;
    Object.keys(l.marks).forEach(function(k) { totals[k] = (totals[k]||0) + (l.marks[k]||0); });
  });

  var maxVal = Math.max.apply(null, Object.values(totals)) || 1;
  el.innerHTML = '<div style="display:flex;flex-direction:column;gap:8px;">'
    + CRICKET_NUMS.map(function(n) {
      var key = String(n);
      var val = totals[key] || 0;
      var pct = Math.round(val / maxVal * 100);
      var label = n === 'B' ? 'BULL' : n;
      var col = pct >= 70 ? 'var(--accent3)' : pct >= 40 ? 'var(--accent)' : 'var(--accent2)';
      return '<div style="display:flex;align-items:center;gap:10px;">'
        + '<div style="font-family:Bebas Neue,sans-serif;font-size:20px;color:' + col + ';width:44px;text-align:right">' + label + '</div>'
        + '<div style="flex:1;background:var(--dim);height:6px;">'
        + '<div style="height:6px;background:' + col + ';width:' + pct + '%;transition:width 0.4s"></div></div>'
        + '<div style="color:var(--muted);font-size:11px;width:36px;text-align:right">' + val + '</div>'
        + '</div>';
    }).join('')
    + '</div>';
}

function selectHeatmapBed(type, btn) {
  heatmapBedType=type;
  document.querySelectorAll('#heatmap-bed-toggle .toggle-btn').forEach(b=>b.className='toggle-btn');
  btn.className=`toggle-btn sel-${type}`;
  renderHeatmap();
}

function renderHeatmap() {
  const canvas = document.getElementById('heatmap-canvas');
  const ctx = canvas.getContext('2d');
  const DPR = window.devicePixelRatio || 1;
  const SIZE = 320;
  canvas.width = SIZE * DPR;
  canvas.height = SIZE * DPR;
  canvas.style.width = SIZE + 'px';
  canvas.style.height = SIZE + 'px';
  ctx.scale(DPR, DPR);

  const W = SIZE, H = SIZE, cx = W/2, cy = H/2;

  // Board rings (proportional to actual dartboard)
  const R = {
    bull_inner: 7,    // double bull
    bull_outer: 17,   // single bull
    inner: 95,        // inner single
    triple_in: 100,   // triple inner edge
    triple_out: 114,  // triple outer edge
    outer: 155,       // outer single
    double_in: 161,   // double inner edge
    double_out: 174,  // double outer edge
  };

  const seq = [20,1,18,4,13,6,10,15,2,17,3,19,7,16,8,11,14,9,12,5];
  const TAU = Math.PI * 2;
  const SLICE = TAU / 20;
  const OFFSET = -Math.PI / 2 - SLICE / 2; // 20 at top

  const ac = heatmapBedType === 'double' ? [58,255,184] : heatmapBedType === 'treble' ? [167,139,250] : [232,255,58];

  // Background
  ctx.fillStyle = '#0d0d0d';
  ctx.fillRect(0, 0, W, H);

  // Draw each segment
  seq.forEach((num, i) => {
    const sa = OFFSET + i * SLICE;
    const ea = sa + SLICE;
    const midA = sa + SLICE / 2;
    const d = state.drillData[heatmapBedType][String(num)];
    const hr = (d && d.attempts > 0) ? d.hits / d.attempts : -1; // -1 = no data
    const hasData = hr >= 0;

    // Base alternating segment colors (like real dartboard dark/light)
    const baseLight = i % 2 === 0 ? '#1c1c1c' : '#161616';
    const baseTriple = i % 2 === 0 ? '#1a0e0e' : '#0e1a0e';
    const baseDouble = i % 2 === 0 ? '#1a0a0a' : '#0a1a0a';

    // Heat color with glow
    const alpha = hasData ? (0.15 + hr * 0.85) : 0;
    const heatColor = `rgba(${ac[0]},${ac[1]},${ac[2]},${alpha})`;
    const tripleAlpha = hasData ? (0.2 + hr * 0.8) : 0;
    const tripleHeat = `rgba(${ac[0]},${ac[1]},${ac[2]},${tripleAlpha})`;
    const doubleAlpha = hasData ? (0.25 + hr * 0.75) : 0;
    const doubleHeat = `rgba(${ac[0]},${ac[1]},${ac[2]},${doubleAlpha})`;

    function segment(r1, r2, fillA, fillB) {
      ctx.beginPath();
      ctx.arc(cx, cy, r2, sa, ea);
      ctx.arc(cx, cy, r1, ea, sa, true);
      ctx.closePath();
      ctx.fillStyle = fillA; ctx.fill();
      if (fillB) { ctx.fillStyle = fillB; ctx.fill(); }
    }

    // Outer single
    segment(R.triple_out, R.double_in, baseLight, heatColor);
    // Triple band
    segment(R.triple_in, R.triple_out, baseTriple, tripleHeat);
    // Inner single
    segment(R.bull_outer, R.inner, baseLight, heatColor);
    // Double band
    segment(R.double_in, R.double_out, baseDouble, doubleHeat);

    // Number labels outside the double ring
    const labelR = R.double_out + 11;
    const lx = cx + Math.cos(midA) * labelR;
    const ly = cy + Math.sin(midA) * labelR;
    const labelAlpha = hasData ? (0.5 + hr * 0.5) : 0.25;
    ctx.fillStyle = `rgba(${hasData ? ac[0] : 200},${hasData ? ac[1] : 200},${hasData ? ac[2] : 200},${labelAlpha})`;
    ctx.font = `bold ${hasData ? '11' : '9'}px DM Mono, monospace`;
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(String(num), lx, ly);
  });

  // Bull rings
  const bd = state.drillData[heatmapBedType]['Bull'];
  const br = (bd && bd.attempts > 0) ? bd.hits / bd.attempts : -1;
  const bullAlpha = br >= 0 ? (0.2 + br * 0.8) : 0;

  ctx.beginPath(); ctx.arc(cx, cy, R.bull_outer, 0, TAU);
  ctx.fillStyle = '#1a180a'; ctx.fill();
  ctx.fillStyle = `rgba(${ac[0]},${ac[1]},${ac[2]},${bullAlpha * 0.6})`; ctx.fill();

  ctx.beginPath(); ctx.arc(cx, cy, R.bull_inner, 0, TAU);
  ctx.fillStyle = '#2a0808'; ctx.fill();
  ctx.fillStyle = `rgba(${ac[0]},${ac[1]},${ac[2]},${bullAlpha})`; ctx.fill();

  // Wire lines
  ctx.strokeStyle = 'rgba(80,80,80,0.6)';
  ctx.lineWidth = 0.8;
  seq.forEach((_, i) => {
    const a = OFFSET + i * SLICE;
    ctx.beginPath();
    ctx.moveTo(cx + Math.cos(a) * R.bull_outer, cy + Math.sin(a) * R.bull_outer);
    ctx.lineTo(cx + Math.cos(a) * R.double_out, cy + Math.sin(a) * R.double_out);
    ctx.stroke();
  });
  [R.bull_outer, R.inner, R.triple_in, R.triple_out, R.double_in, R.double_out].forEach(rad => {
    ctx.beginPath(); ctx.arc(cx, cy, rad, 0, TAU);
    ctx.stroke();
  });

  // Legend bar (bottom of canvas)
  const lgW = 160, lgH = 6, lgX = cx - lgW/2, lgY = H - 14;
  const grad = ctx.createLinearGradient(lgX, 0, lgX + lgW, 0);
  grad.addColorStop(0, `rgba(${ac[0]},${ac[1]},${ac[2]},0.1)`);
  grad.addColorStop(1, `rgba(${ac[0]},${ac[1]},${ac[2]},1)`);
  ctx.fillStyle = 'rgba(0,0,0,0.4)';
  ctx.fillRect(lgX - 2, lgY - 2, lgW + 34, lgH + 6);
  ctx.fillStyle = grad;
  ctx.fillRect(lgX, lgY, lgW, lgH);
  ctx.fillStyle = 'rgba(200,200,200,0.4)';
  ctx.font = '8px DM Mono, monospace';
  ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
  ctx.fillText('0%', lgX - 14, lgY + lgH/2);
  ctx.textAlign = 'right';
  ctx.fillText('100%', lgX + lgW + 28, lgY + lgH/2);
}

function renderWeakSpots() {
  const entries=[];
  ['single','double','treble'].forEach(bed=>{
    Object.entries(state.drillData[bed]).forEach(([t,d])=>{
      if(d.attempts>=5){
        const prefix=bed==='double'?'D':bed==='treble'?'T':'';
        entries.push({label:prefix+t,rate:d.hits/d.attempts,attempts:d.attempts,misses:d.misses,bed});
      }
    });
  });
  entries.sort((a,b)=>a.rate-b.rate);
  const worst=entries.slice(0,6);
  const container=document.getElementById('weak-spots-container');

  if(worst.length===0){
    container.innerHTML='<div style="font-family:\'DM Mono\',monospace;font-size:12px;color:var(--muted);text-align:center;padding:20px;">Log 5+ throws per target to see weak spots.</div>';
    return;
  }

  container.innerHTML=worst.map(e=>{
    const pct=(e.rate*100).toFixed(0);
    const topMiss=Object.entries(e.misses).sort((a,b)=>b[1]-a[1])[0];
    const tip=topMiss&&topMiss[1]>0?`Most misses: ${topMiss[0]}`:'No directional data';
    const bedLabel=e.bed==='double'?'DOUBLE':e.bed==='treble'?'TREBLE':'SINGLE';
    return `<div class="weak-spot-row">
      <div class="weak-spot-num">${e.label}</div>
      <div style="flex:1">
        <div class="weak-spot-bar-wrap"><div class="weak-spot-bar" style="width:${pct}%"></div></div>
        <div class="weak-spot-tip">${bedLabel} · ${tip}</div>
      </div>
      <div class="weak-spot-pct">${pct}%</div>
    </div>`;
  }).join('');
}

function renderMissAnalysis() {
  const totals={left:0,right:0,high:0,low:0};
  let totalMisses=0;
  ['single','double','treble'].forEach(bed=>{
    Object.values(state.drillData[bed]).forEach(d=>{
      Object.entries(d.misses).forEach(([k,v])=>{totals[k]+=v; totalMisses+=v;});
    });
  });

  if(totalMisses===0){document.getElementById('miss-analysis').innerHTML='No miss data yet.';return;}

  const insight=[];
  if(totals.left>totals.right*1.5) insight.push('Pulling <span style="color:var(--accent2)">left</span> — try releasing slightly later');
  if(totals.right>totals.left*1.5) insight.push('Pushing <span style="color:var(--accent2)">right</span> — try releasing slightly earlier');
  if(totals.high>totals.low*1.5) insight.push('Throwing <span style="color:var(--accent2)">high</span> — check elbow height and follow-through');
  if(totals.low>totals.high*1.5) insight.push('Throwing <span style="color:var(--accent2)">low</span> — arm may be dropping before release');
  if(insight.length===0) insight.push('<span style="color:var(--accent3)">Balanced pattern</span> — no dominant drift detected');

  document.getElementById('miss-analysis').innerHTML=`
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">
      ${['left','right','high','low'].map(d=>`
        <div style="text-align:center;padding:14px;background:var(--surface2);border:1px solid var(--border)">
          <div style="font-size:9px;color:var(--muted);letter-spacing:1px;margin-bottom:4px">${d.toUpperCase()}</div>
          <div style="font-family:Bebas Neue,sans-serif;font-size:28px;color:${totals[d]>5?'var(--accent2)':'var(--text)'}">${totals[d]}</div>
        </div>
      `).join('')}
    </div>
    <div style="color:var(--text);line-height:2.2;">${insight.map(i=>'→ '+i).join('<br>')}</div>
  `;
}

function renderCheckoutPressure() {
  const el=document.getElementById('checkout-pressure');
  const sessions=state.sessions;
  if(sessions.length<2){el.innerHTML='Need 2+ sessions to analyse pressure patterns.';return;}

  const totalCO=sessions.reduce((s,ses)=>s+ses.checkouts,0);
  const totalAtt=sessions.reduce((s,ses)=>s+ses.checkoutAttempts,0);
  if(totalAtt===0){el.innerHTML='No checkout attempts logged yet.';return;}

  const overallRate=totalCO/totalAtt;
  const feelGroups={};
  sessions.forEach(s=>{
    if(!feelGroups[s.feel]) feelGroups[s.feel]={co:0,att:0,count:0};
    feelGroups[s.feel].co+=s.checkouts;
    feelGroups[s.feel].att+=s.checkoutAttempts;
    feelGroups[s.feel].count++;
  });

  const feelRows=Object.entries(feelGroups).filter(([,v])=>v.att>0).sort((a,b)=>parseInt(a[0])-parseInt(b[0])).map(([feel,v])=>{
    const rate=((v.co/v.att)*100).toFixed(0);
    const emoji=['','😩','😕','😐','🙂','🔥'][feel];
    const col=parseInt(rate)>=50?'var(--accent3)':parseInt(rate)>=30?'var(--accent)':'var(--accent2)';
    return `<div style="display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border)">
      <span style="font-size:16px;width:24px">${emoji}</span>
      <div style="flex:1;background:var(--dim);height:4px;"><div style="height:4px;background:${col};width:${Math.min(parseInt(rate),100)}%"></div></div>
      <span style="color:${col};width:36px;text-align:right">${rate}%</span>
      <span style="color:var(--muted);font-size:10px">${v.count}s</span>
    </div>`;
  });

  const note=overallRate<0.33?'→ <span style="color:var(--accent2)">Below 33%</span> — prioritise double practice':overallRate<0.5?'→ <span style="color:var(--accent)">33–50%</span> — push for consistency':'→ <span style="color:var(--accent3)">50%+</span> — world class is ~55%+';

  el.innerHTML=`
    <div style="margin-bottom:12px;color:var(--muted);">Overall: <span style="color:var(--accent)">${(overallRate*100).toFixed(1)}%</span></div>
    <div style="font-size:10px;color:var(--muted);letter-spacing:1px;margin-bottom:8px;">CO% BY FEEL</div>
    ${feelRows.join('')}
    <div style="margin-top:14px;font-size:11px;line-height:1.8;">${note}</div>
  `;
}

function renderDoubleBreakdown() {
  const el=document.getElementById('double-breakdown');
  const doubleNums=['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','Bull'];
  const withData=doubleNums.filter(t=>{const d=state.drillData.double[t];return d&&d.attempts>=3;});

  if(withData.length===0){el.innerHTML='Log double drills (3+ attempts per double) to see breakdown.';return;}

  el.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:6px;">
    ${withData.map(t=>{
      const d=state.drillData.double[t];
      const pct=Math.round(d.hits/d.attempts*100);
      const col=pct>=60?'var(--accent3)':pct>=35?'var(--accent)':'var(--accent2)';
      const topMiss=Object.entries(d.misses).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1])[0];
      const missHint=topMiss?`→ ${topMiss[0]}`:'—';
      return `<div style="background:var(--surface2);border:1px solid var(--border);padding:12px;font-family:DM Mono,monospace;">
        <div style="font-family:Bebas Neue,sans-serif;font-size:22px;color:${col};letter-spacing:1px">D${t}</div>
        <div style="font-size:20px;color:${col};font-family:Bebas Neue,sans-serif">${pct}%</div>
        <div style="font-size:10px;color:var(--muted);margin-top:2px">${d.hits}/${d.attempts}</div>
        <div style="font-size:10px;color:var(--muted)">${missHint}</div>
      </div>`;
    }).join('')}
  </div>`;
}

// ═══════════════════════════════════════════════════
//  DRILL VOICE RECOGNITION
// ═══════════════════════════════════════════════════
let drillRecognition = null;
let drillVoiceActive = false;

function initDrillVoice() {
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR) return false;
  drillRecognition = new SR();
  drillRecognition.lang = 'en-GB';
  drillRecognition.interimResults = true;
  drillRecognition.maxAlternatives = 3;
  drillRecognition.continuous = false;

  drillRecognition.onstart = () => {
    drillVoiceActive = true;
    document.getElementById('drill-voice-btn').classList.add('listening');
    document.getElementById('drill-voice-btn-label').textContent = 'Listening…';
    setDrillTranscript('Listening…', '');
  };

  drillRecognition.onresult = (e) => {
    const results = e.results[e.results.length - 1];
    const interim = results[0].transcript;
    setDrillTranscript(interim, 'heard');

    if (results.isFinal) {
      let parsed = null;
      for (let i = 0; i < results.length; i++) {
        parsed = parseDrillVoice(results[i].transcript);
        if (parsed) break;
      }

      if (parsed) {
        const label = parsed.result === 'hit' ? '✓ HIT' : `✗ MISS${parsed.dir ? ' · ' + parsed.dir : ''}`;
        setDrillTranscript(`"${results[0].transcript}" → ${label}`, 'parsed');
        if (parsed.dir) {
          // find + click the miss direction button
          const missMap = { left:'left', right:'right', high:'high', low:'low', top:'high', bottom:'low' };
          const dir = missMap[parsed.dir];
          if (dir) {
            document.querySelectorAll('.miss-btn').forEach(b => {
              if (b.textContent.toLowerCase().includes(dir)) b.click();
            });
          }
        }
        setTimeout(() => logDrill(parsed.result), 200);
      } else {
        setDrillTranscript(`Didn't understand — say "Hit" or "Miss left"`, 'heard');
      }
    }
  };

  drillRecognition.onerror = (e) => {
    drillVoiceActive = false;
    document.getElementById('drill-voice-btn').classList.remove('listening');
    document.getElementById('drill-voice-btn-label').textContent = 'Tap to speak';
    if (e.error !== 'no-speech' && e.error !== 'aborted') setDrillTranscript('Mic error', 'heard');
    else setDrillTranscript('Say "Hit" or "Miss left / right / high / low"', '');
  };

  drillRecognition.onend = () => {
    drillVoiceActive = false;
    document.getElementById('drill-voice-btn').classList.remove('listening');
    document.getElementById('drill-voice-btn-label').textContent = 'Tap to speak';
  };

  return true;
}

function parseDrillVoice(raw) {
  const t = raw.toLowerCase().trim();
  // Hit patterns
  if (/\b(hit|yes|got it|in|nailed|scored)\b/.test(t)) return { result:'hit', dir:null };

  // Miss patterns — extract optional direction
  if (/\b(miss|missed|no|out|off)\b/.test(t)) {
    const dirMatch = t.match(/\b(left|right|high|low|top|bottom|above|below)\b/);
    return { result:'miss', dir: dirMatch ? dirMatch[1] : null };
  }

  return null;
}

function setDrillTranscript(text, cls) {
  const el = document.getElementById('drill-transcript');
  if (!el) return;
  el.textContent = text;
  el.className = 'drill-transcript' + (cls ? ' '+cls : '');
}

function toggleDrillVoice() {
  if (!drillRecognition) {
    const ok = initDrillVoice();
    if (!ok) { toast('Voice not supported in this browser', true); return; }
  }
  if (drillVoiceActive) { drillRecognition.stop(); return; }
  try {
    drillRecognition.start();
  } catch(e) {
    drillRecognition = null;
    initDrillVoice();
    try { drillRecognition.start(); } catch(e2) { toast('Voice error — try again', true); }
  }
}

// ═══════════════════════════════════════════════════
//  SOCIAL TAB
// ═══════════════════════════════════════════════════
const SOCIAL_KEY = 'bullboard_social_v2';

let socialState = {
  myHandle: '',
  photoURL: '',       // base64 or URL, stored locally + Firestore
  following: [],
  feedFilter: 'all',
  posts: [],
  likes: {},
  autoPost: { '180': false, ton: false, checkout: false, session: false, drill: false },
};

function loadSocialState() {
  try {
    const s = JSON.parse(localStorage.getItem(SOCIAL_KEY));
    if (s) {
      socialState = {
        ...socialState, ...s,
        posts: s.posts || [],
        autoPost: { ...socialState.autoPost, ...(s.autoPost || {}) }
      };
    }
  } catch(e) {}
}

// Apply avatar image or initials to all avatar elements on the page
function applyAvatar(handle, photoURL) {
  const initials = (handle || '?').slice(0, 2).toUpperCase();
  const imgEl = document.getElementById('social-avatar-img');
  const initialsEl = document.getElementById('social-avatar-initials');
  const composerEl = document.getElementById('composer-avatar');
  // Profile card avatar
  if (photoURL) {
    if (imgEl) { imgEl.src = photoURL; imgEl.style.display = 'block'; }
    if (initialsEl) initialsEl.style.display = 'none';
  } else {
    if (imgEl) imgEl.style.display = 'none';
    if (initialsEl) { initialsEl.textContent = initials; initialsEl.style.display = ''; }
  }
  // Composer avatar (text initials always)
  if (composerEl) composerEl.textContent = initials;
}
function saveSocialState() {
  localStorage.setItem(SOCIAL_KEY, JSON.stringify({
    myHandle: socialState.myHandle,
    photoURL: socialState.photoURL,
    following: socialState.following,
    likes: socialState.likes,
    posts: socialState.posts.filter(p => p.isOwn),
    autoPost: socialState.autoPost,
  }));
}
loadSocialState();
restoreSocialSettingsUI();

// ── Gate: show/hide based on auth state ──
function updateSocialGate(isSignedIn, email) {
  const gate = document.getElementById('social-gate');
  const socialContent = document.getElementById('social-content');
  if (!gate || !socialContent) return;
  if (isSignedIn) {
    gate.classList.add('hidden');
    socialContent.classList.remove('hidden');
    // Apply whatever handle/avatar we already have cached locally
    applyAvatar(socialState.myHandle, socialState.photoURL);
    const handle = socialState.myHandle || (email ? email.split('@')[0] : '');
    const handleEl = document.getElementById('social-handle');
    if (handleEl) handleEl.textContent = (handle || 'YOUR HANDLE').toUpperCase();
    const subEl = document.getElementById('social-sub');
    if (subEl && handle) subEl.textContent = '@' + handle.toLowerCase() + ' · Bullboard';
    const nameInput = document.getElementById('social-name-input');
    if (nameInput && socialState.myHandle) nameInput.value = socialState.myHandle;
  } else {
    gate.classList.remove('hidden');
    socialContent.classList.add('hidden');
  }
}

// Restore social settings UI from saved state (runs regardless of auth)
function restoreSocialSettingsUI() {
  // Handle input
  const nameInput = document.getElementById('social-name-input');
  if (nameInput && socialState.myHandle) nameInput.value = socialState.myHandle;

  // Avatar
  applyAvatar(socialState.myHandle, socialState.photoURL);

  // Handle display
  if (socialState.myHandle) {
    const handleEl = document.getElementById('social-handle');
    if (handleEl) handleEl.textContent = socialState.myHandle.toUpperCase();
    const subEl = document.getElementById('social-sub');
    if (subEl) subEl.textContent = '@' + socialState.myHandle.toLowerCase() + ' · Bullboard';
  }

  // Autopost toggles
  Object.keys(socialState.autoPost).forEach(function(key) {
    const el = document.getElementById('ap-' + key);
    if (el) {
      if (socialState.autoPost[key]) el.classList.add('on');
      else el.classList.remove('on');
    }
  });
}

function renderSocialPage() {
  const isSignedIn = !!window._currentUser;
  updateSocialGate(isSignedIn, window._currentUser ? window._currentUser.email : null);

  // Always restore settings fields (handle input, autopost toggles) — auth not required
  restoreSocialSettingsUI();

  if (!isSignedIn) return;

  const emailPrefix = window._currentUser && window._currentUser.email ? window._currentUser.email.split('@')[0] : 'You';
  const handle = socialState.myHandle || emailPrefix;
  applyAvatar(handle, socialState.photoURL);
  document.getElementById('social-handle').textContent = handle.toUpperCase();
  document.getElementById('social-sub').textContent = '@' + handle.toLowerCase() + ' · Bullboard';
  document.getElementById('social-name-input').value = socialState.myHandle;

  const sessions = state.sessions;
  const avg = sessions.length ? (sessions.reduce((s,ses)=>s+parseFloat(ses.avg),0)/sessions.length).toFixed(1) : '—';
  document.getElementById('social-p-avg').textContent = avg;
  document.getElementById('social-p-sessions').textContent = sessions.length;
  document.getElementById('social-p-following').textContent = socialState.following.length;

  Object.keys(socialState.autoPost).forEach(function(key) {
    const el = document.getElementById('ap-' + key);
    if (el) { if (socialState.autoPost[key]) el.classList.add('on'); else el.classList.remove('on'); }
  });

  renderFollowList();
  renderFeed();
  renderLeaderboard();
}

function toggleAutoPost(key, el) {
  socialState.autoPost[key] = !socialState.autoPost[key];
  if (socialState.autoPost[key]) el.classList.add('on'); else el.classList.remove('on');
  saveSocialState();
  toast(socialState.autoPost[key] ? 'Auto-post enabled' : 'Auto-post disabled');
}

function setSocialProfile() {
  const val = document.getElementById('social-name-input').value.trim().replace(/[\s@#]+/g,'_');
  if (!val) { toast('Enter a handle first', true); return; }
  socialState.myHandle = val;
  saveSocialState();
  applyAvatar(val, socialState.photoURL);
  const handleEl = document.getElementById('social-handle');
  if (handleEl) handleEl.textContent = val.toUpperCase();
  const subEl = document.getElementById('social-sub');
  if (subEl) subEl.textContent = '@' + val.toLowerCase() + ' · Bullboard';
  // Push to Firestore if signed in
  if (typeof window.saveUserProfileToFirebase === 'function') {
    window.saveUserProfileToFirebase({ handle: val, photoURL: socialState.photoURL });
  }
  toast('Handle saved: @' + val);
}

function handleAvatarUpload(input) {
  const file = input.files && input.files[0];
  if (!file) return;
  if (file.size > 600 * 1024) { toast('Image too large — max 600 KB', true); return; }
  const reader = new FileReader();
  reader.onload = function(e) {
    // Resize to max 200×200 via canvas to keep storage small
    const img = new Image();
    img.onload = function() {
      const MAX = 200;
      const scale = Math.min(MAX / img.width, MAX / img.height, 1);
      const canvas = document.createElement('canvas');
      canvas.width = Math.round(img.width * scale);
      canvas.height = Math.round(img.height * scale);
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      const dataURL = canvas.toDataURL('image/jpeg', 0.82);
      socialState.photoURL = dataURL;
      saveSocialState();
      applyAvatar(socialState.myHandle, dataURL);
      if (typeof window.saveUserProfileToFirebase === 'function') {
        window.saveUserProfileToFirebase({ handle: socialState.myHandle, photoURL: dataURL });
      }
      toast('Profile photo updated');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
  input.value = ''; // reset so same file can be re-selected
}

// ── Handle onboarding modal ──
function openOnboardModal() {
  const modal = document.getElementById('onboard-modal');
  if (!modal) return;
  const input = document.getElementById('onboard-handle-input');
  // Pre-fill: prefer Google display name, then email prefix
  if (input && !input.value && window._currentUser) {
    const u = window._currentUser;
    const base = u.displayName
      ? u.displayName.replace(/[^a-zA-Z0-9_]/g, '_').replace(/_+/g, '_').replace(/^_|_$/g, '')
      : (u.email ? u.email.split('@')[0].replace(/[^a-zA-Z0-9_]/g, '_') : '');
    input.value = base.slice(0, 24);
  }
  modal.style.display = 'flex';
  setTimeout(() => { if (input) { input.focus(); input.select(); } }, 80);
}

function confirmOnboardHandle() {
  const input = document.getElementById('onboard-handle-input');
  const val = (input ? input.value : '').trim().replace(/[\s@#]+/g, '_');
  if (!val || val.length < 2) { toast('Handle must be at least 2 characters', true); return; }
  socialState.myHandle = val;
  saveSocialState();
  document.getElementById('onboard-modal').style.display = 'none';
  // Update social name input
  const nameInput = document.getElementById('social-name-input');
  if (nameInput) nameInput.value = val;
  applyAvatar(val, socialState.photoURL);
  const handleEl = document.getElementById('social-handle');
  if (handleEl) handleEl.textContent = val.toUpperCase();
  const subEl = document.getElementById('social-sub');
  if (subEl) subEl.textContent = '@' + val.toLowerCase() + ' · Bullboard';
  if (typeof window.saveUserProfileToFirebase === 'function') {
    window.saveUserProfileToFirebase({ handle: val, photoURL: socialState.photoURL });
  }
  toast('Welcome, @' + val + '! 🎯');
}

function renderFollowList() {
  const el = document.getElementById('follow-list');
  const followed = socialState.following;
  if (followed.length === 0) {
    el.innerHTML = '<div style="font-family:\'DM Mono\',monospace;font-size:11px;color:var(--muted);padding:10px;">No one followed yet. Invite friends!</div>';
    return;
  }
  el.innerHTML = followed.map(function(h) {
    const init = h.slice(0,2).toUpperCase();
    return '<div class="follow-row">'
      + '<div class="follow-avatar" style="background:var(--accent)">' + init + '</div>'
      + '<div class="follow-info"><div class="follow-name">' + h + '</div><div class="follow-avg">Following</div></div>'
      + '<button class="follow-btn following" onclick="unfollowUser(\'' + h + '\',this)">✓ Following</button>'
      + '</div>';
  }).join('');
}

function unfollowUser(handle, btn) {
  socialState.following = socialState.following.filter(function(h) { return h !== handle; });
  saveSocialState();
  document.getElementById('social-p-following').textContent = socialState.following.length;
  toast('Unfollowed ' + handle);
  renderFollowList();
}

function followUser(handle, btn) {
  if (!socialState.following.includes(handle)) {
    socialState.following.push(handle);
    saveSocialState();
    document.getElementById('social-p-following').textContent = socialState.following.length;
    toast('Following ' + handle);
    renderFollowList();
  }
}

function setFeedFilter(filter, btn) {
  socialState.feedFilter = filter;
  document.querySelectorAll('.feed-filter').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  renderFeed();
}

function renderFeed() {
  const el = document.getElementById('social-feed');
  let posts = socialState.posts.slice().reverse();

  if (socialState.feedFilter !== 'all') {
    const map = { sessions:'session', checkouts:'checkout', drills:'drill', milestones:'milestone' };
    const t = map[socialState.feedFilter];
    posts = posts.filter(function(p) { return p.type === t; });
  }

  if (posts.length === 0) {
    el.innerHTML = '<div style="font-family:\'DM Mono\',monospace;font-size:12px;color:var(--muted);text-align:center;padding:40px;">No posts yet — share your first session!</div>';
    return;
  }

  el.innerHTML = posts.map(function(p) {
    const handle = p.user || 'Anonymous';
    const init = handle.slice(0,2).toUpperCase();
    const color = p.color || '#e8ff3a';
    const isLiked = !!socialState.likes[p.id];
    const likeCount = (p.likes||0) + (isLiked ? 1 : 0);
    const statsHtml = (p.stats||[]).map(function(s) {
      return '<div class="post-stat-chip"><label>' + s.l + '</label><span>' + s.v + '</span></div>';
    }).join('');
    const body = (p.text||'')
      .replace(/\b(\d{3})\b/g, '<span class="highlight">$1</span>')
      .replace(/\b([Dd]\d+)\b/g, '<span class="highlight2">$1</span>');

    return '<div class="post-card" id="post-' + p.id + '">'
      + '<div class="post-header">'
      + '<div class="post-avatar" style="background:' + color + '">' + init + '</div>'
      + '<div class="post-meta">'
      + '<div class="post-handle">' + handle + '</div>'
      + '<div class="post-time">' + (p.time||'just now') + '</div>'
      + '</div>'
      + '<div class="post-type-badge ' + (p.type||'session') + '">' + (p.type||'session') + '</div>'
      + '</div>'
      + '<div class="post-body">' + body + '</div>'
      + (statsHtml ? '<div class="post-stats-row">' + statsHtml + '</div>' : '')
      + '<div class="post-actions">'
      + '<button class="post-action-btn ' + (isLiked?'liked':'') + '" onclick="toggleLike(\'' + p.id + '\',this)">'
      + (isLiked?'♥':'♡') + ' <span class="like-count">' + likeCount + '</span></button>'
      + '<button class="post-action-btn" onclick="toast(\'Comments coming soon!\')">💬 ' + (p.comments||0) + '</button>'
      + (p.isOwn ? '<button class="post-action-btn" style="color:var(--accent2);border-color:rgba(255,77,77,0.4)" onclick="deletePost(\'' + p.id + '\')">✕</button>' : '')
      + '</div>'
      + '</div>';
  }).join('');
}

function toggleLike(postId, btn) {
  socialState.likes[postId] = !socialState.likes[postId];
  saveSocialState();
  const isLiked = socialState.likes[postId];
  const post = socialState.posts.find(function(p){return p.id===postId;});
  const likeCount = ((post ? post.likes : 0)||0) + (isLiked?1:0);
  btn.className = 'post-action-btn ' + (isLiked?'liked':'');
  btn.innerHTML = (isLiked?'♥':'♡') + ' <span class="like-count">' + likeCount + '</span>';
}

function deletePost(postId) {
  socialState.posts = socialState.posts.filter(function(p) { return p.id !== postId; });
  saveSocialState();
  renderFeed();
  toast('Post deleted');
}

function publishPost(type, text, stats, extraColor) {
  const emailPrefix = window._currentUser && window._currentUser.email ? window._currentUser.email.split('@')[0] : 'You';
  const handle = socialState.myHandle || emailPrefix;
  const now = new Date();
  const timeStr = now.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'}) + ' · ' + now.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
  const post = {
    id: 'p_' + Date.now(),
    user: handle,
    color: extraColor || '#e8ff3a',
    time: timeStr,
    type: type,
    text: text,
    stats: stats || [],
    likes: 0,
    comments: 0,
    isOwn: true,
  };
  socialState.posts.push(post);
  saveSocialState();
  // Only re-render if on social page
  if (document.getElementById('page-home').classList.contains('active')) renderFeed();
  return post;
}

function submitPost() {
  if (!window._currentUser) { toast('Sign in to post', true); return; }
  const text = document.getElementById('post-text').value.trim();
  if (!text) { toast('Write something first!', true); return; }
  publishPost('session', text, []);
  document.getElementById('post-text').value = '';
  toast('Posted!');
}

function shareLastSession() {
  const sessions = state.sessions;
  if (!sessions.length) { toast('No sessions saved yet', true); return; }
  const s = sessions[sessions.length-1];
  const feel = ['','😩','😕','😐','🙂','🔥'][s.feel] || '';
  document.getElementById('post-text').value =
    'Session — avg ' + s.avg + ', ' + s.legs + ' leg' + (s.legs!==1?'s':'') + ', ' + s.checkoutPct + '% checkout ' + feel;
  toast('Session data added — edit and post!');
}

function renderLeaderboard() {
  const el = document.getElementById('leaderboard-list');
  const sessions = state.sessions;
  if (!sessions.length) {
    el.innerHTML = '<div style="font-family:\'DM Mono\',monospace;font-size:12px;color:var(--muted);padding:8px;">Complete sessions to appear here.</div>';
    return;
  }
  const emailPrefix = window._currentUser && window._currentUser.email ? window._currentUser.email.split('@')[0] : 'You';
  const handle = socialState.myHandle || emailPrefix;
  const avg = (sessions.reduce(function(s,ses){return s+parseFloat(ses.avg);},0)/sessions.length).toFixed(1);
  el.innerHTML = '<div style="display:flex;align-items:center;gap:10px;padding:8px 0;font-family:\'DM Mono\',monospace;">'
    + '<span style="font-size:14px;width:22px">🥇</span>'
    + '<div class="follow-avatar" style="background:var(--accent);width:28px;height:28px;font-size:11px;color:#000">' + handle.slice(0,2).toUpperCase() + '</div>'
    + '<div style="flex:1;font-size:12px;color:var(--text)">' + handle + '</div>'
    + '<div style="font-family:\'Bebas Neue\',sans-serif;font-size:18px;color:var(--accent)">' + avg + '</div>'
    + '</div>'
    + '<div style="font-family:\'DM Mono\',monospace;font-size:10px;color:var(--muted);padding-top:8px;border-top:1px solid var(--border);">Invite friends to compete!</div>';
}

// ── AUTO-POST TRIGGERS ──
function maybeAutoPostTon(score) {
  if (!window._currentUser || !window._currentUser.email) return;
  if (score === 180 && socialState.autoPost['180']) {
    publishPost('milestone', '🎯 ONE HUNDRED AND EIGHTY! Scored 180 in practice.', [{l:'Score',v:'180'}], '#ff4d4d');
    toast('Auto-posted: 180!');
  } else if (score >= 100 && socialState.autoPost.ton) {
    publishPost('session', 'Scored ' + score + ' in practice. 🔥', [{l:'Score',v:String(score)}]);
    toast('Auto-posted: ' + score);
  }
}

function maybeAutoPostCheckout(score) {
  if (!window._currentUser || !window._currentUser.email) return;
  if (score >= 100 && socialState.autoPost.checkout) {
    publishPost('checkout', '✅ Checkout! Finished on ' + score + ' to win the leg.', [{l:'Checkout',v:String(score)}], '#3affb8');
    toast('Auto-posted: ' + score + ' checkout');
  }
}

// ── Drill share modal ──
function openDrillShareModal() {
  if (!window._currentUser) { toast('Sign in to share', true); return; }
  if (drillSessionLog.length === 0) { toast('No drill throws logged yet', true); return; }
  const groups = {};
  drillSessionLog.forEach(function(e) {
    const key = e.bed + ':' + e.target;
    if (!groups[key]) groups[key] = { bed:e.bed, target:e.target, hits:0, total:0 };
    groups[key].total++;
    if (e.result==='hit') groups[key].hits++;
  });
  const pfx = function(bed) { return bed==='double'?'D':bed==='treble'?'T':''; };
  const chips = Object.values(groups).map(function(g) {
    const pct = Math.round(g.hits/g.total*100);
    const col = pct>=60?'var(--accent3)':pct>=35?'var(--accent)':'var(--accent2)';
    return '<div class="post-stat-chip"><label>' + pfx(g.bed) + g.target + '</label><span style="color:' + col + '">' + pct + '%</span></div>';
  }).join('');
  document.getElementById('drill-share-summary').innerHTML = '<div class="post-stats-row">' + chips + '</div>';
  document.getElementById('drill-share-text').value = '';
  document.getElementById('drill-share-modal').classList.remove('hidden');
}

function closeDrillShareModal() {
  document.getElementById('drill-share-modal').classList.add('hidden');
}

function confirmDrillShare() {
  const caption = document.getElementById('drill-share-text').value.trim();
  const groups = {};
  drillSessionLog.forEach(function(e) {
    const key = e.bed + ':' + e.target;
    if (!groups[key]) groups[key] = { bed:e.bed, target:e.target, hits:0, total:0 };
    groups[key].total++;
    if (e.result==='hit') groups[key].hits++;
  });
  const pfx = function(bed) { return bed==='double'?'D':bed==='treble'?'T':''; };
  const stats = Object.values(groups).map(function(g) {
    const pct = Math.round(g.hits/g.total*100);
    return { l: pfx(g.bed) + g.target, v: pct + '%' };
  });
  const total = drillSessionLog.length;
  const hits = drillSessionLog.filter(function(e){return e.result==='hit';}).length;
  const defaultText = 'Drill session — ' + hits + '/' + total + ' (' + Math.round(hits/total*100) + '%) across ' + Object.keys(groups).length + ' targets.';
  publishPost('drill', caption || defaultText, stats, '#a78bfa');
  closeDrillShareModal();
  toast('Drill session shared!');
}


// ═══════════════════════════════════════════════════
//  MOBILE MENU
// ═══════════════════════════════════════════════════
function toggleMenu() {
  var nav = document.getElementById('main-nav');
  var hbg = document.getElementById('hamburger');
  var auth = document.getElementById('auth-container');
  var open = nav.classList.toggle('open');
  hbg.classList.toggle('open', open);
  if (open) auth.classList.add('mobile-open');
  else auth.classList.remove('mobile-open');
}
function closeMenu() {
  var nav = document.getElementById('main-nav');
  var hbg = document.getElementById('hamburger');
  var auth = document.getElementById('auth-container');
  nav.classList.remove('open');
  hbg.classList.remove('open');
  auth.classList.remove('mobile-open');
}

// ═══════════════════════════════════════════════════
//  BOT OPPONENT (01 games)
// ═══════════════════════════════════════════════════
// Bot accuracy profile per level: { hitRate, checkoutRate, avgThrow }
const BOT_PROFILES = [
  null, // index 0 unused
  { name:'Little Child',        avgThrow: 14, checkoutRate: 0.05, hitRate: 0.30 }, // L1
  { name:'Exceptional Child',       avgThrow: 20, checkoutRate: 0.08, hitRate: 0.38 }, // L2
  { name:'Grandma-ma',      avgThrow: 28, checkoutRate: 0.12, hitRate: 0.45 }, // L3
  { name:'Pub Drunk',    avgThrow: 36, checkoutRate: 0.18, hitRate: 0.52 }, // L4
  { name:'Regular Bloke',         avgThrow: 45, checkoutRate: 0.25, hitRate: 0.60 }, // L5
  { name:'Exceptional Pub Drunk',    avgThrow: 54, checkoutRate: 0.33, hitRate: 0.68 }, // L6
  { name:'County',       avgThrow: 64, checkoutRate: 0.42, hitRate: 0.76 }, // L7
  { name:'Semi-Pro',     avgThrow: 74, checkoutRate: 0.52, hitRate: 0.84 }, // L8
  { name:'Pro',          avgThrow: 85, checkoutRate: 0.64, hitRate: 0.90 }, // L9
  { name:'World Class',  avgThrow: 96, checkoutRate: 0.78, hitRate: 0.96 }, // L10
];


let botState = { score: 501, totalDarts: 0, throws: [], checkouts: 0, checkoutAttempts: 0 };

function resetBot(startScore) {
  botState = { score: startScore, totalDarts: 0, throws: [], checkouts: 0, checkoutAttempts: 0 };
}

function botThrowScore(level, remaining) {
  var p = BOT_PROFILES[level];
  if (!p) return 0;
  // Simulate 3-dart throw
  var variance = p.avgThrow * 0.35;
  var raw = p.avgThrow + (Math.random() - 0.5) * 2 * variance;
  raw = Math.max(0, Math.min(raw, 180));
  var score = Math.round(raw);
  // Near checkout: use checkout rate
  if (remaining <= 170) {
    if (remaining <= 40 && Math.random() < p.checkoutRate) {
      // Checkout!
      return remaining; // exact checkout
    }
    score = Math.min(score, remaining - 2); // don't accidentally bust
    if (score < 0) score = 0;
  }
  return score;
}

function runBotTurn(level, startScore) {
  var p = BOT_PROFILES[level];
  if (!p) return null;
  var score = botThrowScore(level, startScore);
  var remaining = startScore - score;
  var checkout = remaining === 0;
  var bust = remaining < 0 || (remaining === 1 && document.getElementById('out-mode').value === 'double');
  if (bust) { score = 0; remaining = startScore; }
  return { score, remaining, checkout, bust, botName: p.name };
}

function displayBotTurn(result, level) {
  var el = document.getElementById('bot-turn-overlay');
  if (!el || !result) return;
  var p = BOT_PROFILES[level];
  var msg = p.name + ' threw ';
  if (result.bust) msg += result.score + ' — BUST';
  else if (result.checkout) msg += result.score + ' — CHECKOUT! 🎯';
  else msg += result.score + ' · ' + result.remaining + ' remaining';
  el.textContent = msg;
  el.classList.add('visible');
  setTimeout(function() { el.classList.remove('visible'); }, 2200);
}

// ═══════════════════════════════════════════════════
//  GAME MODE SWITCH (01 vs Cricket)
// ═══════════════════════════════════════════════════
function onGameModeChange() {
  var mode = document.getElementById('game-mode').value;
  var cricketUI = document.getElementById('cricket-ui');
  var standardUI = document.getElementById('standard-ui');
  var outModeSelect = document.getElementById('out-mode');
  var scoreHero = document.querySelector('.score-hero');
  var scoreMeta = document.querySelector('.score-meta');
  var botLevelSelect = document.getElementById('bot-level');

  if (mode === 'cricket') {
    cricketUI.style.display = 'block';
    standardUI.style.display = 'none';
    outModeSelect.parentElement && (outModeSelect.style.display = 'none');
    scoreHero && (scoreHero.style.display = 'none');
    scoreMeta && (scoreMeta.style.display = 'none');
    botLevelSelect.style.display = 'inline-block'; // bots work in cricket too
    newCricketLeg();
  } else {
    cricketUI.style.display = 'none';
    standardUI.style.display = 'block';
    outModeSelect && (outModeSelect.style.display = 'inline-block');
    scoreHero && (scoreHero.style.display = 'flex');
    scoreMeta && (scoreMeta.style.display = 'grid');
  }
}

// ═══════════════════════════════════════════════════
//  CRICKET GAME ENGINE
// ═══════════════════════════════════════════════════
const CRICKET_NUMS = [20, 19, 18, 17, 16, 15, 'B']; // B = Bull (25/50)

// marks: 0=none, 1=slash, 2=X, 3=circled-X (owned), 4=closed (both have 3)
let cricketState = {
  you: { marks: {}, score: 0, misses: {} },
  bot: { marks: {}, score: 0, misses: {} },
  currentMult: 1,  // 0 = Miss mode
  dartsLeft: 3,
  yourTurn: true,
  round: 1,
  history: [], // { turn:'you'|'bot', num, mult, marks_after, score_gained }
  legs: 0,
  botLevel: 0,
};

function initCricketMarks() {
  var m = {};
  CRICKET_NUMS.forEach(function(n) { m[String(n)] = 0; });
  return m;
}

function newCricketLeg() {
  var botLvl = parseInt(document.getElementById('bot-level').value) || 0;
  var initMisses = function() { var m={}; CRICKET_NUMS.forEach(function(n){m[String(n)]=0;}); return m; };
  cricketState = {
    you: { marks: initCricketMarks(), score: 0, misses: initMisses() },
    bot: { marks: initCricketMarks(), score: 0, misses: initMisses() },
    currentMult: 1,
    dartsLeft: 3,
    yourTurn: true,
    round: 1,
    history: [],
    legs: cricketState.legs,
    botLevel: botLvl,
  };
  renderCricketBoard();
  renderCricketNumBtns();
  updateCricketTurnInfo();
}

// Mark symbol SVG
function markSvg(marks, color) {
  var sz = 38;
  var c = color || '#e8ff3a';
  if (marks === 0) return '<svg width="' + sz + '" height="' + sz + '"></svg>';
  if (marks === 1) {
    // Single slash /
    return '<svg width="' + sz + '" height="' + sz + '" viewBox="0 0 38 38">'
      + '<line x1="24" y1="4" x2="14" y2="34" stroke="' + c + '" stroke-width="3" stroke-linecap="round"/>'
      + '</svg>';
  }
  if (marks === 2) {
    // X (two slashes)
    return '<svg width="' + sz + '" height="' + sz + '" viewBox="0 0 38 38">'
      + '<line x1="8" y1="6" x2="30" y2="32" stroke="' + c + '" stroke-width="3" stroke-linecap="round"/>'
      + '<line x1="30" y1="6" x2="8" y2="32" stroke="' + c + '" stroke-width="3" stroke-linecap="round"/>'
      + '</svg>';
  }
  // 3+ = circled X
  return '<svg width="' + sz + '" height="' + sz + '" viewBox="0 0 38 38">'
    + '<line x1="8" y1="6" x2="30" y2="32" stroke="' + c + '" stroke-width="3" stroke-linecap="round"/>'
    + '<line x1="30" y1="6" x2="8" y2="32" stroke="' + c + '" stroke-width="3" stroke-linecap="round"/>'
    + '<circle cx="19" cy="19" r="16" stroke="' + c + '" stroke-width="2.5" fill="none"/>'
    + '</svg>';
}

function renderCricketBoard() {
  var board = document.getElementById('cricket-board');
  if (!board) return;
  var botName = cricketState.botLevel > 0
    ? (BOT_PROFILES[cricketState.botLevel] ? BOT_PROFILES[cricketState.botLevel].name : 'BOT')
    : 'BOT';

  // Header with player names AND running scores
  var html = '<div class="cricket-header">'
    + '<div class="ch-player you">YOU<span class="ch-score">' + cricketState.you.score + '</span></div>'
    + '<div class="ch-middle-header">NUM</div>'
    + '<div class="ch-player bot">' + botName + '<span class="ch-score">' + cricketState.bot.score + '</span></div>'
    + '</div>';

  // One row per number, marks on each side, number in centre
  CRICKET_NUMS.forEach(function(n) {
    var key = String(n);
    var yMarks = cricketState.you.marks[key] || 0;
    var bMarks = cricketState.bot.marks[key] || 0;
    var bothClosed = yMarks >= 3 && bMarks >= 3;
    var numLabel = n === 'B' ? 'BULL' : n;
    var numClass = 'cricket-num'
      + (bothClosed ? ' closed-both' : '')
      + (yMarks >= 3 && !bothClosed ? ' owned-you' : '')
      + (bMarks >= 3 && !bothClosed ? ' owned-bot' : '');
    var rowClass = 'cricket-row' + (bothClosed ? ' fully-closed' : '');
    var yMisses = (cricketState.you.misses && cricketState.you.misses[key]) || 0;
    var missDots = '';
    for (var d = 0; d < yMisses; d++) missDots += '<span class="cricket-miss-dot"></span>';
    var missHtml = yMisses > 0 ? '<div class="cricket-miss-dots">' + missDots + '</div>' : '';
    html += '<div class="' + rowClass + '">'
      + '<div class="cricket-marks you" onclick="cricketNumClick(\'' + key + '\')" style="cursor:pointer">'
      + markSvg(Math.min(yMarks, 3), '#e8ff3a') + missHtml + '</div>'
      + '<div class="' + numClass + '">' + numLabel + '</div>'
      + '<div class="cricket-marks bot" style="justify-content:flex-end">'
      + markSvg(Math.min(bMarks, 3), '#a78bfa') + '</div>'
      + '</div>';
  });

  board.innerHTML = html;
}

function renderCricketNumBtns() {
  var container = document.getElementById('cricket-num-btns');
  if (!container) return;
  var html = '';
  CRICKET_NUMS.forEach(function(n) {
    var key = String(n);
    var yMarks = cricketState.you.marks[key] || 0;
    var bMarks = cricketState.bot.marks[key] || 0;
    var bothClosed = yMarks >= 3 && bMarks >= 3;
    var owned = yMarks >= 3 && !bothClosed;
    var cls = 'cricket-num-btn'
      + (bothClosed ? ' closed' : '')
      + (owned ? ' owned' : '');
    var label = n === 'B' ? 'BULL' : n;
    html += '<button class="' + cls + '" onclick="cricketNumClick(\'' + key + '\')">' + label + '</button>';
  });
  container.innerHTML = html;
}

function updateCricketTurnInfo() {
  var ti = document.getElementById('cricket-turn-info');
  var wt = document.getElementById('cricket-whose-turn');
  var dp = document.getElementById('cricket-dart-pips');
  if (!ti) return;
  var dl = cricketState.dartsLeft;
  var pips = '';
  for (var i = 0; i < 3; i++) {
    pips += (i < dl) ? '● ' : '○ ';
  }
  if (dp) dp.textContent = pips.trim();
  if (wt) {
    if (cricketState.yourTurn) {
      wt.textContent = 'YOUR TURN';
      wt.style.color = 'var(--accent)';
    } else {
      var botName = cricketState.botLevel > 0 && BOT_PROFILES[cricketState.botLevel]
        ? BOT_PROFILES[cricketState.botLevel].name.toUpperCase()
        : "BOT'S TURN";
      wt.textContent = botName + "'S TURN";
      wt.style.color = 'var(--accent4)';
    }
  }
}

function setCricketMult(n, btn) {
  cricketState.currentMult = n;
  document.querySelectorAll('.cricket-mult-btn').forEach(function(b) { b.classList.remove('active'); });
  btn.classList.add('active');
  // Update num-btn labels to hint miss mode
  var isMiss = (n === 0);
  document.querySelectorAll('.cricket-num-btn').forEach(function(b) {
    b.style.borderColor = isMiss ? 'rgba(255,77,77,0.35)' : '';
    b.style.color = isMiss ? 'var(--accent2)' : '';
  });
}

function cricketNumClick(key) {
  if (!cricketState.yourTurn) return;
  if (cricketState.currentMult === 0) {
    applyMiss('you', key);
  } else {
    applyMarks('you', key, cricketState.currentMult);
  }
}

function applyMiss(player, key) {
  // Record a miss at this target — burns a dart, shows dot on board, no marks scored
  var gs = cricketState[player];
  if (!gs.misses) gs.misses = {};
  gs.misses[key] = (gs.misses[key] || 0) + 1;

  renderCricketBoard();

  // Reset to Single after miss (same as after any dart)
  cricketState.currentMult = 1;
  document.querySelectorAll('.cricket-mult-btn').forEach(function(b) { b.classList.remove('active'); });
  var single = document.getElementById('cm-single');
  if (single) single.classList.add('active');
  document.querySelectorAll('.cricket-num-btn').forEach(function(b) {
    b.style.borderColor = ''; b.style.color = '';
  });

  cricketState.dartsLeft--;
  updateCricketTurnInfo();
  if (cricketState.dartsLeft <= 0) endCricketPlayerTurn();
}

function applyMarks(player, key, mult) {
  // mult = how many marks this dart scores (1=single, 2=double, 3=treble)
  var gs = cricketState[player];
  var opp = player === 'you' ? 'bot' : 'you';
  var oppGs = cricketState[opp];
  var current = gs.marks[key] || 0;
  var oppMarks = oppGs.marks[key] || 0;

  if (current >= 3 && oppMarks >= 3) return; // fully closed, ignore

  var gained = 0;
  var newMarks = current;
  for (var i = 0; i < mult; i++) {
    if (newMarks < 3) {
      newMarks++;
    } else {
      // already owned — score points if opp hasn't closed
      if (oppMarks < 3) {
        var numVal = key === 'B' ? 25 : parseInt(key);
        gained += numVal;
      }
    }
  }
  // If already at 3+ before, all marks score if opp open
  gs.marks[key] = newMarks;
  gs.score += gained;

  renderCricketBoard();
  renderCricketNumBtns();

  // Advance dart count
  cricketState.dartsLeft--;
  updateCricketTurnInfo();

  // Reset multiplier to single after each dart
  cricketState.currentMult = 1;
  document.querySelectorAll('.cricket-mult-btn').forEach(function(b) { b.classList.remove('active'); });
  document.getElementById('cm-single') && document.getElementById('cm-single').classList.add('active');
  // Clear any miss-mode tinting on number buttons
  document.querySelectorAll('.cricket-num-btn').forEach(function(b) { b.style.borderColor = ''; b.style.color = ''; });

  if (cricketState.dartsLeft <= 0) {
    endCricketPlayerTurn();
  }

  // Check win
  checkCricketWin();
}

function cricketMiss() {
  if (!cricketState.yourTurn) return;
  cricketState.dartsLeft--;
  updateCricketTurnInfo();
  if (cricketState.dartsLeft <= 0) endCricketPlayerTurn();
}

function endCricketPlayerTurn() {
  cricketState.dartsLeft = 3;
  if (cricketState.yourTurn) {
    // Your turn done — bot goes if bot level set
    if (cricketState.botLevel > 0) {
      cricketState.yourTurn = false;
      updateCricketTurnInfo();
      setTimeout(runCricketBotTurn, 600);
    } else {
      // 2-player local: just flip turns (or solo practice: stay on you)
      cricketState.round++;
      updateCricketTurnInfo();
    }
  } else {
    cricketState.yourTurn = true;
    cricketState.round++;
    updateCricketTurnInfo();
  }
}

function runCricketBotTurn() {
  var lvl = cricketState.botLevel;
  var p = BOT_PROFILES[lvl];
  if (!p) { cricketState.yourTurn = true; updateCricketTurnInfo(); return; }

  // Bot AI: pick targets strategically
  var botOverlay = document.getElementById('bot-turn-overlay');
  var msgs = [];

  for (var d = 0; d < 3; d++) {
    if (checkCricketWinState()) break;
    var target = chooseBotCricketTarget(lvl);
    if (!target) break;
    var hit = Math.random() < p.hitRate;
    if (hit) {
      // What multiplier does bot use? Better bots go for trebles
      var multRoll = Math.random();
      var mult = 1;
      if (lvl >= 8 && multRoll < 0.40) mult = 3;
      else if (lvl >= 5 && multRoll < 0.25) mult = 3;
      else if (lvl >= 3 && multRoll < 0.20) mult = 2;
      applyBotMarks(target, mult, msgs);
    } else {
      msgs.push('Missed');
    }
  }

  if (botOverlay) {
    botOverlay.textContent = (p.name + ': ' + (msgs.length ? msgs.join(' · ') : 'All misses'));
    botOverlay.style.display = 'block';
    setTimeout(function() { botOverlay.style.display = 'none'; }, 2400);
  }

  cricketState.yourTurn = true;
  cricketState.dartsLeft = 3;
  renderCricketBoard();
  renderCricketNumBtns();
  updateCricketTurnInfo();
  checkCricketWin();
}

function applyBotMarks(key, mult, msgs) {
  var gs = cricketState.bot;
  var oppGs = cricketState.you;
  var current = gs.marks[key] || 0;
  var oppMarks = oppGs.marks[key] || 0;
  if (current >= 3 && oppMarks >= 3) return;

  var gained = 0;
  var newMarks = current;
  for (var i = 0; i < mult; i++) {
    if (newMarks < 3) { newMarks++; }
    else if (oppMarks < 3) {
      var numVal = key === 'B' ? 25 : parseInt(key);
      gained += numVal;
    }
  }
  gs.marks[key] = newMarks;
  gs.score += gained;

  var multLabel = mult === 3 ? 'T' : mult === 2 ? 'D' : 'S';
  var numLabel = key === 'B' ? 'Bull' : key;
  var scored = gained > 0 ? ' (+' + gained + ')' : '';
  msgs.push(multLabel + numLabel + (newMarks >= 3 && newMarks - mult < 3 ? ' ✓' : '') + scored);
}

function chooseBotCricketTarget(lvl) {
  // Strategy: close own open numbers first, then score on opponent's open numbers
  var openForBot = CRICKET_NUMS.map(String).filter(function(k) {
    return (cricketState.bot.marks[k] || 0) < 3;
  });
  var canScore = CRICKET_NUMS.map(String).filter(function(k) {
    return (cricketState.bot.marks[k] || 0) >= 3 && (cricketState.you.marks[k] || 0) < 3;
  });

  if (openForBot.length === 0 && canScore.length === 0) return null;

  // Higher level bots prefer scoring; lower bots just close
  var scoreWeight = lvl / 10.0;
  if (canScore.length > 0 && Math.random() < scoreWeight) {
    // Score on highest-value open number
    canScore.sort(function(a, b) {
      var av = a === 'B' ? 25 : parseInt(a);
      var bv = b === 'B' ? 25 : parseInt(b);
      return bv - av;
    });
    return canScore[0];
  }
  if (openForBot.length > 0) {
    // Close highest-value unclosed
    openForBot.sort(function(a, b) {
      var av = a === 'B' ? 25 : parseInt(a);
      var bv = b === 'B' ? 25 : parseInt(b);
      return bv - av;
    });
    return openForBot[0];
  }
  return canScore[0] || null;
}

function checkCricketWinState() {
  var youDone = CRICKET_NUMS.every(function(n) { return (cricketState.you.marks[String(n)] || 0) >= 3; });
  var botDone = CRICKET_NUMS.every(function(n) { return (cricketState.bot.marks[String(n)] || 0) >= 3; });
  return youDone || botDone;
}

function checkCricketWin() {
  var youDone = CRICKET_NUMS.every(function(n) { return (cricketState.you.marks[String(n)] || 0) >= 3; });
  var botDone = CRICKET_NUMS.every(function(n) { return (cricketState.bot.marks[String(n)] || 0) >= 3; });

  if (!youDone && !botDone) return;

  // Win condition: all closed AND higher or equal score
  var yScore = cricketState.you.score;
  var bScore = cricketState.bot.score;

  if (youDone && yScore >= bScore) {
    setTimeout(function() {
      toast('🏆 YOU WIN! ' + yScore + ' pts vs ' + bScore + ' pts');
      saveCricketLeg(true);
    }, 300);
  } else if (botDone && bScore >= yScore) {
    setTimeout(function() {
      var botName = cricketState.botLevel > 0 && BOT_PROFILES[cricketState.botLevel]
        ? BOT_PROFILES[cricketState.botLevel].name : 'Bot';
      toast(botName + ' wins! ' + bScore + ' vs ' + yScore);
      saveCricketLeg(false);
    }, 300);
  } else if (youDone && yScore < bScore) {
    // Must keep scoring to catch up
    toast('You closed all — but behind on points! Keep scoring.', true);
  } else if (botDone && bScore < yScore) {
    toast('Bot closed all — but you\'re ahead! Keep closing.', true);
  }
}

function saveCricketLeg(youWon) {
  var leg = {
    type: 'cricket',
    timestamp: Date.now(),
    round: cricketState.round,
    yourScore: cricketState.you.score,
    botScore: cricketState.bot.score,
    botLevel: cricketState.botLevel,
    youWon: youWon,
    marks: JSON.parse(JSON.stringify(cricketState.you.marks)),
    misses: JSON.parse(JSON.stringify(cricketState.you.misses || {})),
  };
  if (!state.cricketLegs) state.cricketLegs = [];
  state.cricketLegs.push(leg);
  saveState();
  cricketState.legs++;
}

// ═══════════════════════════════════════════════════
//  CRICKET VOICE INPUT
// ═══════════════════════════════════════════════════
var cricketRecognition = null;
var cricketVoiceActive = false;

function initCricketVoice() {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SpeechRecognition) return false;
  cricketRecognition = new SpeechRecognition();
  cricketRecognition.lang = 'en-GB';
  cricketRecognition.interimResults = true;
  cricketRecognition.continuous = false;
  cricketRecognition.maxAlternatives = 4;

  cricketRecognition.onstart = function() {
    cricketVoiceActive = true;
    var btn = document.getElementById('cricket-voice-btn');
    if (btn) btn.classList.add('listening');
    setCricketTranscript('Listening…', '');
  };

  cricketRecognition.onresult = function(e) {
    var results = e.results[e.results.length - 1];
    var interim = results[0].transcript;
    setCricketTranscript(interim, '');

    if (results.isFinal) {
      var parsed = null;
      for (var i = 0; i < results.length; i++) {
        parsed = parseCricketVoice(results[i].transcript);
        if (parsed) break;
      }
      if (parsed) {
        setCricketTranscript('"' + results[0].transcript + '" → ' + parsed.label, 'heard');
        applyCricketVoiceThrow(parsed);
        // Restart for next dart if more to throw
        if (cricketState.yourTurn && cricketState.dartsLeft > 0) {
          setTimeout(function() {
            try { cricketRecognition.start(); } catch(e) {}
          }, 400);
        }
      } else {
        setCricketTranscript('Didn\'t catch that — say "Single 20" etc.', '');
      }
    }
  };

  cricketRecognition.onerror = function(e) {
    cricketVoiceActive = false;
    var btn = document.getElementById('cricket-voice-btn');
    if (btn) btn.classList.remove('listening');
    if (e.error !== 'no-speech' && e.error !== 'aborted') {
      setCricketTranscript('Mic error — check permissions', '');
    }
  };

  cricketRecognition.onend = function() {
    cricketVoiceActive = false;
    var btn = document.getElementById('cricket-voice-btn');
    if (btn) btn.classList.remove('listening');
  };

  return true;
}

function toggleCricketVoice() {
  if (!cricketRecognition) {
    var ok = initCricketVoice();
    if (!ok) { toast('Voice not supported in this browser', true); return; }
  }
  if (cricketVoiceActive) {
    cricketRecognition.stop();
    return;
  }
  try { cricketRecognition.start(); }
  catch(e) {
    cricketRecognition = null;
    initCricketVoice();
    try { cricketRecognition.start(); } catch(e2) { toast('Voice error — try again', true); }
  }
}

function setCricketTranscript(text, cls) {
  var el = document.getElementById('cricket-voice-transcript');
  if (!el) return;
  el.textContent = text;
  el.style.color = cls === 'heard' ? 'var(--accent3)' : 'var(--muted)';
}

function parseCricketVoice(raw) {
  var text = raw.toLowerCase().trim();
  // Normalise triple→treble
  text = text.replace(/\btriple\b/g, 'treble');

  // Miss / no score
  if (/\b(miss|missed|no score|out)\b/.test(text)) {
    return { type: 'miss', label: 'MISS' };
  }

  // Bull / bullseye variants
  var bullDouble = /\b(double bull|inner bull|bullseye double|db|50)\b/.test(text);
  var bullSingle = /\b(bull|bullseye|outer bull|25|single bull)\b/.test(text);
  if (bullDouble) return { type: 'hit', key: 'B', mult: 2, label: 'D-Bull' };
  if (bullSingle) return { type: 'hit', key: 'B', mult: 1, label: 'S-Bull' };

  // Number words → digits
  var wordMap = {
    'fifteen':15,'sixteen':16,'seventeen':17,'eighteen':18,'nineteen':19,'twenty':20,
    'fifteen':15,'sixteen':16,'seventeen':17,'eighteen':18,'nineteen':19,'twenty':20
  };
  Object.keys(wordMap).forEach(function(w) {
    text = text.replace(new RegExp('\\b' + w + '\\b', 'g'), String(wordMap[w]));
  });

  // Match: (single|double|treble) + (15-20)
  // or: (15-20) + (single|double|treble)
  var multMap = { single: 1, double: 2, treble: 3 };
  var patterns = [
    /\b(single|double|treble)\s+(1[5-9]|20)\b/,
    /\b(1[5-9]|20)\s+(single|double|treble)\b/,
    /\b(single|double|treble)\s+(1[5-9]|20)\b/,
  ];

  // Try pattern: mult then num
  var m = text.match(/\b(single|double|treble)\s+(1[5-9]|20)\b/);
  if (m) {
    var mult = multMap[m[1]];
    var num = parseInt(m[2]);
    return { type: 'hit', key: String(num), mult: mult, label: m[1].charAt(0).toUpperCase() + ' ' + num };
  }
  // Try pattern: num then mult
  m = text.match(/\b(1[5-9]|20)\s+(single|double|treble)\b/);
  if (m) {
    var num = parseInt(m[1]);
    var mult = multMap[m[2]];
    return { type: 'hit', key: String(num), mult: mult, label: m[2].charAt(0).toUpperCase() + ' ' + num };
  }
  // Just a number with no multiplier? Treat as single
  m = text.match(/\b(1[5-9]|20)\b/);
  if (m) {
    return { type: 'hit', key: m[1], mult: 1, label: 'S ' + m[1] };
  }

  return null;
}

function applyCricketVoiceThrow(parsed) {
  if (!cricketState.yourTurn) return;
  if (parsed.type === 'miss') {
    cricketMiss();
  } else if (parsed.type === 'hit') {
    // Check number is valid for cricket
    if (!CRICKET_NUMS.map(String).includes(parsed.key)) return;
    applyMarks('you', parsed.key, parsed.mult);
  }
}


// ═══════════════════════════════════════════════════
//  CHECKOUT ROUTES  (standard double-out routes)
// ═══════════════════════════════════════════════════
// Format: score → array of routes, each route = array of dart labels
// Labels: T=treble, D=double, B=bullseye (50), OB=outer bull (25), S=single
const CHECKOUT_ROUTES = {
  170: [['T20','T20','Bull']],
  167: [['T20','T19','Bull']],
  164: [['T20','T18','Bull'],['T19','T19','Bull']],
  161: [['T20','T17','Bull'],['T19','T18','Bull']],
  160: [['T20','T20','D20']],
  158: [['T20','T20','D19']],
  157: [['T20','T19','D20']],
  156: [['T20','T20','D18']],
  155: [['T20','T19','D19'],['T20','T15','Bull']],
  154: [['T20','T18','D20'],['T20','T20','D17']],
  153: [['T20','T19','D18'],['T20','T17','D20']],
  152: [['T20','T20','D16'],['T20','T18','D19']],
  151: [['T20','T17','D20'],['T20','T19','D17']],
  150: [['T20','T18','D18'],['T20','T20','D15'],['Bull','T20','D20']],
  149: [['T20','T19','D16'],['T20','T17','D19']],
  148: [['T20','T16','D20'],['T20','T20','D14']],
  147: [['T20','T17','D18'],['T19','T18','D18']],
  146: [['T20','T18','D16'],['T20','T14','D20']],
  145: [['T20','T19','D14'],['T20','T15','D20'],['T20','T17','D17']],
  144: [['T20','T20','D12'],['T20','T16','D18']],
  143: [['T20','T17','D16'],['T19','T18','D16']],
  142: [['T20','T14','D20'],['T20','T18','D16']],
  141: [['T20','T19','D12'],['T20','T15','D18']],
  140: [['T20','T20','D10'],['T20','T16','D16']],
  139: [['T20','T13','D20'],['T19','T14','D20']],
  138: [['T20','T18','D12'],['T20','T14','D18']],
  137: [['T20','T19','D10'],['T20','T15','D16']],
  136: [['T20','T20','D8'],['T20','T16','D14']],
  135: [['T20','T17','D12'],['Bull','T15','D20'],['T20','T13','D18']],
  134: [['T20','T14','D16'],['T20','T18','D10']],
  133: [['T20','T19','D8'],['T20','T11','D20']],
  132: [['T20','T16','D12'],['Bull','T14','D20']],
  131: [['T20','T13','D16'],['T20','T17','D10']],
  130: [['T20','T18','D8'],['T20','T20','D5'],['Bull','T20','D10']],
  129: [['T19','T16','D12'],['T20','T11','D18']],
  128: [['T18','T14','D20'],['T20','T20','D4']],
  127: [['T20','T17','D8'],['T20','T11','D17']],
  126: [['T19','T19','D6'],['T20','T14','D12']],
  125: [['T20','T15','D10'],['Bull','T15','D20'],['T20','T11','D16']],
  124: [['T20','T16','D8'],['T20','T14','D11']],
  123: [['T19','T16','D9'],['T20','T13','D12']],
  122: [['T18','T18','D7'],['T20','T10','D16']],
  121: [['T20','T11','D14'],['T17','T18','D10']],
  120: [['T20','S20','D20'],['T20','T20','D0'],['T17','T19','D6']],  // T20 S20 D20 is standard
  119: [['T19','T12','D13'],['T20','S19','D20']],
  118: [['T20','S18','D20'],['T20','T12','D11']],
  117: [['T20','S17','D20'],['T19','T16','D6']],
  116: [['T20','S16','D20'],['T19','T19','D0'],['T20','T12','D10']],
  115: [['T20','S15','D20'],['T19','T18','D0'],['T20','T11','D11']],
  114: [['T20','S14','D20'],['T20','T14','D8']],
  113: [['T20','S13','D20'],['T20','T11','D10']],
  112: [['T20','S12','D20'],['T20','T12','D8']],
  111: [['T20','S11','D20'],['T20','T11','D9']],
  110: [['T20','S10','D20'],['T20','Bull','D5']],
  109: [['T20','S9','D20'],['T19','T12','D8']],
  108: [['T20','S8','D20'],['T20','T12','D6']],
  107: [['T19','S10','D20'],['T20','S7','D20']],
  106: [['T20','S6','D20'],['T20','T10','D8']],
  105: [['T20','S5','D20'],['T19','S16','D16']],
  104: [['T18','S18','D16'],['T20','S4','D20']],
  103: [['T20','S3','D20'],['T19','S6','D20']],
  102: [['T20','S2','D20'],['T20','T10','D6']],
  101: [['T17','S10','D20'],['T20','S1','D20']],
  100: [['T20','D20'],['T18','S16','D16']],     // 2-dart
  99:  [['T19','S18','D16'],['T19','D21']],       // T19+D21 invalid, use standard
  99:  [['T19','S10','D16'],['T17','S18','D16']],
  98:  [['T20','D19'],['T18','D16']],
  97:  [['T19','D20'],['T20','S17','D16']],
  96:  [['T20','D18'],['T24','..'],['T20','D18']],
  96:  [['T20','D18'],['T16','D24']],
  95:  [['T19','D19'],['T20','S15','D10']],
  94:  [['T18','D20'],['T20','D17']],
  93:  [['T19','D18'],['T17','D21']],
  93:  [['T19','D18'],['T17','S18','D9']],
  92:  [['T20','D16'],['T16','D22']],
  91:  [['T17','D20'],['T19','D17']],
  90:  [['T18','D18'],['T20','D15'],['T14','D24']],
  89:  [['T19','D16'],['T17','D19']],
  88:  [['T20','D14'],['T16','D20']],
  87:  [['T17','D18'],['T15','D21']],
  87:  [['T17','D18'],['T13','D24']],
  86:  [['T18','D16'],['T14','D22']],
  85:  [['T15','D20'],['T19','D14']],
  84:  [['T20','D12'],['T16','D18']],
  83:  [['T17','D16'],['T19','D13']],
  82:  [['T14','D20'],['T18','D14']],
  81:  [['T19','D12'],['T15','D18'],['T17','D15']],
  80:  [['T16','D16'],['T20','D10']],
  79:  [['T13','D20'],['T19','D11'],['T17','D14']],
  78:  [['T18','D12'],['T14','D18']],
  77:  [['T19','D10'],['T15','D16'],['T13','D19']],
  76:  [['T20','D8'],['T16','D14']],
  75:  [['T17','D12'],['T15','D15'],['T13','D18']],
  74:  [['T14','D16'],['T18','D10']],
  73:  [['T19','D8'],['T13','D16'],['T11','D20']],
  72:  [['T16','D12'],['T12','D18']],
  71:  [['T13','D16'],['T17','D10']],
  70:  [['T10','D20'],['T18','D8']],
  69:  [['T19','D6'],['T11','D18'],['T15','D12']],
  68:  [['T20','D4'],['T16','D10']],
  67:  [['T17','D8'],['T9','D20']],
  66:  [['T10','D18'],['T14','D12']],
  65:  [['T19','D4'],['T11','D16'],['Bull','D15']],
  64:  [['T16','D8'],['T14','D11']],
  63:  [['T13','D12'],['T9','D18'],['T17','D6']],
  62:  [['T10','D16'],['T12','D13']],
  61:  [['T15','D8'],['T7','D20'],['T11','D14']],
  60:  [['S20','D20'],['T12','D12'],['T20','D0']],
  59:  [['S19','D20'],['T13','D10']],
  58:  [['S18','D20'],['T10','D14']],
  57:  [['S17','D20'],['T19','D0'],['T7','D18']],
  56:  [['T16','D4'],['S16','D20']],
  55:  [['S15','D20'],['T7','D17'],['T13','D8']],
  54:  [['S14','D20'],['T18','D0'],['T14','D6']],
  53:  [['S13','D20'],['T11','D10']],
  52:  [['S12','D20'],['T12','D8']],
  51:  [['S11','D20'],['T17','D0'],['T9','D12']],
  50:  [['Bull'],['S10','D20'],['T10','D10']],
  49:  [['S9','D20'],['T11','D8'],['T7','D14']],
  48:  [['S16','D16'],['T8','D12'],['S8','D20']],
  47:  [['S15','D16'],['S7','D20'],['T9','D10']],
  46:  [['S6','D20'],['S14','D16']],
  45:  [['S13','D16'],['S5','D20'],['S9','D18']],
  44:  [['S12','D16'],['S4','D20']],
  43:  [['S11','D16'],['S3','D20'],['S7','D18']],
  42:  [['S10','D16'],['S2','D20']],
  41:  [['S9','D16'],['S1','D20'],['S5','D18']],
  40:  [['D20']],
  39:  [['S7','D16'],['S3','D18']],
  38:  [['D19'],['S6','D16']],
  37:  [['S5','D16'],['S1','D18']],
  36:  [['D18']],
  35:  [['S3','D16'],['S1','D17']],
  34:  [['D17'],['S2','D16']],
  33:  [['S1','D16'],['S5','D14'],['S9','D12']],
  32:  [['D16']],
  31:  [['S7','D12'],['S1','D15']],
  30:  [['D15'],['S10','D10']],
  29:  [['S1','D14'],['S3','D13']],
  28:  [['D14'],['S12','D8']],
  27:  [['S3','D12'],['S7','D10']],
  26:  [['D13'],['S10','D8'],['S6','D10']],
  25:  [['S9','D8'],['S1','D12']],
  24:  [['D12'],['S8','D8']],
  23:  [['S7','D8'],['S1','D11']],
  22:  [['D11'],['S6','D8']],
  21:  [['S5','D8'],['S1','D10']],
  20:  [['D10'],['S4','D8']],
  18:  [['D9'],['S2','D8']],
  16:  [['D8'],['S8','D4']],
  14:  [['D7'],['S6','D4']],
  12:  [['D6'],['S4','D4']],
  10:  [['D5'],['S2','D4']],
  8:   [['D4'],['S8','D0']],
  6:   [['D3'],['S2','D2']],
  4:   [['D2']],
  2:   [['D1']],
};

function getCheckoutRoutes(score) {
  if (score < 2 || score > 170) return [];
  // Try exact match first
  let routes = CHECKOUT_ROUTES[score];
  if (routes && routes.length > 0) return routes.slice(0, 3);
  // For odd scores not in table, find nearest standard route
  return [];
}

function dartClass(dart) {
  if (!dart) return 'single';
  if (dart.startsWith('T')) return 'treble';
  if (dart.startsWith('D')) return 'double';
  if (dart === 'Bull') return 'bull';
  if (dart === 'OB') return 'bull';
  return 'single';
}

function dartLabel(dart) {
  if (!dart) return '';
  if (dart === 'Bull') return 'BULL';
  if (dart === 'OB') return '25';
  if (dart.startsWith('T')) return 'T' + dart.slice(1);
  if (dart.startsWith('D')) return 'D' + dart.slice(1);
  if (dart.startsWith('S')) return dart.slice(1);
  return dart;
}

function updateCheckoutRoute(score) {
  const panel = document.getElementById('checkout-route-panel');
  const list = document.getElementById('checkout-routes-list');
  if (!panel || !list) return;

  // Show panel for ≤170
  if (score > 170 || score <= 1) {
    panel.classList.remove('visible');
    return;
  }

  const routes = getCheckoutRoutes(score);
  if (!routes || routes.length === 0) {
    panel.classList.remove('visible');
    return;
  }

  panel.classList.add('visible');
  list.innerHTML = routes.map(function(route, idx) {
    const darts = route.map(function(d) {
      return '<span class="checkout-dart ' + dartClass(d) + '">' + dartLabel(d) + '</span>';
    }).join('<span class="checkout-arrow">→</span>');
    return '<div class="checkout-route-row">'
      + '<span class="checkout-route-rank">' + (idx + 1) + '</span>'
      + darts
      + '</div>';
  }).join('');
}

// ── Score display helpers (solo vs bot mode) ──
function updateScoreDisplays(yourScore) {
  const botLvl = parseInt(document.getElementById('bot-level').value) || 0;

  // Always keep the hidden solo score-display in sync (voice + submit logic reads it)
  const sd = document.getElementById('score-display');
  if (sd) sd.textContent = yourScore;

  if (botLvl > 0) {
    // ── Dual score mode ──
    document.getElementById('score-hero-solo').style.display = 'none';
    document.getElementById('score-hero-bot').style.display = 'grid';
    document.getElementById('bot-voice-row').style.display = 'block';

    // YOUR score — always write
    const youNumEl = document.getElementById('score-display-you');
    if (youNumEl) youNumEl.textContent = yourScore;

    // BOT score — always read from leg state
    const botScore = (currentLeg && currentLeg._botScore != null)
      ? currentLeg._botScore
      : (currentLeg ? currentLeg.startScore : 501);
    const botNumEl = document.getElementById('score-display-bot');
    if (botNumEl) { botNumEl.textContent = botScore; botNumEl.style.color = ''; }

    // Sub-label: checkout range hint
    const youSub = document.getElementById('score-vs-sub-you');
    if (youSub) {
      youSub.textContent = yourScore <= 170 && yourScore > 1 ? '🎯 CHECKOUT RANGE' : '';
    }

    // Bot name
    const p = BOT_PROFILES[botLvl];
    const nameEl = document.getElementById('score-vs-bot-name');
    if (nameEl && p) nameEl.textContent = p.name.toUpperCase();

  } else {
    // ── Solo mode ──
    document.getElementById('score-hero-solo').style.display = '';
    document.getElementById('score-hero-bot').style.display = 'none';
    document.getElementById('bot-voice-row').style.display = 'none';
  }

  updateCheckoutRoute(yourScore);
}

// ═══════════════════════════════════════════════════
//  HISTORY PAGE
// ═══════════════════════════════════════════════════

// ═══════════════════════════════════════════════════
//  THROW EDITING
// ═══════════════════════════════════════════════════
let _editThrowIdx = null; // index into currentLeg.throws[] being edited

function openEditThrow(idx, btn) {
  const throw_ = currentLeg.throws[idx];
  if (!throw_) return;
  _editThrowIdx = idx;
  const roundNum = idx + 1;
  document.getElementById('edit-throw-was').textContent = throw_.bust ? throw_.score + ' (BUST)' : throw_.score;
  document.getElementById('edit-throw-sub').innerHTML =
    'Round ' + roundNum + ' &mdash; was <strong>' + (throw_.bust ? throw_.score + ' (BUST)' : throw_.score) + '</strong>. Enter correct score (0–180):';
  const input = document.getElementById('edit-throw-input');
  input.value = throw_.score;
  document.getElementById('edit-throw-modal').style.display = 'flex';
  setTimeout(() => { input.select(); }, 50);
}

function closeEditThrow() {
  document.getElementById('edit-throw-modal').style.display = 'none';
  _editThrowIdx = null;
}

function confirmEditThrow() {
  if (_editThrowIdx === null) return;
  const input = document.getElementById('edit-throw-input');
  const newScore = parseInt(input.value);
  if (isNaN(newScore) || newScore < 0 || newScore > 180) {
    toast('Enter a valid score (0–180)', true);
    input.focus();
    return;
  }

  const idx = _editThrowIdx;
  closeEditThrow();

  // Replay the leg from scratch using the edited throws array
  // Build a fresh throws list with the corrected entry
  const oldThrows = currentLeg.throws.slice();
  oldThrows[idx] = { ...oldThrows[idx], score: newScore };

  // Recalculate the leg state by replaying all throws
  let runningScore = currentLeg.startScore;
  const newThrows = [];

  for (let i = 0; i < oldThrows.length; i++) {
    const t = oldThrows[i];
    const remaining = runningScore - t.score;
    const isBust = remaining < 0 || (remaining === 1 && currentLeg.outMode === 'double');
    const isCheckout = !isBust && remaining === 0;

    if (isBust) {
      newThrows.push({ score: t.score, remaining: runningScore, bust: true });
      // runningScore unchanged on bust
    } else if (isCheckout) {
      newThrows.push({ score: t.score, remaining: 0, bust: false, checkout: true });
      runningScore = 0;
      break;
    } else {
      newThrows.push({ score: t.score, remaining, bust: false });
      runningScore = remaining;
    }
  }

  // Recalculate leg totals
  const totalDarts = newThrows.length * 3;
  const checkouts = newThrows.filter(t => t.checkout).length;
  const checkoutAttempts = newThrows.filter((t, i) => {
    // A checkout attempt is when remaining was ≤ 170 before this throw
    let rem = currentLeg.startScore;
    for (let j = 0; j < i; j++) {
      if (!newThrows[j].bust) rem = newThrows[j].remaining;
    }
    return rem <= 170 && !t.bust;
  }).length;

  // Update leg state
  currentLeg.throws = newThrows;
  currentLeg.totalDarts = totalDarts;
  currentLeg.score = runningScore;
  currentLeg.round = newThrows.length + 1;
  currentLeg.checkouts = checkouts;
  currentLeg.checkoutAttempts = Math.max(checkoutAttempts, checkouts);

  // Rebuild throw history UI
  const hist = document.getElementById('throw-history');
  hist.innerHTML = '';
  for (let i = 0; i < newThrows.length; i++) {
    const t = newThrows[i];
    addThrowRow(t.score, t.bust ? currentLeg.startScore : t.remaining, t.bust, !!t.checkout, false);
  }

  // Update score display and meta
  updateScoreDisplays(runningScore);
  updateMeta();
  toast('Score corrected — leg recalculated');

  // If the edited throw caused a checkout, complete the leg
  if (runningScore === 0) {
    setTimeout(() => completeLeg(), 600);
  }
}
function renderHistoryPage() {
  const el = document.getElementById('history-list');
  const filter = document.getElementById('history-filter') ? document.getElementById('history-filter').value : 'all';

  // Cricket legs section
  let cricketHtml = '';
  if ((state.cricketLegs || []).length > 0 && (filter === 'all' || filter === 'cricket')) {
    const legs = [...state.cricketLegs].reverse().slice(0, 20);
    cricketHtml = '<div style="font-family:Bebas Neue,sans-serif;font-size:18px;letter-spacing:3px;color:var(--accent);margin-bottom:12px;margin-top:8px;">CRICKET LEGS</div>';
    cricketHtml += legs.map(function(l) {
      const dt = new Date(l.timestamp).toLocaleDateString('en-GB', {day:'numeric',month:'short'});
      const result = l.youWon ? '<span style="color:var(--accent3)">WIN</span>' : '<span style="color:var(--accent2)">LOSS</span>';
      const botLabel = l.botLevel > 0 && BOT_PROFILES[l.botLevel] ? BOT_PROFILES[l.botLevel].name : 'Solo';
      return '<div class="history-session-card" style="border-left:2px solid ' + (l.youWon ? 'var(--accent3)' : 'var(--accent2)') + '">'
        + '<div class="history-session-header">'
        + '<div class="history-session-date">' + dt + '</div>'
        + '<div class="history-session-meta">Cricket · ' + botLabel + ' · Round ' + (l.round || '?') + '</div>'
        + '<div>' + result + '</div>'
        + '</div>'
        + '<div class="history-stat-chips">'
        + '<div class="history-chip"><label>Your Pts</label><span>' + l.yourScore + '</span></div>'
        + '<div class="history-chip"><label>' + botLabel + ' Pts</label><span>' + l.botScore + '</span></div>'
        + '</div></div>';
    }).join('');
  }

  let sessions = [...state.sessions].reverse();
  if (filter !== 'all' && filter !== 'cricket') {
    sessions = sessions.filter(function(s) { return s.legDetails && s.legDetails[0] && String(s.legDetails[0].score) === filter; });
  } else if (filter === 'cricket') {
    sessions = [];
  }

  if (sessions.length === 0 && !cricketHtml) {
    el.innerHTML = '<div style="font-family:DM Mono,monospace;font-size:12px;color:var(--muted);text-align:center;padding:40px;">No sessions yet — complete a practice session to see your history.</div>';
    return;
  }

  el.innerHTML = cricketHtml + sessions.map(function(s) {
    const feel = ['','😩','😕','😐','🙂','🔥'][s.feel] || '';
    const co = parseInt(s.checkoutPct);
    const coColor = co>=50?'var(--accent3)':co>=30?'var(--accent)':'var(--accent2)';
    const avgColor = parseFloat(s.avg)>=55?'var(--accent3)':'var(--text)';
    const notesHtml = s.notes ? '<div class="history-notes">' + s.notes + '</div>' : '';

    return '<div class="history-session-card">'
      + '<div class="history-session-header">'
      + '<div class="history-session-date">' + s.date + '</div>'
      + '<div class="history-session-meta">' + s.legs + ' leg' + (s.legs!==1?'s':'') + '</div>'
      + '<div class="history-session-feel">' + feel + '</div>'
      + '</div>'
      + '<div class="history-stat-chips">'
      + '<div class="history-chip"><label>Avg</label><span style="color:' + avgColor + '">' + s.avg + '</span></div>'
      + '<div class="history-chip"><label>CO%</label><span style="color:' + coColor + '">' + s.checkoutPct + '%</span></div>'
      + '<div class="history-chip"><label>Legs</label><span>' + s.legs + '</span></div>'
      + (s.checkouts !== undefined ? '<div class="history-chip"><label>Checkouts</label><span>' + s.checkouts + '/' + (s.checkoutAttempts||'?') + '</span></div>' : '')
      + '</div>'
      + notesHtml
      + '</div>';
  }).join('');
}

// ═══════════════════════════════════════════════════
//  TOAST
// ═══════════════════════════════════════════════════
function toast(msg, isError) {
  document.querySelectorAll('.toast').forEach(t=>t.remove());
  const el=document.createElement('div');
  el.className='toast'+(isError?' error':'');
  el.textContent=msg;
  document.body.appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

// ═══════════════════════════════════════════════════
//  KEYBOARD
// ═══════════════════════════════════════════════════
document.addEventListener('keydown', e=>{
  // Don't intercept if typing in an input or textarea
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if(e.key>='0'&&e.key<='9') numPress(parseInt(e.key));
  if(e.key==='Backspace') numDel();
  if(e.key==='Enter') submitScore();
  if(e.key==='b'||e.key==='B') bustScore();
  const onDrill = document.getElementById('page-drill').classList.contains('active');
  if(e.key==='h'||e.key==='H') { if(onDrill) logDrill('hit'); }
  if(e.key==='m'||e.key==='M') { if(onDrill) logDrill('miss'); }
  if(e.key===' ') {
    e.preventDefault();
    if (onDrill) toggleDrillVoice();
    else toggleVoice();
  }
});

// Expose render functions for post-load refresh
window.renderStats = renderStats;
window.toast = toast;

// init
updateMeta();
updateAttemptDots();
</script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-analytics.js";
  import {
    getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, getDoc
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    signInWithEmailAndPassword,
    signOut,
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCXwpk8nmBXXxHbXRINEEIqFt-18emUxjQ",
    authDomain: "bullboard-68766.firebaseapp.com",
    projectId: "bullboard-68766",
    storageBucket: "bullboard-68766.firebasestorage.app",
    messagingSenderId: "1024059787503",
    appId: "1:1024059787503:web:04ac0d4edb06dd430af31a",
    measurementId: "G-Z04BZD17CW"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // ── DOM refs ──
  const emailInput         = document.getElementById('emailInput');
  const passwordInput      = document.getElementById('passwordInput');
  const signUpButton       = document.getElementById('signUpButton');
  const signInButton       = document.getElementById('signInButton');
  const signOutButton      = document.getElementById('signOutButton');
  const googleSignInButton = document.getElementById('googleSignInButton');
  const userStatus         = document.getElementById('userStatus');

  // ── Auth: Google Sign-In ──
  const googleProvider = new GoogleAuthProvider();
  googleSignInButton.addEventListener('click', async () => {
    try {
      await signInWithPopup(auth, googleProvider);
    } catch (e) {
      if (e.code !== 'auth/popup-closed-by-user' && e.code !== 'auth/cancelled-popup-request') {
        alert('Google sign-in error: ' + e.message);
      }
    }
  });

  // ── Auth: Sign Up ──
  signUpButton.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) { alert('Enter email and password'); return; }
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      emailInput.value = ''; passwordInput.value = '';
    } catch (e) { alert('Sign up error: ' + e.message); }
  });

  // ── Auth: Sign In ──
  signInButton.addEventListener('click', async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value;
    if (!email || !password) { alert('Enter email and password'); return; }
    try {
      await signInWithEmailAndPassword(auth, email, password);
      emailInput.value = ''; passwordInput.value = '';
    } catch (e) { alert('Sign in error: ' + e.message); }
  });

  // ── Auth: Sign Out ──
  signOutButton.addEventListener('click', async () => {
    try { await signOut(auth); } catch (e) { alert('Sign out error: ' + e.message); }
  });

  // ── Load user profile (handle, photo) — fast single-doc fetch ──
  async function loadUserProfile(uid) {
    try {
      const snap = await getDoc(doc(db, 'users', uid));
      if (snap.exists()) {
        const data = snap.data();
        let changed = false;
        if (data.handle && data.handle !== window.socialState.myHandle) {
          window.socialState.myHandle = data.handle;
          changed = true;
        }
        if (data.photoURL && data.photoURL !== window.socialState.photoURL) {
          window.socialState.photoURL = data.photoURL;
          changed = true;
        }
        if (data.autoPost) {
          window.socialState.autoPost = { ...window.socialState.autoPost, ...data.autoPost };
          changed = true;
        }
        if (data.following && Array.isArray(data.following)) {
          // Merge following lists
          const merged = [...new Set([...window.socialState.following, ...data.following])];
          if (merged.length !== window.socialState.following.length) {
            window.socialState.following = merged;
            changed = true;
          }
        }
        if (changed) {
          window.saveSocialState();
          // Only update profile display fields — don't re-render feed/leaderboard
          if (typeof window.restoreSocialSettingsUI === 'function') window.restoreSocialSettingsUI();
          // If on the home page, also update the stats row
          const homePage = document.getElementById('page-home');
          if (homePage && homePage.classList.contains('active') && window._currentUser) {
            const sessions = window.state ? window.state.sessions : [];
            const avg = sessions.length ? (sessions.reduce((s,ses)=>s+parseFloat(ses.avg||0),0)/sessions.length).toFixed(1) : '—';
            const avgEl = document.getElementById('social-p-avg');
            const sessEl = document.getElementById('social-p-sessions');
            const followEl = document.getElementById('social-p-following');
            if (avgEl) avgEl.textContent = avg;
            if (sessEl) sessEl.textContent = sessions.length;
            if (followEl) followEl.textContent = window.socialState.following.length;
          }
        }
      }
      // If no profile exists yet (new user), trigger onboarding
      if (!window.socialState.myHandle) {
        setTimeout(() => {
          if (typeof window.openOnboardModal === 'function') window.openOnboardModal();
        }, 400);
      }
    } catch (e) {
      console.warn('Profile load error:', e.message);
      // Still show onboarding if no handle
      if (!window.socialState.myHandle) {
        setTimeout(() => {
          if (typeof window.openOnboardModal === 'function') window.openOnboardModal();
        }, 400);
      }
    }
  }

  // ── Save user profile to Firestore ──
  window.saveUserProfileToFirebase = async (profile) => {
    const user = auth.currentUser;
    if (!user) return;
    try {
      await setDoc(doc(db, 'users', user.uid), {
        uid: user.uid,
        email: user.email,
        handle: profile.handle || window.socialState.myHandle || '',
        photoURL: profile.photoURL || window.socialState.photoURL || '',
        autoPost: window.socialState.autoPost,
        following: window.socialState.following,
        updatedAt: new Date().toISOString(),
      }, { merge: true });
      console.log('Profile saved to Firestore');
    } catch (e) {
      console.warn('Profile save error:', e.message);
    }
  };

  // ── Load sessions + drills in parallel (background, non-blocking) ──
  async function loadUserData(uid) {
    try {
      const [sessSnap, drillSnap] = await Promise.all([
        getDocs(query(collection(db, 'sessions'), where('userId', '==', uid))),
        getDocs(query(collection(db, 'drillData'), where('userId', '==', uid))),
      ]);

      // Merge sessions
      const cloudSessions = [];
      sessSnap.forEach(d => cloudSessions.push(d.data()));
      if (cloudSessions.length > 0) {
        const localTs = new Set(window.state.sessions.map(s => s.timestamp));
        cloudSessions.forEach(s => { if (!localTs.has(s.timestamp)) window.state.sessions.push(s); });
        window.state.sessions.sort((a,b) => a.timestamp - b.timestamp);
        window.saveState();
      }

      // Merge drill data
      if (!drillSnap.empty) {
        const cloudDrill = drillSnap.docs[0].data().drillData;
        if (cloudDrill) {
          ['single','double','treble'].forEach(bed => {
            if (!cloudDrill[bed]) return;
            Object.entries(cloudDrill[bed]).forEach(([target, cd]) => {
              const ld = window.state.drillData[bed][target];
              if (!ld || cd.attempts > ld.attempts) {
                window.state.drillData[bed][target] = cd;
              }
            });
          });
          window.saveState();
        }
      }

      // Refresh UI once both are done (background load complete)
      if (typeof window.renderStats === 'function') window.renderStats();
      if (typeof window.renderHistoryPage === 'function' && document.getElementById('page-history')?.classList.contains('active')) {
        window.renderHistoryPage();
      }
      // If on Home page, refresh feed/leaderboard stats now that data is loaded
      const homePage = document.getElementById('page-home');
      if (homePage && homePage.classList.contains('active') && typeof window.renderSocialPage === 'function') {
        window.renderSocialPage();
      }
    } catch (e) {
      console.error('Error loading user data:', e.message);
    }
  }

  // ── Save a practice session to Firestore ──
  window.saveSessionToFirebase = async (sessionData) => {
    const user = auth.currentUser;
    if (!user) return;
    try {
      await addDoc(collection(db, 'sessions'), {
        userId: user.uid,
        ...sessionData,
        savedAt: new Date().toISOString()
      });
      console.log('Session saved to cloud');
    } catch (e) {
      console.error('Session save error:', e.code, e.message);
      if (e.code === 'permission-denied') {
        if (typeof window.toast === 'function') window.toast('Session saved locally. Cloud sync blocked — check Firestore rules.', true);
      }
      // Silent fail for network issues — local save already succeeded
    }
  };

  // ── Save drill session log + updated totals to Firestore ──
  window.saveDrillSessionToFirebase = async (drillLog, drillTotals) => {
    const user = auth.currentUser;
    if (!user) {
      document.getElementById('drill-save-status').textContent = '⚠ Sign in to save to cloud';
      return;
    }
    const statusEl = document.getElementById('drill-save-status');
    statusEl.style.color = 'var(--muted)';
    statusEl.textContent = 'Saving…';
    try {
      // Build summary inline (no IIFE to keep stack traces clean)
      const groups = {};
      drillLog.forEach(e => {
        const key = `${e.bed}:${e.target}`;
        if (!groups[key]) groups[key] = { bed: e.bed, target: e.target, hits: 0, total: 0 };
        groups[key].total++;
        if (e.result === 'hit') groups[key].hits++;
      });
      const summary = Object.values(groups);

      // Save the raw session log
      await addDoc(collection(db, 'drillSessions'), {
        userId: user.uid,
        timestamp: Date.now(),
        savedAt: new Date().toISOString(),
        throwCount: drillLog.length,
        throws: drillLog,
        summary
      });

      // Upsert the all-time drill totals document (one doc per user)
      const drillDocId = `drill_${user.uid}`;
      await setDoc(doc(db, 'drillData', drillDocId), {
        userId: user.uid,
        drillData: drillTotals,
        updatedAt: new Date().toISOString()
      }, { merge: true });

      statusEl.style.color = 'var(--accent3)';
      statusEl.textContent = '✓ Saved to cloud';
      if (typeof window.toast === 'function') window.toast('✓ Drill session saved to cloud!');
      setTimeout(() => { statusEl.textContent = ''; }, 4000);
    } catch (e) {
      console.error('Drill save error:', e.code, e.message);
      statusEl.style.color = 'var(--accent2)';
      // Show specific reason rather than generic message
      if (e.code === 'permission-denied') {
        statusEl.textContent = '✗ Permission denied — check Firestore rules';
        if (typeof window.toast === 'function') window.toast('Save failed: Firestore rules block writes. Open Firebase Console → Firestore → Rules and allow authenticated writes.', true);
      } else if (e.code === 'unavailable' || e.message?.includes('network')) {
        statusEl.textContent = '✗ Offline — data saved locally';
        if (typeof window.toast === 'function') window.toast('No connection — drill saved locally only', true);
      } else {
        statusEl.textContent = `✗ ${e.code || 'Save failed'}`;
        if (typeof window.toast === 'function') window.toast(`Save error: ${e.message}`, true);
      }
    }
  };

  // ── Auth state observer ──
  onAuthStateChanged(auth, (user) => {
    window._currentUser = user || null;
    if (user) {
      // Show sign-out, hide sign-in UI
      userStatus.textContent = (user.displayName ? user.displayName + ' · ' : '') + user.email;
      signOutButton.style.display = 'inline-block';
      emailInput.style.display = 'none';
      passwordInput.style.display = 'none';
      signUpButton.style.display = 'none';
      signInButton.style.display = 'none';
      googleSignInButton.style.display = 'none';

      // Open social content gate immediately (uses locally cached handle)
      if (typeof updateSocialGate === 'function') updateSocialGate(true, user.email);

      // 1. Load profile doc first — fast, single doc, shows handle/photo immediately
      loadUserProfile(user.uid);

      // 2. Load sessions + drills in background (parallel, non-blocking)
      loadUserData(user.uid);
    } else {
      userStatus.textContent = 'Not signed in';
      signOutButton.style.display = 'none';
      emailInput.style.display = 'inline-block';
      passwordInput.style.display = 'inline-block';
      signUpButton.style.display = 'inline-block';
      signInButton.style.display = 'inline-block';
      googleSignInButton.style.display = 'inline-flex';
      if (typeof updateSocialGate === 'function') updateSocialGate(false, null);
    }
  });
</script>


<!-- ═══════════════════════ EDIT THROW MODAL ═══════════════════════ -->
<div id="edit-throw-modal" class="edit-confirm-overlay" style="display:none">
  <div class="edit-confirm-box">
    <div class="edit-confirm-title">Edit Score</div>
    <div class="edit-confirm-sub" id="edit-throw-sub">Round 1 · was <strong id="edit-throw-was">0</strong>. Enter the correct score (0–180):</div>
    <input class="edit-confirm-input" id="edit-throw-input" type="number" min="0" max="180"
      onkeydown="if(event.key==='Enter')confirmEditThrow(); if(event.key==='Escape')closeEditThrow();" />
    <div class="edit-confirm-row">
      <button class="edit-confirm-btn cancel" onclick="closeEditThrow()">CANCEL</button>
      <button class="edit-confirm-btn confirm" onclick="confirmEditThrow()">CONFIRM</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════ HANDLE ONBOARDING MODAL ═══════════════════════ -->
<div id="onboard-modal" class="onboard-overlay" style="display:none">
  <div class="onboard-box">
    <div class="onboard-title">Welcome to Bullboard</div>
    <div class="onboard-sub">Choose a handle — this is how other players will see you.<br>You can change it anytime from your profile.</div>
    <input class="onboard-input" id="onboard-handle-input" type="text" maxlength="24"
      placeholder="YourHandle"
      onkeydown="if(event.key==='Enter')confirmOnboardHandle()" />
    <button class="onboard-btn" onclick="confirmOnboardHandle()">LET'S GO →</button>
  </div>
</div>
</body>
</html>
